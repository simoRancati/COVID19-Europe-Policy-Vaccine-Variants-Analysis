---
title: "Oxford_preprocessing"
author: "Simone_Rancati"
date: "2024-05-18"
output: html_document
---
# READ ALL FILE 
```{r setup, include=FALSE}
# Load the necessary library
library(tidyverse)

# Set the path to the directory containing the CSV files
path_to_csv_files <- "/Users/utente/Desktop/Periscope/OXFORD_INDEX"

# List all CSV files in the directory
csv_files <- list.files(path = path_to_csv_files, pattern = "\\.csv$", full.names = TRUE)

# Read each file and create a variable for each file
lapply(csv_files, function(file_path) {
  # Read the CSV file
  data_frame <- read_csv(file_path)
  
  # Create a variable name based on the file name
  var_name <- paste0("data_oxford_", make.names(gsub("^.*/|\\.csv$", "", file_path)))
  
  # Assign the data frame to the variable in the global environment
  assign(var_name, data_frame, envir = .GlobalEnv)
})

## EPIDEMIOLOGICAL DATA
# data hospital
data_hospital <- read_delim("/Users/utente/Desktop/Periscope/Hospital_EU.csv",delim = ",")
# data death 
data_death <- read_delim("/Users/utente/Desktop/Periscope/Deaths.csv", delim = ",")
# data vaccine 
data_vaccine <- read_delim("/Users/utente/Desktop/Periscope/Vaccine_EU.csv",delim = ",")
# data variants 
data_variant <- read_delim("/Users/utente/Desktop/Varcovid/DeepAutoCov/raw_data/metadata_tsv_2023_11_06/metadata.csv",delim = ",")

data_variant$Variant <- sapply(str_split(data_variant$Variant, " "), function(x) if(length(x) >= 3) x[3] else NA)

data_variant$Location <- sapply(str_split(data_variant$Location, "/"), function(x) if(length(x) >= 2) x[2] else NA)

data_variant <- data_variant %>% rename('Collection_Date' = 'Collection date')
data_variant <- data_variant[nchar(as.character(data_variant$Collection_Date)) == 10, ]

data_variant$Collection_Date <- as.Date(data_variant$Collection_Date, format = "%Y-%m-%d")
data_variant <- data_variant %>%mutate(Location = str_trim(Location))
```

# STRINGENCY INDEX AND HEALTH INDEX 
```{r setup, include=FALSE}
Governement_stringecy_index_oxford <-  data_oxford_owid.covid.data %>%
  select(location, date, stringency_index)

Containement_health_index_oxford <- data_oxford_covid.containment.and.health.index  %>%
  select(Entity, Day, containment_index)

```

# SPAIN

```{r setup, include=FALSE}
selected_countries_spain <- c("Spain")

## LOAD DATA 
# HOSPITAL
data_hospital_filtered_spain <- data_hospital %>% 
  filter(country %in% selected_countries_spain)
data_hospital_filtered_spain$date <- parse_date_time(data_hospital_filtered_spain$date, orders = c("ymd", "ymd"))

## DEATH
data_death_filtered_spain <- data_death %>% 
  filter(country %in% selected_countries_spain)

# Obtain the population of nation 
population_spain <- unique(data_death_filtered_spain$population)

# Data Vaccine 

# Filter with Nation of Interest 
# country_code_mapping <- c(Spain = "ES", France = "FR", Netherlands = "NL", Latvia = "LV",Slovenia = "SI", Greece = "GR", Ireland = "IE", Cyprus = "CY", Estonia = "EE")

# Filter with Nation of Interest 
selected_countries_spain_iso <- c("ES")
data_vaccine_filtered_spain <- data_vaccine %>% filter(ReportingCountry %in% selected_countries_spain_iso)

# Filter health_index_oxford
Containement_health_index_oxford_spain <- Containement_health_index_oxford %>% 
  filter(Entity %in% selected_countries_spain)
Containement_health_index_oxford_spain$Day <- parse_date_time(Containement_health_index_oxford_spain$Day, orders = c("ymd", "ymd"))

# Filter Gouvernement Index
Governement_stringecy_index_oxford_spain <- Governement_stringecy_index_oxford %>% 
  filter(location %in% selected_countries_spain)
Governement_stringecy_index_oxford_spain$date <- parse_date_time(Governement_stringecy_index_oxford_spain$date, orders = c("ymd", "ymd"))
```

# 2020
```{r setup, include=FALSE}
library(tidyverse)
## 2020
# STRINGENCY INDEX
date_start_2020 <- ymd("2020-01-05")
date_end_2020 <- ymd("2021-01-03")
# Define the date of start 
start_date_2020 <- as.Date("2020-01-05") 

Governement_stringecy_index_oxford_spain_2020 <- Governement_stringecy_index_oxford_spain %>% 
  filter(date >= date_start_2020 & date <= date_end_2020)

Governement_stringecy_index_oxford_spain_2020$date <- as.Date(Governement_stringecy_index_oxford_spain_2020$date)

Governement_stringecy_index_oxford_spain_2020 <- Governement_stringecy_index_oxford_spain_2020 %>%
  mutate(days_since_start = as.numeric(date - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_spain_2020 <- Containement_health_index_oxford_spain %>% 
  filter(Day >= date_start_2020 & Day <= date_end_2020)

Containement_health_index_oxford_spain_2020$Day <- as.Date(Containement_health_index_oxford_spain_2020$Day)

Containement_health_index_oxford_spain_2020 <- Containement_health_index_oxford_spain_2020 %>%
  mutate(days_since_start = as.numeric(Day - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )


#HOSPITAL
data_hospital_filtered_spain_2020 <- data_hospital_filtered_spain %>% 
  filter(date >= date_start_2020 & date <= date_end_2020)

## Grouping the file 
data_hospital_filtered_spain_2020$date <- as.Date(data_hospital_filtered_spain_2020$date)

# Group by  
data_grouped_hospital_spain_2020 <- data_hospital_filtered_spain_2020 %>%
  mutate(days_since_start = as.numeric(date - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Spain_2020 <- data_grouped_hospital_spain_2020 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information) %>%
  arrange(week_number)

# Create a dataframe with all week numbers from 1 to 53
all_weeks <- tibble(week_number = 1:53)

db_hospital_Spain_2020 <- all_weeks %>%
  left_join(db_hospital_Spain_2020, by = "week_number") %>%
  select(-country)

# DEATH
data_death_filtered_spain_2020 <- data_death_filtered_spain %>%
  filter(substr(year_week, 1, 4) == "2020")
# Data frame Cases and deaths 
db_death_Spain_2020 <- data_death_filtered_spain_2020 %>%
  select(-country, -country_code, -continent,-population,-rate_14_day, -cumulative_count ,-source,-note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Spain_2020 <- select(db_death_Spain_2020, -year_week)

db_Spain_2020 <- cbind(db_hospital_Spain_2020, db_death_Spain_2020)

# VACCINE 

# Filter data for the year 2020 and for not creating so much covariates i decide to mantain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_spain_2020 <- data_vaccine_filtered_spain %>%
  filter(substr(YearWeekISO, 1, 4) == "2020" & TargetGroup == "ALL")
# count Nan
missing_counts_spain_2020 <- data_vaccine_filtered_spain_2020 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_spain_2020 <- data_vaccine_filtered_spain_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

db_vaccine_Spain_2020 <- select(data_vaccine_filtered_spain_2020, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3,YearWeekISO)

db_vaccine_Spain_2020 <- db_vaccine_Spain_2020 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Spain_2020 <- db_vaccine_Spain_2020 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
all_weeks <- data.frame(YearWeekISO = sprintf("2020-W%02d", 1:53))
# Unisci i dati riassunti con il dataframe di tutte le settimane
db_vaccine_Spain_2020 <- left_join(all_weeks, db_vaccine_Spain_2020, by = "YearWeekISO") %>%
  replace_na(list(FirstDose = 0, SecondDose = 0, Booster = 0))

# VARIANT 
data_variant_filter_Spain_2020 <- data_variant %>%
  filter(Location == "Spain", !is.na(Variant) & Variant != "", Collection_Date >= as.Date("2020-01-05") & Collection_Date <= as.Date("2021-01-03")) 
data_variant_filter_Spain_2020 <-select(data_variant_filter_Spain_2020,Collection_Date,Variant)
start_date_2020 <- as.Date("2020-01-05")  

# Group by  
data_grouped_variant_spain_2020 <- data_variant_filter_Spain_2020 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date_2020),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_spain_2020 <-  select(data_grouped_variant_spain_2020,-count)
  
data_Variant_Spain_2020 <- data_grouped_variant_spain_2020 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:53)
data_Variant_Spain_2020 <- data_Variant_Spain_2020 %>%distinct()
data_Variant_Spain_2020$week_number <- as.integer(data_Variant_Spain_2020$week_number)
data_Variant_Spain_2020 <- left_join(all_weeks, data_Variant_Spain_2020, by = "week_number")

# Stamdardize the data 
db_Spain_2020 <- db_Spain_2020 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
db_Spain_2020 <- db_Spain_2020 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

db_Spain_2020$Daily_ICU_occupancy <- (db_Spain_2020$Daily_ICU_occupancy / population_spain)*100000
db_Spain_2020$Daily_hospital_occupancy <- (db_Spain_2020$Daily_hospital_occupancy / population_spain)*100000
db_Spain_2020$cases <- (db_Spain_2020$cases / population_spain)*100000
db_Spain_2020$deaths <- (db_Spain_2020$deaths / population_spain)*100000

db_vaccine_Spain_2020$FirstDose <- (db_vaccine_Spain_2020$FirstDose / population_spain)*100000
db_vaccine_Spain_2020$SecondDose <- (db_vaccine_Spain_2020$SecondDose / population_spain)*100000
db_vaccine_Spain_2020$Booster <- (db_vaccine_Spain_2020$Booster / population_spain)*100000

# variant processimg data 
max_expected_week_2020 <- max(data_Variant_Spain_2020$week_number)
missing_weeks_2020 <- setdiff(1:max_expected_week_2020, data_Variant_Spain_2020$week_number)

if (length(missing_weeks_2020) > 0) {
  if (identical(missing_weeks_2020, 1:length(missing_weeks_2020))) {
    for (week in missing_weeks_2020) {
      data_Variant_Spain_2020[data_Variant_Spain_2020$week_number == week, ] <- data_Variant_Spain_2020[data_Variant_Spain_2020$week_number == max(data_Variant_Spain_2020$week_number[data_Variant_Spain_2020$week_number < week]), ]
    }
  } else {
    existing_weeks <- intersect(1:max_expected_week_2020, data_Variant_Spain_2020$week_number)
    missing_between <- setdiff(existing_weeks + 1, data_Variant_Spain_2020$week_number)
    for (week in missing_between) {
      before <- data_Variant_Spain_2020[data_Variant_Spain_2020$week_number == max(data_Variant_Spain_2020$week_number[data_Variant_Spain_2020$week_number < week]), ]
      after <- data_Variant_Spain_2020[data_Variant_Spain_2020$week_number == min(data_Variant_Spain_2020$week_number[data_Variant_Spain_2020$week_number > week]), ]
      data_Variant_Spain_2020 <- rbind(data_Variant_Spain_2020, colMeans(rbind(before, after)))
    }
  }
}


```

# 2021
```{r setup, include=FALSE}
##2021

# STRINGENCY INDEX
date_start <- ymd("2021-01-04")
date_end <- ymd("2022-01-02")
# Define the date of start 
start_date <- as.Date("2021-01-04")  

Governement_stringecy_index_oxford_spain_2021 <- Governement_stringecy_index_oxford_spain %>% 
  filter(date >= date_start & date <= date_end)

Governement_stringecy_index_oxford_spain_2021$date <- as.Date(Governement_stringecy_index_oxford_spain_2021$date)

Governement_stringecy_index_oxford_spain_2021 <- Governement_stringecy_index_oxford_spain_2021 %>%
  mutate(days_since_start = as.numeric(date - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_spain_2021 <- Containement_health_index_oxford_spain %>% 
  filter(Day >= date_start & Day <= date_end)

Containement_health_index_oxford_spain_2021$Day <- as.Date(Containement_health_index_oxford_spain_2021$Day)

Containement_health_index_oxford_spain_2021 <- Containement_health_index_oxford_spain_2021 %>%
  mutate(days_since_start = as.numeric(Day - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# Management of different date formats and date range filtering
data_hospital_filtered_spain_2021 <- data_hospital_filtered_spain %>% 
  filter(date >= date_start & date <= date_end)

## Grouping the file 

# Define the date of start 
data_hospital_filtered_spain_2021$date <- as.Date(data_hospital_filtered_spain_2021$date)

# Group by  
data_grouped_hospital_spain_2021 <- data_hospital_filtered_spain_2021 %>%
  mutate(days_since_start = as.numeric(date - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Spain_2021 <- data_grouped_hospital_spain_2021 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information)

db_hospital_Spain_2021 <- select(db_hospital_Spain_2021, -country, -week_number)

# Data Death
# Filter with Nation of Interest 
data_death_filtered_spain_2021 <- data_death %>% 
  filter(country %in% selected_countries_spain)

# Filter data for the year 2021
data_death_filtered_spain_2021 <- data_death_filtered_spain_2021 %>%
  filter(substr(year_week, 1, 4) == "2021")

# Data frame Cases and deaths 
db_death_Spain_2021 <- data_death_filtered_spain_2021 %>%
  select(-country, -country_code, -continent,-population,-rate_14_day, -cumulative_count ,-source,-note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Spain_2021 <- select(db_death_Spain_2021, -year_week)

db_Spain_2021 <- cbind(db_hospital_Spain_2021, db_death_Spain_2021)

# Data Vaccine 

# Filter with Nation of Interest 
# country_code_mapping <- c(Spain = "ES", France = "FR", Netherlands = "NL", Latvia = "LV",Slovenia = "SI", Greece = "GR", Ireland = "IE", Cyprus = "CY", Estonia = "EE")

# Filter data for the year 2021 and for not creating so much covariates i decide to mantain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_spain_2021 <- data_vaccine_filtered_spain %>%
  filter(substr(YearWeekISO, 1, 4) == "2021" & TargetGroup == "ALL")
# count Nan
missing_counts_spain_2021 <- data_vaccine_filtered_spain_2021 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_spain_2021 <- data_vaccine_filtered_spain_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

# Select the column 
db_vaccine_Spain_2021 <- select(data_vaccine_filtered_spain_2021, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3,YearWeekISO)

db_vaccine_Spain_2021 <- db_vaccine_Spain_2021 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Spain_2021 <- db_vaccine_Spain_2021 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
# Data Variant
data_variant_filter_Spain_2021 <- data_variant %>%
  filter(Location == "Spain", 
         !is.na(Variant) & Variant != "", 
         Collection_Date >= as.Date("2021-01-04") & Collection_Date <= as.Date("2022-01-02")) 
data_variant_filter_Spain_2021 <- select(data_variant_filter_Spain_2021,Collection_Date,Variant)
start_date <- as.Date("2021-01-04")  

# Group by  
data_grouped_variant_spain_2021 <- data_variant_filter_Spain_2021 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_spain_2021 <-  select(data_grouped_variant_spain_2021,-count)
  
data_Variant_Spain_2021 <- data_grouped_variant_spain_2021 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:52)
data_Variant_Spain_2021 <- data_Variant_Spain_2021 %>%distinct()
data_Variant_Spain_2021$week_number <- as.integer(data_Variant_Spain_2021$week_number)
data_Variant_Spain_2021 <- left_join(all_weeks, data_Variant_Spain_2021, by = "week_number")

# Stamdardize the data 
db_Spain_2021 <- db_Spain_2021 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
db_Spain_2021 <- db_Spain_2021 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

db_Spain_2021$Daily_ICU_occupancy <- (db_Spain_2021$Daily_ICU_occupancy / population_spain)*100000
db_Spain_2021$Daily_hospital_occupancy <- (db_Spain_2021$Daily_hospital_occupancy / population_spain)*100000
db_Spain_2021$cases <- (db_Spain_2021$cases / population_spain)*100000
db_Spain_2021$deaths <- (db_Spain_2021$deaths / population_spain)*100000

db_vaccine_Spain_2021$FirstDose <- (db_vaccine_Spain_2021$FirstDose / population_spain)*100000
db_vaccine_Spain_2021$SecondDose <- (db_vaccine_Spain_2021$SecondDose / population_spain)*100000
db_vaccine_Spain_2021$Booster <- (db_vaccine_Spain_2021$Booster / population_spain)*100000

# variant processimg data 
max_expected_week_2021 <- max(data_Variant_Spain_2021$week_number)
missing_weeks_2021 <- setdiff(1:max_expected_week_2021, data_Variant_Spain_2021$week_number)

if (length(missing_weeks_2021) > 0) {
  if (identical(missing_weeks_2021, 1:length(missing_weeks_2021))) {
    for (week in missing_weeks_2021) {
      data_Variant_Spain_2021[data_Variant_Spain_2021$week_number == week, ] <- data_Variant_Spain_2021[data_Variant_Spain_2021$week_number == max(data_Variant_Spain_2021$week_number[data_Variant_Spain_2021$week_number < week]), ]
    }
  } else {
    existing_weeks_2021 <- intersect(1:max_expected_week_2021, data_Variant_Spain_2021$week_number)
    missing_between_2021 <- setdiff(existing_weeks_2021 + 1, data_Variant_Spain_2021$week_number)
    for (week in missing_between_2021) {
      before <- data_Variant_Spain_2021[data_Variant_Spain_2021$week_number == max(data_Variant_Spain_2021$week_number[data_Variant_Spain_2021$week_number < week]), ]
      after <- data_Variant_Spain_2021[data_Variant_Spain_2021$week_number == min(data_Variant_Spain_2021$week_number[data_Variant_Spain_2021$week_number > week]), ]
      data_Variant_Spain_2021 <- rbind(data_Variant_Spain_2021, colMeans(rbind(before, after)))
    }
  }
}

```

# 2022
```{r setup, include=FALSE}
##2022
date_start <- ymd("2022-01-03")
date_end <- ymd("2023-01-01")
start_date <- as.Date("2022-01-03") 

Governement_stringecy_index_oxford_spain_2022 <- Governement_stringecy_index_oxford_spain %>% 
  filter(date >= date_start & date <= date_end)

Governement_stringecy_index_oxford_spain_2022$date <- as.Date(Governement_stringecy_index_oxford_spain_2022$date)

Governement_stringecy_index_oxford_spain_2022 <- Governement_stringecy_index_oxford_spain_2022 %>%
  mutate(days_since_start = as.numeric(date - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_spain_2022 <- Containement_health_index_oxford_spain %>% 
  filter(Day >= date_start & Day <= date_end)

Containement_health_index_oxford_spain_2022$Day <- as.Date(Containement_health_index_oxford_spain_2022$Day)

Containement_health_index_oxford_spain_2022 <- Containement_health_index_oxford_spain_2022 %>%
  mutate(days_since_start = as.numeric(Day - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# Management of different date formats and date range filtering
data_hospital_filtered_spain_2022 <- data_hospital_filtered_spain %>% 
  filter(date >= date_start & date <= date_end)

## Grouping the file 

# Define the date of start 
data_hospital_filtered_spain_2022$date <- as.Date(data_hospital_filtered_spain_2022$date)

# Group by  
data_grouped_hospital_spain_2022 <- data_hospital_filtered_spain_2022 %>%
  mutate(days_since_start = as.numeric(date - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Spain_2022 <- data_grouped_hospital_spain_2022 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information)

db_hospital_Spain_2022 <- select(db_hospital_Spain_2022, -country, -week_number)

# Data Death
# Filter with Nation of Interest 
data_death_filtered_spain_2022 <- data_death %>% 
  filter(country %in% selected_countries_spain)

# Filter data for the year 2021
data_death_filtered_spain_2022 <- data_death_filtered_spain_2022 %>%
  filter(substr(year_week, 1, 4) == "2022")

# Data frame Cases and deaths 
db_death_Spain_2022 <- data_death_filtered_spain_2022 %>%
  select(-country, -country_code, -continent,-population,-rate_14_day, -cumulative_count ,-source,-note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Spain_2022 <- select(db_death_Spain_2022, -year_week)

db_Spain_2022 <- cbind(db_hospital_Spain_2022, db_death_Spain_2022)

# Data Vaccine 

# Filter with Nation of Interest 
# country_code_mapping <- c(Spain = "ES", France = "FR", Netherlands = "NL", Latvia = "LV",Slovenia = "SI", Greece = "GR", Ireland = "IE", Cyprus = "CY", Estonia = "EE")

# Filter data for the year 2022 and for not creating so much covariates i decide to mantain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_spain_2022 <- data_vaccine_filtered_spain %>%
  filter(substr(YearWeekISO, 1, 4) == "2022" & TargetGroup == "ALL")
# count Nan
missing_counts_spain_2022 <- data_vaccine_filtered_spain_2022 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_spain_2022 <- data_vaccine_filtered_spain_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

# Select the column 
db_vaccine_Spain_2022 <- select(data_vaccine_filtered_spain_2022, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3,YearWeekISO)

db_vaccine_Spain_2022 <- db_vaccine_Spain_2022 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Spain_2022 <- db_vaccine_Spain_2022 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
# Data Variant
data_variant_filter_Spain_2022 <- data_variant %>%
  filter(Location == "Spain", 
         !is.na(Variant) & Variant != "", 
         Collection_Date >= as.Date("2022-01-03") & Collection_Date <= as.Date("2023-01-01")) 
data_variant_filter_Spain_2022 <- select(data_variant_filter_Spain_2022,Collection_Date,Variant)
start_date <- as.Date("2022-01-03")  

# Group by  
data_grouped_variant_spain_2022 <- data_variant_filter_Spain_2022 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_spain_2022 <-  select(data_grouped_variant_spain_2022,-count)
  
data_Variant_Spain_2022 <- data_grouped_variant_spain_2022 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:52)
data_Variant_Spain_2022 <- data_Variant_Spain_2022 %>%distinct()
data_Variant_Spain_2022$week_number <- as.integer(data_Variant_Spain_2022$week_number)
data_Variant_Spain_2022 <- left_join(all_weeks, data_Variant_Spain_2022, by = "week_number")

# Stamdardize the data 
db_Spain_2022 <- db_Spain_2022 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
db_Spain_2022 <- db_Spain_2022 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

db_Spain_2022$Daily_ICU_occupancy <- (db_Spain_2022$Daily_ICU_occupancy / population_spain)*100000
db_Spain_2022$Daily_hospital_occupancy <- (db_Spain_2022$Daily_hospital_occupancy / population_spain)*100000
db_Spain_2022$cases <- (db_Spain_2022$cases / population_spain)*100000
db_Spain_2022$deaths <- (db_Spain_2022$deaths / population_spain)*100000

db_vaccine_Spain_2022$FirstDose <- (db_vaccine_Spain_2022$FirstDose / population_spain)*100000
db_vaccine_Spain_2022$SecondDose <- (db_vaccine_Spain_2022$SecondDose / population_spain)*100000
db_vaccine_Spain_2022$Booster <- (db_vaccine_Spain_2022$Booster / population_spain)*100000

# variant processimg data 
max_expected_week_2022 <- max(data_Variant_Spain_2022$week_number)
missing_weeks_2022 <- setdiff(1:max_expected_week_2022, data_Variant_Spain_2022$week_number)

if (length(missing_weeks_2022) > 0) {
  if (identical(missing_weeks_2022, 1:length(missing_weeks_2022))) {
    for (week in missing_weeks_2022) {
      data_Variant_Spain_2022[data_Variant_Spain_2022$week_number == week, ] <- data_Variant_Spain_2022[data_Variant_Spain_2022$week_number == max(data_Variant_Spain_2022$week_number[data_Variant_Spain_2022$week_number < week]), ]
    }
  } else {
    existing_weeks_2022 <- intersect(1:max_expected_week_2022, data_Variant_Spain_2022$week_number)
    missing_between_2022 <- setdiff(existing_weeks_2022 + 1, data_Variant_Spain_2022$week_number)
    for (week in missing_between_2022) {
      before <- data_Variant_Spain_2022[data_Variant_Spain_2022$week_number == max(data_Variant_Spain_2022$week_number[data_Variant_Spain_2022$week_number < week]), ]
      after <- data_Variant_Spain_2022[data_Variant_Spain_2022$week_number == min(data_Variant_Spain_2022$week_number[data_Variant_Spain_2022$week_number > week]), ]
      data_Variant_Spain_2022 <- rbind(data_Variant_Spain_2022, colMeans(rbind(before, after)))
    }
  }
}
```

# FRANCE

```{r setup, include=FALSE}
selected_countries_france <- c("France")

## LOAD DATA 
# HOSPITAL
data_hospital_filtered_france <- data_hospital %>% 
  filter(country %in% selected_countries_france)
data_hospital_filtered_france$date <- parse_date_time(data_hospital_filtered_france$date, orders = c("ymd", "ymd"))

## DEATH
data_death_filtered_france <- data_death %>% 
  filter(country %in% selected_countries_france)

# Obtain the population of nation 
population_france <- unique(data_death_filtered_france$population)

# Data Vaccine 

# Filter with Nation of Interest 
# country_code_mapping <- c(Spain = "ES", France = "FR", Netherlands = "NL", Latvia = "LV",Slovenia = "SI", Greece = "GR", Ireland = "IE", Cyprus = "CY", Estonia = "EE")

# Filter with Nation of Interest 
selected_countries_france_iso <- c("FR")
data_vaccine_filtered_france <- data_vaccine %>% filter(ReportingCountry %in% selected_countries_france_iso)

# Filter health_index_oxford
Containement_health_index_oxford_france <- Containement_health_index_oxford %>% 
  filter(Entity %in% selected_countries_france)
Containement_health_index_oxford_france$Day <- parse_date_time(Containement_health_index_oxford_france$Day, orders = c("ymd", "ymd"))

# Filter Gouvernement Index
Governement_stringecy_index_oxford_france <- Governement_stringecy_index_oxford %>% 
  filter(location %in% selected_countries_france)
Governement_stringecy_index_oxford_france$date <- parse_date_time(Governement_stringecy_index_oxford_france$date, orders = c("ymd", "ymd"))
```

# 2020

```{r setup, include=FALSE}
# STRINGENCY INDEX
date_start_2020 <- ymd("2020-01-05")
date_end_2020 <- ymd("2021-01-03")
# Define the date of start 
start_date_2020 <- as.Date("2020-01-05") 

Governement_stringecy_index_oxford_france_2020 <- Governement_stringecy_index_oxford_france %>% 
  filter(date >= date_start_2020 & date <= date_end_2020)

Governement_stringecy_index_oxford_france_2020$date <- as.Date(Governement_stringecy_index_oxford_france_2020$date)

Governement_stringecy_index_oxford_france_2020 <- Governement_stringecy_index_oxford_france_2020 %>%
  mutate(days_since_start = as.numeric(date - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_france_2020 <- Containement_health_index_oxford_france %>% 
  filter(Day >= date_start_2020 & Day <= date_end_2020)

Containement_health_index_oxford_france_2020$Day <- as.Date(Containement_health_index_oxford_france_2020$Day)

Containement_health_index_oxford_france_2020 <- Containement_health_index_oxford_france_2020 %>%
  mutate(days_since_start = as.numeric(Day - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )


#HOSPITAL
data_hospital_filtered_france_2020 <- data_hospital_filtered_france %>% 
  filter(date >= date_start_2020 & date <= date_end_2020)

## Grouping the file 
data_hospital_filtered_france_2020$date <- as.Date(data_hospital_filtered_france_2020$date)

# Group by  
data_grouped_hospital_france_2020 <- data_hospital_filtered_france_2020 %>%
  mutate(days_since_start = as.numeric(date - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_France_2020 <- data_grouped_hospital_france_2020 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information) %>%
  arrange(week_number)

# Create a dataframe with all week numbers from 1 to 53
all_weeks <- tibble(week_number = 1:53)

db_hospital_France_2020 <- all_weeks %>%
  left_join(db_hospital_France_2020, by = "week_number") %>%
  select(-country)

# DEATH
data_death_filtered_france_2020 <- data_death_filtered_france %>%
  filter(substr(year_week, 1, 4) == "2020")
# Data frame Cases and deaths 
db_death_France_2020 <- data_death_filtered_france_2020 %>%
  select(-country, -country_code, -continent,-population,-rate_14_day, -cumulative_count ,-source,-note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_France_2020 <- select(db_death_France_2020, -year_week)

db_France_2020 <- cbind(db_hospital_France_2020, db_death_France_2020)

# VACCINE 

# Filter data for the year 2020 and for not creating so much covariates i decide to mantain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_france_2020 <- data_vaccine_filtered_france %>%
  filter(substr(YearWeekISO, 1, 4) == "2020" & TargetGroup == "ALL")
# count Nan
missing_counts_france_2020 <- data_vaccine_filtered_france_2020 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_france_2020 <- data_vaccine_filtered_france_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

db_vaccine_France_2020 <- select(data_vaccine_filtered_france_2020, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3,YearWeekISO)

db_vaccine_France_2020 <- db_vaccine_France_2020 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_France_2020 <- db_vaccine_France_2020 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
all_weeks <- data.frame(YearWeekISO = sprintf("2020-W%02d", 1:53))
# Unisci i dati riassunti con il dataframe di tutte le settimane
db_vaccine_France_2020 <- left_join(all_weeks, db_vaccine_France_2020, by = "YearWeekISO") %>%
  replace_na(list(FirstDose = 0, SecondDose = 0, Booster = 0))

# VARIANT 
data_variant_filter_France_2020 <- data_variant %>%
  filter(Location == "France", !is.na(Variant) & Variant != "", Collection_Date >= as.Date("2020-01-05") & Collection_Date <= as.Date("2021-01-03")) 
data_variant_filter_France_2020 <-select(data_variant_filter_France_2020,Collection_Date,Variant)
start_date_2020 <- as.Date("2020-01-05")  

# Group by  
data_grouped_variant_france_2020 <- data_variant_filter_France_2020 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date_2020),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_france_2020 <-  select(data_grouped_variant_france_2020,-count)
  
data_Variant_France_2020 <- data_grouped_variant_france_2020 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:53)
data_Variant_France_2020 <- data_Variant_France_2020 %>%distinct()
data_Variant_France_2020$week_number <- as.integer(data_Variant_France_2020$week_number)
data_Variant_France_2020 <- left_join(all_weeks, data_Variant_France_2020, by = "week_number")

# Stamdardize the data 
db_France_2020 <- db_France_2020 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
db_France_2020 <- db_France_2020 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

db_France_2020$Daily_ICU_occupancy <- (db_France_2020$Daily_ICU_occupancy / population_france)*100000
db_France_2020$Daily_hospital_occupancy <- (db_France_2020$Daily_hospital_occupancy / population_france)*100000
db_France_2020$cases <- (db_France_2020$cases / population_france)*100000
db_France_2020$deaths <- (db_France_2020$deaths / population_france)*100000

db_vaccine_France_2020$FirstDose <- (db_vaccine_France_2020$FirstDose / population_france)*100000
db_vaccine_France_2020$SecondDose <- (db_vaccine_France_2020$SecondDose / population_france)*100000
db_vaccine_France_2020$Booster <- (db_vaccine_France_2020$Booster / population_france)*100000

# variant processimg data 
max_expected_week_2020 <- max(data_Variant_France_2020$week_number)
missing_weeks_2020 <- setdiff(1:max_expected_week_2020, data_Variant_France_2020$week_number)

if (length(missing_weeks_2020) > 0) {
  if (identical(missing_weeks_2020, 1:length(missing_weeks_2020))) {
    for (week in missing_weeks_2020) {
      data_Variant_France_2020[data_Variant_France_2020$week_number == week, ] <- data_Variant_France_2020[data_Variant_France_2020$week_number == max(data_Variant_France_2020$week_number[data_Variant_France_2020$week_number < week]), ]
    }
  } else {
    existing_weeks <- intersect(1:max_expected_week_2020, data_Variant_France_2020$week_number)
    missing_between <- setdiff(existing_weeks + 1, data_Variant_France_2020$week_number)
    for (week in missing_between) {
      before <- data_Variant_France_2020[data_Variant_France_2020$week_number == max(data_Variant_France_2020$week_number[data_Variant_France_2020$week_number < week]), ]
      after <- data_Variant_France_2020[data_Variant_France_2020$week_number == min(data_Variant_France_2020$week_number[data_Variant_France_2020$week_number > week]), ]
      data_Variant_France_2020 <- rbind(data_Variant_France_2020, colMeans(rbind(before, after)))
    }
  }
}
```

# 2021
```{r setup, include=FALSE}
## 2021
# STRINGENCY INDEX
date_start <- ymd("2021-01-04")
date_end <- ymd("2022-01-02")
# Define the date of start 
start_date <- as.Date("2021-01-04")  

Governement_stringecy_index_oxford_france_2021 <- Governement_stringecy_index_oxford_france %>% 
  filter(date >= date_start & date <= date_end)

Governement_stringecy_index_oxford_france_2021$date <- as.Date(Governement_stringecy_index_oxford_france_2021$date)

Governement_stringecy_index_oxford_france_2021 <- Governement_stringecy_index_oxford_france_2021 %>%
  mutate(days_since_start = as.numeric(date - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_france_2021 <- Containement_health_index_oxford_france %>% 
  filter(Day >= date_start & Day <= date_end)

Containement_health_index_oxford_france_2021$Day <- as.Date(Containement_health_index_oxford_france_2021$Day)

Containement_health_index_oxford_france_2021 <- Containement_health_index_oxford_france_2021 %>%
  mutate(days_since_start = as.numeric(Day - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# Management of different date formats and date range filtering
data_hospital_filtered_france_2021 <- data_hospital_filtered_france %>% 
  filter(date >= date_start & date <= date_end)

## Grouping the file 
data_hospital_filtered_france_2021$date <- as.Date(data_hospital_filtered_france_2021$date)

# Group by  
data_grouped_hospital_france_2021 <- data_hospital_filtered_france_2021 %>%
  mutate(days_since_start = as.numeric(date - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_France_2021 <- data_grouped_hospital_france_2021 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information)

db_hospital_France_2021 <- select(db_hospital_France_2021, -country, -week_number)

# Data Death
# Filter with Nation of Interest 
data_death_filtered_france_2021 <- data_death %>% 
  filter(country %in% selected_countries_france)

# Filter data for the year 2021
data_death_filtered_france_2021 <- data_death_filtered_france_2021 %>%
  filter(substr(year_week, 1, 4) == "2021")

# Data frame Cases and deaths 
db_death_France_2021 <- data_death_filtered_france_2021 %>%
  select(-country, -country_code, -continent,-population,-rate_14_day, -cumulative_count ,-source,-note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_France_2021 <- select(db_death_France_2021, -year_week)

db_France_2021 <- cbind(db_hospital_France_2021, db_death_France_2021)

# Data Vaccine 

# Filter data for the year 2021 and for not creating so much covariates i decide to mantain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_france_2021 <- data_vaccine_filtered_france %>%
  filter(substr(YearWeekISO, 1, 4) == "2021" & TargetGroup == "ALL")
# count Nan
missing_counts_france_2021 <- data_vaccine_filtered_france_2021 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_france_2021 <- data_vaccine_filtered_france_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

# Select the column 
db_vaccine_France_2021 <- select(data_vaccine_filtered_france_2021, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3,YearWeekISO)

db_vaccine_France_2021 <- db_vaccine_France_2021 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_France_2021 <- db_vaccine_France_2021 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
# Data Variant
data_variant_filter_France_2021 <- data_variant %>%
  filter(Location == "France", 
         !is.na(Variant) & Variant != "", 
         Collection_Date >= as.Date("2021-01-04") & Collection_Date <= as.Date("2022-01-02")) 
data_variant_filter_France_2021 <- select(data_variant_filter_France_2021,Collection_Date,Variant)
start_date <- as.Date("2021-01-04")  

# Group by  
data_grouped_variant_france_2021 <- data_variant_filter_France_2021 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_france_2021 <-  select(data_grouped_variant_france_2021,-count)
  
data_Variant_France_2021 <- data_grouped_variant_france_2021 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:52)
data_Variant_France_2021 <- data_Variant_France_2021 %>%distinct()
data_Variant_France_2021$week_number <- as.integer(data_Variant_France_2021$week_number)
data_Variant_France_2021 <- left_join(all_weeks, data_Variant_France_2021, by = "week_number")

# Standardize the data 
db_France_2021 <- db_France_2021 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
db_France_2021 <- db_France_2021 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

db_France_2021$Daily_ICU_occupancy <- (db_France_2021$Daily_ICU_occupancy / population_france)*100000
db_France_2021$Daily_hospital_occupancy <- (db_France_2021$Daily_hospital_occupancy / population_france)*100000
db_France_2021$cases <- (db_France_2021$cases / population_france)*100000
db_France_2021$deaths <- (db_France_2021$deaths / population_france)*100000

db_vaccine_France_2021$FirstDose <- (db_vaccine_France_2021$FirstDose / population_france)*100000
db_vaccine_France_2021$SecondDose <- (db_vaccine_France_2021$SecondDose / population_france)*100000
db_vaccine_France_2021$Booster <- (db_vaccine_France_2021$Booster / population_france)*100000

# variant processing data 
max_expected_week_2021 <- max(data_Variant_France_2021$week_number)
missing_weeks_2021 <- setdiff(1:max_expected_week_2021, data_Variant_France_2021$week_number)

if (length(missing_weeks_2021) > 0) {
  if (identical(missing_weeks_2021, 1:length(missing_weeks_2021))) {
    for (week in missing_weeks_2021) {
      data_Variant_France_2021[data_Variant_France_2021$week_number == week, ] <- data_Variant_France_2021[data_Variant_France_2021$week_number == max(data_Variant_France_2021$week_number[data_Variant_France_2021$week_number < week]), ]
    }
  } else {
    existing_weeks_2021 <- intersect(1:max_expected_week_2021, data_Variant_France_2021$week_number)
    missing_between_2021 <- setdiff(existing_weeks_2021 + 1, data_Variant_France_2021$week_number)
    for (week in missing_between_2021) {
      before <- data_Variant_France_2021[data_Variant_France_2021$week_number == max(data_Variant_France_2021$week_number[data_Variant_France_2021$week_number < week]), ]
      after <- data_Variant_France_2021[data_Variant_France_2021$week_number == min(data_Variant_France_2021$week_number[data_Variant_France_2021$week_number > week]), ]
      data_Variant_France_2021 <- rbind(data_Variant_France_2021, colMeans(rbind(before, after)))
    }
  }
}

```

#2022

```{r setup, include=FALSE}
## 2022
date_start <- ymd("2022-01-03")
date_end <- ymd("2023-01-01")
start_date <- as.Date("2022-01-03") 

Governement_stringecy_index_oxford_france_2022 <- Governement_stringecy_index_oxford_france %>% 
  filter(date >= date_start & date <= date_end)

Governement_stringecy_index_oxford_france_2022$date <- as.Date(Governement_stringecy_index_oxford_france_2022$date)

Governement_stringecy_index_oxford_france_2022 <- Governement_stringecy_index_oxford_france_2022 %>%
  mutate(days_since_start = as.numeric(date - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_france_2022 <- Containement_health_index_oxford_france %>% 
  filter(Day >= date_start & Day <= date_end)

Containement_health_index_oxford_france_2022$Day <- as.Date(Containement_health_index_oxford_france_2022$Day)

Containement_health_index_oxford_france_2022 <- Containement_health_index_oxford_france_2022 %>%
  mutate(days_since_start = as.numeric(Day - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# Management of different date formats and date range filtering
data_hospital_filtered_france_2022 <- data_hospital_filtered_france %>% 
  filter(date >= date_start & date <= date_end)

## Grouping the file 
data_hospital_filtered_france_2022$date <- as.Date(data_hospital_filtered_france_2022$date)

# Group by  
data_grouped_hospital_france_2022 <- data_hospital_filtered_france_2022 %>%
  mutate(days_since_start = as.numeric(date - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_France_2022 <- data_grouped_hospital_france_2022 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information)

db_hospital_France_2022 <- select(db_hospital_France_2022, -country, -week_number)

# Data Death
# Filter with Nation of Interest 
data_death_filtered_france_2022 <- data_death %>% 
  filter(country %in% selected_countries_france)

# Filter data for the year 2022
data_death_filtered_france_2022 <- data_death_filtered_france_2022 %>%
  filter(substr(year_week, 1, 4) == "2022")

# Data frame Cases and deaths 
db_death_France_2022 <- data_death_filtered_france_2022 %>%
  select(-country, -country_code, -continent,-population,-rate_14_day, -cumulative_count ,-source,-note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_France_2022 <- select(db_death_France_2022, -year_week)

db_France_2022 <- cbind(db_hospital_France_2022, db_death_France_2022)

# Data Vaccine 

# Filter data for the year 2022 and for not creating so much covariates i decide to mantain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_france_2022 <- data_vaccine_filtered_france %>%
  filter(substr(YearWeekISO, 1, 4) == "2022" & TargetGroup == "ALL")
# count Nan
missing_counts_france_2022 <- data_vaccine_filtered_france_2022 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_france_2022 <- data_vaccine_filtered_france_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

# Select the column 
db_vaccine_France_2022 <- select(data_vaccine_filtered_france_2022, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3,YearWeekISO)

db_vaccine_France_2022 <- db_vaccine_France_2022 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_France_2022 <- db_vaccine_France_2022 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
# Data Variant
data_variant_filter_France_2022 <- data_variant %>%
  filter(Location == "France", 
         !is.na(Variant) & Variant != "", 
         Collection_Date >= as.Date("2022-01-03") & Collection_Date <= as.Date("2023-01-01")) 
data_variant_filter_France_2022 <- select(data_variant_filter_France_2022,Collection_Date,Variant)
start_date <- as.Date("2022-01-03")  

# Group by  
data_grouped_variant_france_2022 <- data_variant_filter_France_2022 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_france_2022 <-  select(data_grouped_variant_france_2022,-count)
  
data_Variant_France_2022 <- data_grouped_variant_france_2022 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:52)
data_Variant_France_2022 <- data_Variant_France_2022 %>%distinct()
data_Variant_France_2022$week_number <- as.integer(data_Variant_France_2022$week_number)
data_Variant_France_2022 <- left_join(all_weeks, data_Variant_France_2022, by = "week_number")

# Standardize the data 
db_France_2022 <- db_France_2022 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
db_France_2022 <- db_France_2022 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

db_France_2022$Daily_ICU_occupancy <- (db_France_2022$Daily_ICU_occupancy / population_france)*100000
db_France_2022$Daily_hospital_occupancy <- (db_France_2022$Daily_hospital_occupancy / population_france)*100000
db_France_2022$cases <- (db_France_2022$cases / population_france)*100000
db_France_2022$deaths <- (db_France_2022$deaths / population_france)*100000

db_vaccine_France_2022$FirstDose <- (db_vaccine_France_2022$FirstDose / population_france)*100000
db_vaccine_France_2022$SecondDose <- (db_vaccine_France_2022$SecondDose / population_france)*100000
db_vaccine_France_2022$Booster <- (db_vaccine_France_2022$Booster / population_france)*100000

# Variant processing data 
max_expected_week_2022 <- max(data_Variant_France_2022$week_number)
missing_weeks_2022 <- setdiff(1:max_expected_week_2022, data_Variant_France_2022$week_number)

if (length(missing_weeks_2022) > 0) {
  if (identical(missing_weeks_2022, 1:length(missing_weeks_2022))) {
    for (week in missing_weeks_2022) {
      data_Variant_France_2022[data_Variant_France_2022$week_number == week, ] <- data_Variant_France_2022[data_Variant_France_2022$week_number == max(data_Variant_France_2022$week_number[data_Variant_France_2022$week_number < week]), ]
    }
  } else {
    existing_weeks_2022 <- intersect(1:max_expected_week_2022, data_Variant_France_2022$week_number)
    missing_between_2022 <- setdiff(existing_weeks_2022 + 1, data_Variant_France_2022$week_number)
    for (week in missing_between_2022) {
      before <- data_Variant_France_2022[data_Variant_France_2022$week_number == max(data_Variant_France_2022$week_number[data_Variant_France_2022$week_number < week]), ]
      after <- data_Variant_France_2022[data_Variant_France_2022$week_number == min(data_Variant_France_2022$week_number[data_Variant_France_2022$week_number > week]), ]
      data_Variant_France_2022 <- rbind(data_Variant_France_2022, colMeans(rbind(before, after)))
    }
  }
}
```

# NETHERLAND

```{r setup, include=FALSE}
selected_countries_netherlands <- c("Netherlands")

## LOAD DATA 
# HOSPITAL
data_hospital_filtered_netherlands <- data_hospital %>% 
  filter(country %in% selected_countries_netherlands)
data_hospital_filtered_netherlands$date <- parse_date_time(data_hospital_filtered_netherlands$date, orders = c("ymd", "ymd"))

## DEATH
data_death_filtered_netherlands <- data_death %>% 
  filter(country %in% selected_countries_netherlands)

# Obtain the population of nation 
population_netherlands <- unique(data_death_filtered_netherlands$population)

# Data Vaccine 

# Filter with Nation of Interest 
# country_code_mapping <- c(Spain = "ES", France = "FR", Netherlands = "NL", Latvia = "LV", Slovenia = "SI", Greece = "GR", Ireland = "IE", Cyprus = "CY", Estonia = "EE")

# Filter with Nation of Interest 
selected_countries_netherlands_iso <- c("NL")
data_vaccine_filtered_netherlands <- data_vaccine %>% filter(ReportingCountry %in% selected_countries_netherlands_iso)

# Filter health_index_oxford
Containement_health_index_oxford_netherlands <- Containement_health_index_oxford %>% 
  filter(Entity %in% selected_countries_netherlands)
Containement_health_index_oxford_netherlands$Day <- parse_date_time(Containement_health_index_oxford_netherlands$Day, orders = c("ymd", "ymd"))

# Filter Government Index
Governement_stringecy_index_oxford_netherlands <- Governement_stringecy_index_oxford %>% 
  filter(location %in% selected_countries_netherlands)
Governement_stringecy_index_oxford_netherlands$date <- parse_date_time(Governement_stringecy_index_oxford_netherlands$date, orders = c("ymd", "ymd"))

```

# 2020

```{r setup, include=FALSE}

# STRINGENCY INDEX
date_start_2020 <- ymd("2020-01-05")
date_end_2020 <- ymd("2021-01-03")
# Define the date of start 
start_date_2020 <- as.Date("2020-01-05") 

Governement_stringecy_index_oxford_netherlands_2020 <- Governement_stringecy_index_oxford_netherlands %>% 
  filter(date >= date_start_2020 & date <= date_end_2020)

Governement_stringecy_index_oxford_netherlands_2020$date <- as.Date(Governement_stringecy_index_oxford_netherlands_2020$date)

Governement_stringecy_index_oxford_netherlands_2020 <- Governement_stringecy_index_oxford_netherlands_2020 %>%
  mutate(days_since_start = as.numeric(date - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_netherlands_2020 <- Containement_health_index_oxford_netherlands %>% 
  filter(Day >= date_start_2020 & Day <= date_end_2020)

Containement_health_index_oxford_netherlands_2020$Day <- as.Date(Containement_health_index_oxford_netherlands_2020$Day)

Containement_health_index_oxford_netherlands_2020 <- Containement_health_index_oxford_netherlands_2020 %>%
  mutate(days_since_start = as.numeric(Day - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# HOSPITAL
data_hospital_filtered_netherlands_2020 <- data_hospital_filtered_netherlands %>% 
  filter(date >= date_start_2020 & date <= date_end_2020)

## Grouping the file 
data_hospital_filtered_netherlands_2020$date <- as.Date(data_hospital_filtered_netherlands_2020$date)

# Group by  
data_grouped_hospital_netherlands_2020 <- data_hospital_filtered_netherlands_2020 %>%
  mutate(days_since_start = as.numeric(date - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Netherlands_2020 <- data_grouped_hospital_netherlands_2020 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information) %>%
  arrange(week_number)

# Create a dataframe with all week numbers from 1 to 53
all_weeks <- tibble(week_number = 1:53)

db_hospital_Netherlands_2020 <- all_weeks %>%
  left_join(db_hospital_Netherlands_2020, by = "week_number") %>%
  select(-country)

# DEATH
data_death_filtered_netherlands_2020 <- data_death_filtered_netherlands %>%
  filter(substr(year_week, 1, 4) == "2020")
# Data frame Cases and deaths 
db_death_Netherlands_2020 <- data_death_filtered_netherlands_2020 %>%
  select(-country, -country_code, -continent,-population,-rate_14_day, -cumulative_count ,-source,-note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Netherlands_2020 <- select(db_death_Netherlands_2020, -year_week)

db_Netherlands_2020 <- cbind(db_hospital_Netherlands_2020, db_death_Netherlands_2020)

# VACCINE 

# Filter data for the year 2020 and for not creating so much covariates i decide to maintain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_netherlands_2020 <- data_vaccine_filtered_netherlands %>%
  filter(substr(YearWeekISO, 1, 4) == "2020" & TargetGroup == "ALL")
# count Nan
missing_counts_netherlands_2020 <- data_vaccine_filtered_netherlands_2020 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_netherlands_2020 <- data_vaccine_filtered_netherlands_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

db_vaccine_Netherlands_2020 <- select(data_vaccine_filtered_netherlands_2020, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3,YearWeekISO)

db_vaccine_Netherlands_2020 <- db_vaccine_Netherlands_2020 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Netherlands_2020 <- db_vaccine_Netherlands_2020 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
all_weeks <- data.frame(YearWeekISO = sprintf("2020-W%02d", 1:53))
# Unisci i dati riassunti con il dataframe di tutte le settimane
db_vaccine_Netherlands_2020 <- left_join(all_weeks, db_vaccine_Netherlands_2020, by = "YearWeekISO") %>%
  replace_na(list(FirstDose = 0, SecondDose = 0, Booster = 0))

# VARIANT 
data_variant_filter_Netherlands_2020 <- data_variant %>%
  filter(Location == "Netherlands", !is.na(Variant) & Variant != "", Collection_Date >= as.Date("2020-01-05") & Collection_Date <= as.Date("2021-01-03")) 
data_variant_filter_Netherlands_2020 <-select(data_variant_filter_Netherlands_2020,Collection_Date,Variant)
start_date_2020 <- as.Date("2020-01-05")  

# Group by  
data_grouped_variant_netherlands_2020 <- data_variant_filter_Netherlands_2020 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date_2020),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_netherlands_2020 <-  select(data_grouped_variant_netherlands_2020,-count)
  
data_Variant_Netherlands_2020 <- data_grouped_variant_netherlands_2020 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:53)
data_Variant_Netherlands_2020 <- data_Variant_Netherlands_2020 %>%distinct()
data_Variant_Netherlands_2020$week_number <- as.integer(data_Variant_Netherlands_2020$week_number)
data_Variant_Netherlands_2020 <- left_join(all_weeks, data_Variant_Netherlands_2020, by = "week_number")

# Standardize the data 
db_Netherlands_2020 <- db_Netherlands_2020 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
db_Netherlands_2020 <- db_Netherlands_2020 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

db_Netherlands_2020$Daily_ICU_occupancy <- (db_Netherlands_2020$Daily_ICU_occupancy / population_netherlands)*100000
db_Netherlands_2020$Daily_hospital_occupancy <- (db_Netherlands_2020$Daily_hospital_occupancy / population_netherlands)*100000
db_Netherlands_2020$cases <- (db_Netherlands_2020$cases / population_netherlands)*100000
db_Netherlands_2020$deaths <- (db_Netherlands_2020$deaths / population_netherlands)*100000

db_vaccine_Netherlands_2020$FirstDose <- (db_vaccine_Netherlands_2020$FirstDose / population_netherlands)*100000
db_vaccine_Netherlands_2020$SecondDose <- (db_vaccine_Netherlands_2020$SecondDose / population_netherlands)*100000
db_vaccine_Netherlands_2020$Booster <- (db_vaccine_Netherlands_2020$Booster / population_netherlands)*100000

# variant processing data 
max_expected_week_2020 <- max(data_Variant_Netherlands_2020$week_number)
missing_weeks_2020 <- setdiff(1:max_expected_week_2020, data_Variant_Netherlands_2020$week_number)

if (length(missing_weeks_2020) > 0) {
  if (identical(missing_weeks_2020, 1:length(missing_weeks_2020))) {
    for (week in missing_weeks_2020) {
      data_Variant_Netherlands_2020[data_Variant_Netherlands_2020$week_number == week, ] <- data_Variant_Netherlands_2020[data_Variant_Netherlands_2020$week_number == max(data_Variant_Netherlands_2020$week_number[data_Variant_Netherlands_2020$week_number < week]), ]
    }
  } else {
    existing_weeks <- intersect(1:max_expected_week_2020, data_Variant_Netherlands_2020$week_number)
    missing_between <- setdiff(existing_weeks + 1, data_Variant_Netherlands_2020$week_number)
    for (week in missing_between) {
      before <- data_Variant_Netherlands_2020[data_Variant_Netherlands_2020$week_number == max(data_Variant_Netherlands_2020$week_number[data_Variant_Netherlands_2020$week_number < week]), ]
      after <- data_Variant_Netherlands_2020[data_Variant_Netherlands_2020$week_number == min(data_Variant_Netherlands_2020$week_number[data_Variant_Netherlands_2020$week_number > week]), ]
      data_Variant_Netherlands_2020 <- rbind(data_Variant_Netherlands_2020, colMeans(rbind(before, after)))
    }
  }
}
```

# 2021

```{r setup, include=FALSE}
selected_countries_netherlands <- c("Netherlands")

## LOAD DATA 
# HOSPITAL
data_hospital_filtered_netherlands <- data_hospital %>% 
  filter(country %in% selected_countries_netherlands)
data_hospital_filtered_netherlands$date <- parse_date_time(data_hospital_filtered_netherlands$date, orders = c("ymd", "ymd"))

## DEATH
data_death_filtered_netherlands <- data_death %>% 
  filter(country %in% selected_countries_netherlands)

# Obtain the population of nation 
population_netherlands <- unique(data_death_filtered_netherlands$population)

# Data Vaccine 

# Filter with Nation of Interest 
selected_countries_netherlands_iso <- c("NL")
data_vaccine_filtered_netherlands <- data_vaccine %>% filter(ReportingCountry %in% selected_countries_netherlands_iso)

# Filter health_index_oxford
Containement_health_index_oxford_netherlands <- Containement_health_index_oxford %>% 
  filter(Entity %in% selected_countries_netherlands)
Containement_health_index_oxford_netherlands$Day <- parse_date_time(Containement_health_index_oxford_netherlands$Day, orders = c("ymd", "ymd"))

# Filter Government Index
Governement_stringecy_index_oxford_netherlands <- Governement_stringecy_index_oxford %>% 
  filter(location %in% selected_countries_netherlands)
Governement_stringecy_index_oxford_netherlands$date <- parse_date_time(Governement_stringecy_index_oxford_netherlands$date, orders = c("ymd", "ymd"))

# STRINGENCY INDEX
date_start <- ymd("2021-01-04")
date_end <- ymd("2022-01-02")
# Define the date of start 
start_date <- as.Date("2021-01-04")  

Governement_stringecy_index_oxford_netherlands_2021 <- Governement_stringecy_index_oxford_netherlands %>% 
  filter(date >= date_start & date <= date_end)

Governement_stringecy_index_oxford_netherlands_2021$date <- as.Date(Governement_stringecy_index_oxford_netherlands_2021$date)

Governement_stringecy_index_oxford_netherlands_2021 <- Governement_stringecy_index_oxford_netherlands_2021 %>%
  mutate(days_since_start = as.numeric(date - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_netherlands_2021 <- Containement_health_index_oxford_netherlands %>% 
  filter(Day >= date_start & Day <= date_end)

Containement_health_index_oxford_netherlands_2021$Day <- as.Date(Containement_health_index_oxford_netherlands_2021$Day)

Containement_health_index_oxford_netherlands_2021 <- Containement_health_index_oxford_netherlands_2021 %>%
  mutate(days_since_start = as.numeric(Day - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# Management of different date formats and date range filtering
data_hospital_filtered_netherlands_2021 <- data_hospital_filtered_netherlands %>% 
  filter(date >= date_start & date <= date_end)

## Grouping the file 
data_hospital_filtered_netherlands_2021$date <- as.Date(data_hospital_filtered_netherlands_2021$date)

# Group by  
data_grouped_hospital_netherlands_2021 <- data_hospital_filtered_netherlands_2021 %>%
  mutate(days_since_start = as.numeric(date - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Netherlands_2021 <- data_grouped_hospital_netherlands_2021 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information)

db_hospital_Netherlands_2021 <- select(db_hospital_Netherlands_2021, -country, -week_number)

# Data Death
data_death_filtered_netherlands_2021 <- data_death %>% 
  filter(country %in% selected_countries_netherlands)

# Filter data for the year 2021
data_death_filtered_netherlands_2021 <- data_death_filtered_netherlands_2021 %>%
  filter(substr(year_week, 1, 4) == "2021")

# Data frame Cases and deaths 
db_death_Netherlands_2021 <- data_death_filtered_netherlands_2021 %>%
  select(-country, -country_code, -continent,-population,-rate_14_day, -cumulative_count ,-source,-note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Netherlands_2021 <- select(db_death_Netherlands_2021, -year_week)

db_Netherlands_2021 <- cbind(db_hospital_Netherlands_2021, db_death_Netherlands_2021)

# Data Vaccine 
data_vaccine_filtered_netherlands_2021 <- data_vaccine_filtered_netherlands %>%
  filter(substr(YearWeekISO, 1, 4) == "2021" & TargetGroup == "ALL")
# count Nan
missing_counts_netherlands_2021 <- data_vaccine_filtered_netherlands_2021 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_netherlands_2021 <- data_vaccine_filtered_netherlands_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

# Select the column 
db_vaccine_Netherlands_2021 <- select(data_vaccine_filtered_netherlands_2021, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3,YearWeekISO)

db_vaccine_Netherlands_2021 <- db_vaccine_Netherlands_2021 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Netherlands_2021 <- db_vaccine_Netherlands_2021 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
# Data Variant
data_variant_filter_Netherlands_2021 <- data_variant %>%
  filter(Location == "Netherlands", 
         !is.na(Variant) & Variant != "", 
         Collection_Date >= as.Date("2021-01-04") & Collection_Date <= as.Date("2022-01-02")) 
data_variant_filter_Netherlands_2021 <- select(data_variant_filter_Netherlands_2021,Collection_Date,Variant)
start_date <- as.Date("2021-01-04")  

# Group by  
data_grouped_variant_netherlands_2021 <- data_variant_filter_Netherlands_2021 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_netherlands_2021 <-  select(data_grouped_variant_netherlands_2021,-count)
  
data_Variant_Netherlands_2021 <- data_grouped_variant_netherlands_2021 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:52)
data_Variant_Netherlands_2021 <- data_Variant_Netherlands_2021 %>%distinct()
data_Variant_Netherlands_2021$week_number <- as.integer(data_Variant_Netherlands_2021$week_number)
data_Variant_Netherlands_2021 <- left_join(all_weeks, data_Variant_Netherlands_2021, by = "week_number")

# Standardize the data 
db_Netherlands_2021 <- db_Netherlands_2021 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
db_Netherlands_2021 <- db_Netherlands_2021 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

db_Netherlands_2021$Daily_ICU_occupancy <- (db_Netherlands_2021$Daily_ICU_occupancy / population_netherlands)*100000
db_Netherlands_2021$Daily_hospital_occupancy <- (db_Netherlands_2021$Daily_hospital_occupancy / population_netherlands)*100000
db_Netherlands_2021$cases <- (db_Netherlands_2021$cases / population_netherlands)*100000
db_Netherlands_2021$deaths <- (db_Netherlands_2021$deaths / population_netherlands)*100000

db_vaccine_Netherlands_2021$FirstDose <- (db_vaccine_Netherlands_2021$FirstDose / population_netherlands)*100000
db_vaccine_Netherlands_2021$SecondDose <- (db_vaccine_Netherlands_2021$SecondDose / population_netherlands)*100000
db_vaccine_Netherlands_2021$Booster <- (db_vaccine_Netherlands_2021$Booster / population_netherlands)*100000

# variant processing data 
max_expected_week_2021 <- max(data_Variant_Netherlands_2021$week_number)
missing_weeks_2021 <- setdiff(1:max_expected_week_2021, data_Variant_Netherlands_2021$week_number)

if (length(missing_weeks_2021) > 0) {
  if (identical(missing_weeks_2021, 1:length(missing_weeks_2021))) {
    for (week in missing_weeks_2021) {
      data_Variant_Netherlands_2021[data_Variant_Netherlands_2021$week_number == week, ] <- data_Variant_Netherlands_2021[data_Variant_Netherlands_2021$week_number == max(data_Variant_Netherlands_2021$week_number[data_Variant_Netherlands_2021$week_number < week]), ]
    }
  } else {
    existing_weeks_2021 <- intersect(1:max_expected_week_2021, data_Variant_Netherlands_2021$week_number)
    missing_between_2021 <- setdiff(existing_weeks_2021 + 1, data_Variant_Netherlands_2021$week_number)
    for (week in missing_between_2021) {
      before <- data_Variant_Netherlands_2021[data_Variant_Netherlands_2021$week_number == max(data_Variant_Netherlands_2021$week_number[data_Variant_Netherlands_2021$week_number < week]), ]
      after <- data_Variant_Netherlands_2021[data_Variant_Netherlands_2021$week_number == min(data_Variant_Netherlands_2021$week_number[data_Variant_Netherlands_2021$week_number > week]), ]
      data_Variant_Netherlands_2021 <- rbind(data_Variant_Netherlands_2021, colMeans(rbind(before, after)))
    }
  }
}
```

# 2022
```{r setup, include=FALSE}
## 2022
date_start <- ymd("2022-01-03")
date_end <- ymd("2023-01-01")
start_date <- as.Date("2022-01-03") 

Governement_stringecy_index_oxford_Netherlands_2022 <- Governement_stringecy_index_oxford_netherlands %>% 
  filter(date >= date_start & date <= date_end)

Governement_stringecy_index_oxford_Netherlands_2022$date <- as.Date(Governement_stringecy_index_oxford_Netherlands_2022$date)

Governement_stringecy_index_oxford_Netherlands_2022 <- Governement_stringecy_index_oxford_Netherlands_2022 %>%
  mutate(days_since_start = as.numeric(date - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_Netherlands_2022 <- Containement_health_index_oxford_netherlands %>% 
  filter(Day >= date_start & Day <= date_end)

Containement_health_index_oxford_Netherlands_2022$Day <- as.Date(Containement_health_index_oxford_Netherlands_2022$Day)

Containement_health_index_oxford_Netherlands_2022 <- Containement_health_index_oxford_Netherlands_2022 %>%
  mutate(days_since_start = as.numeric(Day - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# Management of different date formats and date range filtering
data_hospital_filtered_Netherlands_2022 <- data_hospital_filtered_netherlands %>% 
  filter(date >= date_start & date <= date_end)

## Grouping the file 
data_hospital_filtered_Netherlands_2022$date <- as.Date(data_hospital_filtered_Netherlands_2022$date)

# Group by  
data_grouped_hospital_Netherlands_2022 <- data_hospital_filtered_Netherlands_2022 %>%
  mutate(days_since_start = as.numeric(date - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Netherlands_2022 <- data_grouped_hospital_Netherlands_2022 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information)

db_hospital_Netherlands_2022 <- select(db_hospital_Netherlands_2022, -country, -week_number)

# Data Death
# Filter with Nation of Interest 
data_death_filtered_Netherlands_2022 <- data_death %>% 
  filter(country %in% selected_countries_netherlands)

# Filter data for the year 2022
data_death_filtered_Netherlands_2022 <- data_death_filtered_Netherlands_2022 %>%
  filter(substr(year_week, 1, 4) == "2022")

# Data frame Cases and deaths 
db_death_Netherlands_2022 <- data_death_filtered_Netherlands_2022 %>%
  select(-country, -country_code, -continent,-population,-rate_14_day, -cumulative_count ,-source,-note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Netherlands_2022 <- select(db_death_Netherlands_2022, -year_week)

db_Netherlands_2022 <- cbind(db_hospital_Netherlands_2022, db_death_Netherlands_2022)

# Data Vaccine 

# Filter data for the year 2022 and for not creating so much covariates i decide to mantain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_Netherlands_2022 <- data_vaccine_filtered_netherlands %>%
  filter(substr(YearWeekISO, 1, 4) == "2022" & TargetGroup == "ALL")
# count Nan
missing_counts_Netherlands_2022 <- data_vaccine_filtered_Netherlands_2022 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_Netherlands_2022 <- data_vaccine_filtered_Netherlands_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

# Select the column 
db_vaccine_Netherlands_2022 <- select(data_vaccine_filtered_Netherlands_2022, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3,YearWeekISO)

db_vaccine_Netherlands_2022 <- db_vaccine_Netherlands_2022 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Netherlands_2022 <- db_vaccine_Netherlands_2022 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
# Data Variant
data_variant_filter_Netherlands_2022 <- data_variant %>%
  filter(Location == "Netherlands", 
         !is.na(Variant) & Variant != "", 
         Collection_Date >= as.Date("2022-01-03") & Collection_Date <= as.Date("2023-01-01")) 
data_variant_filter_Netherlands_2022 <- select(data_variant_filter_Netherlands_2022,Collection_Date,Variant)
start_date <- as.Date("2022-01-03")  

# Group by  
data_grouped_variant_Netherlands_2022 <- data_variant_filter_Netherlands_2022 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_Netherlands_2022 <-  select(data_grouped_variant_Netherlands_2022,-count)
  
data_Variant_Netherlands_2022 <- data_grouped_variant_Netherlands_2022 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:52)
data_Variant_Netherlands_2022 <- data_Variant_Netherlands_2022 %>%distinct()
data_Variant_Netherlands_2022$week_number <- as.integer(data_Variant_Netherlands_2022$week_number)
data_Variant_Netherlands_2022 <- left_join(all_weeks, data_Variant_Netherlands_2022, by = "week_number")

# Standardize the data 
db_Netherlands_2022 <- db_Netherlands_2022 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
db_Netherlands_2022 <- db_Netherlands_2022 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

db_Netherlands_2022$Daily_ICU_occupancy <- (db_Netherlands_2022$Daily_ICU_occupancy / population_netherlands)*100000
db_Netherlands_2022$Daily_hospital_occupancy <- (db_Netherlands_2022$Daily_hospital_occupancy / population_netherlands)*100000
db_Netherlands_2022$cases <- (db_Netherlands_2022$cases / population_netherlands)*100000
db_Netherlands_2022$deaths <- (db_Netherlands_2022$deaths / population_netherlands)*100000

db_vaccine_Netherlands_2022$FirstDose <- (db_vaccine_Netherlands_2022$FirstDose / population_netherlands)*100000
db_vaccine_Netherlands_2022$SecondDose <- (db_vaccine_Netherlands_2022$SecondDose / population_netherlands)*100000
db_vaccine_Netherlands_2022$Booster <- (db_vaccine_Netherlands_2022$Booster / population_netherlands)*100000

# Variant processing data 
max_expected_week_2022 <- max(data_Variant_Netherlands_2022$week_number)
missing_weeks_2022 <- setdiff(1:max_expected_week_2022, data_Variant_Netherlands_2022$week_number)

if (length(missing_weeks_2022) > 0) {
  if (identical(missing_weeks_2022, 1:length(missing_weeks_2022))) {
    for (week in missing_weeks_2022) {
      data_Variant_Netherlands_2022[data_Variant_Netherlands_2022$week_number == week, ] <- data_Variant_Netherlands_2022[data_Variant_Netherlands_2022$week_number == max(data_Variant_Netherlands_2022$week_number[data_Variant_Netherlands_2022$week_number < week]), ]
    }
  } else {
    existing_weeks_2022 <- intersect(1:max_expected_week_2022, data_Variant_Netherlands_2022$week_number)
    missing_between_2022 <- setdiff(existing_weeks_2022 + 1, data_Variant_Netherlands_2022$week_number)
    for (week in missing_between_2022) {
      before <- data_Variant_Netherlands_2022[data_Variant_Netherlands_2022$week_number == max(data_Variant_Netherlands_2022$week_number[data_Variant_Netherlands_2022$week_number < week]), ]
      after <- data_Variant_Netherlands_2022[data_Variant_Netherlands_2022$week_number == min(data_Variant_Netherlands_2022$week_number[data_Variant_Netherlands_2022$week_number > week]), ]
      data_Variant_Netherlands_2022 <- rbind(data_Variant_Netherlands_2022, colMeans(rbind(before, after)))
    }
  }
}
```

# LATVIA

```{r setup, include=FALSE}
## Setup for Latvia
selected_countries_latvia <- c("Latvia")

## LOAD DATA 
# HOSPITAL
data_hospital_filtered_latvia <- data_hospital %>% 
  filter(country %in% selected_countries_latvia)
data_hospital_filtered_latvia$date <- parse_date_time(data_hospital_filtered_latvia$date, orders = c("ymd", "ymd"))

## DEATH
data_death_filtered_latvia <- data_death %>% 
  filter(country %in% selected_countries_latvia)

# Obtain the population of the nation 
population_latvia <- unique(data_death_filtered_latvia$population)

# Data Vaccine 
selected_countries_latvia_iso <- c("LV")
data_vaccine_filtered_latvia <- data_vaccine %>% filter(ReportingCountry %in% selected_countries_latvia_iso)

# Filter health_index_oxford
Containement_health_index_oxford_latvia <- Containement_health_index_oxford %>% 
  filter(Entity %in% selected_countries_latvia)
Containement_health_index_oxford_latvia$Day <- parse_date_time(Containement_health_index_oxford_latvia$Day, orders = c("ymd", "ymd"))

# Filter Government Index
Governement_stringecy_index_oxford_latvia <- Governement_stringecy_index_oxford %>% 
  filter(location %in% selected_countries_latvia)
Governement_stringecy_index_oxford_latvia$date <- parse_date_time(Governement_stringecy_index_oxford_latvia$date, orders = c("ymd", "ymd"))
```

# 2020

```{r setup, include=FALSE}
# For the year 2020
# STRINGENCY INDEX
date_start_2020 <- ymd("2020-01-05")
date_end_2020 <- ymd("2021-01-03")
# Define the date of start 
start_date_2020 <- as.Date("2020-01-05") 

Governement_stringecy_index_oxford_latvia_2020 <- Governement_stringecy_index_oxford_latvia %>% 
  filter(date >= date_start_2020 & date <= date_end_2020)

Governement_stringecy_index_oxford_latvia_2020$date <- as.Date(Governement_stringecy_index_oxford_latvia_2020$date)

Governement_stringecy_index_oxford_latvia_2020 <- Governement_stringecy_index_oxford_latvia_2020 %>%
  mutate(days_since_start = as.numeric(date - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_latvia_2020 <- Containement_health_index_oxford_latvia %>% 
  filter(Day >= date_start_2020 & Day <= date_end_2020)

Containement_health_index_oxford_latvia_2020$Day <- as.Date(Containement_health_index_oxford_latvia_2020$Day)

Containement_health_index_oxford_latvia_2020 <- Containement_health_index_oxford_latvia_2020 %>%
  mutate(days_since_start = as.numeric(Day - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# HOSPITAL
data_hospital_filtered_latvia_2020 <- data_hospital_filtered_latvia %>% 
  filter(date >= date_start_2020 & date <= date_end_2020)

## Grouping the file 
data_hospital_filtered_latvia_2020$date <- as.Date(data_hospital_filtered_latvia_2020$date)

# Group by  
data_grouped_hospital_latvia_2020 <- data_hospital_filtered_latvia_2020 %>%
  mutate(days_since_start = as.numeric(date - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Latvia_2020 <- data_grouped_hospital_latvia_2020 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information) %>%
  arrange(week_number)

# Create a dataframe with all week numbers from 1 to 53
all_weeks <- tibble(week_number = 1:53)

db_hospital_Latvia_2020 <- all_weeks %>%
  left_join(db_hospital_Latvia_2020, by = "week_number") %>%
  select(-country)

# DEATH
data_death_filtered_latvia_2020 <- data_death_filtered_latvia %>%
  filter(substr(year_week, 1, 4) == "2020")
# Data frame Cases and deaths 
db_death_Latvia_2020 <- data_death_filtered_latvia_2020 %>%
  select(-country, -country_code, -continent,-population,-rate_14_day, -cumulative_count ,-source,-note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Latvia_2020 <- select(db_death_Latvia_2020, -year_week)

db_Latvia_2020 <- cbind(db_hospital_Latvia_2020, db_death_Latvia_2020)

# VACCINE 

# Filter data for the year 2020 and for not creating so much covariates i decide to maintain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_latvia_2020 <- data_vaccine_filtered_latvia %>%
  filter(substr(YearWeekISO, 1, 4) == "2020" & TargetGroup == "ALL")
# count Nan
missing_counts_latvia_2020 <- data_vaccine_filtered_latvia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_latvia_2020 <- data_vaccine_filtered_latvia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

db_vaccine_Latvia_2020 <- select(data_vaccine_filtered_latvia_2020, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3,YearWeekISO)

db_vaccine_Latvia_2020 <- db_vaccine_Latvia_2020 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Latvia_2020 <- db_vaccine_Latvia_2020 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
all_weeks <- data.frame(YearWeekISO = sprintf("2020-W%02d", 1:53))
# Unisci i dati riassunti con il dataframe di tutte le settimane
db_vaccine_Latvia_2020 <- left_join(all_weeks, db_vaccine_Latvia_2020, by = "YearWeekISO") %>%
  replace_na(list(FirstDose = 0, SecondDose = 0, Booster = 0))

# VARIANT 
data_variant_filter_Latvia_2020 <- data_variant %>%
  filter(Location == "Latvia", !is.na(Variant) & Variant != "", Collection_Date >= as.Date("2020-01-05") & Collection_Date <= as.Date("2021-01-03")) 
data_variant_filter_Latvia_2020 <-select(data_variant_filter_Latvia_2020,Collection_Date,Variant)
start_date_2020 <- as.Date("2020-01-05")  

# Group by  
data_grouped_variant_latvia_2020 <- data_variant_filter_Latvia_2020 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date_2020),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_latvia_2020 <-  select(data_grouped_variant_latvia_2020,-count)
  
data_Variant_Latvia_2020 <- data_grouped_variant_latvia_2020 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:53)
data_Variant_Latvia_2020 <- data_Variant_Latvia_2020 %>%distinct()
data_Variant_Latvia_2020$week_number <- as.integer(data_Variant_Latvia_2020$week_number)
data_Variant_Latvia_2020 <- left_join(all_weeks, data_Variant_Latvia_2020, by = "week_number")

# Standardize the data 
#db_Latvia_2020 <- db_Latvia_2020 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
#db_Latvia_2020 <- db_Latvia_2020 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

#db_Latvia_2020$Daily_ICU_occupancy <- (db_Latvia_2020$Daily_ICU_occupancy / population_latvia)*100000
#db_Latvia_2020$Daily_hospital_occupancy <- (db_Latvia_2020$Daily_hospital_occupancy / population_latvia)*100000
db_Latvia_2020$cases <- (db_Latvia_2020$cases / population_latvia)*100000
db_Latvia_2020$deaths <- (db_Latvia_2020$deaths / population_latvia)*100000

db_vaccine_Latvia_2020$FirstDose <- (db_vaccine_Latvia_2020$FirstDose / population_latvia)*100000
db_vaccine_Latvia_2020$SecondDose <- (db_vaccine_Latvia_2020$SecondDose / population_latvia)*100000
db_vaccine_Latvia_2020$Booster <- (db_vaccine_Latvia_2020$Booster / population_latvia)*100000

# variant processing data 
max_expected_week_2020 <- max(data_Variant_Latvia_2020$week_number)
missing_weeks_2020 <- setdiff(1:max_expected_week_2020, data_Variant_Latvia_2020$week_number)

if (length(missing_weeks_2020) > 0) {
  if (identical(missing_weeks_2020, 1:length(missing_weeks_2020))) {
    for (week in missing_weeks_2020) {
      data_Variant_Latvia_2020[data_Variant_Latvia_2020$week_number == week, ] <- data_Variant_Latvia_2020[data_Variant_Latvia_2020$week_number == max(data_Variant_Latvia_2020$week_number[data_Variant_Latvia_2020$week_number < week]), ]
    }
  } else {
    existing_weeks <- intersect(1:max_expected_week_2020, data_Variant_Latvia_2020$week_number)
    missing_between <- setdiff(existing_weeks + 1, data_Variant_Latvia_2020$week_number)
    for (week in missing_between) {
      before <- data_Variant_Latvia_2020[data_Variant_Latvia_2020$week_number == max(data_Variant_Latvia_2020$week_number[data_Variant_Latvia_2020$week_number < week]), ]
      after <- data_Variant_Latvia_2020[data_Variant_Latvia_2020$week_number == min(data_Variant_Latvia_2020$week_number[data_Variant_Latvia_2020$week_number > week]), ]
      data_Variant_Latvia_2020 <- rbind(data_Variant_Latvia_2020, colMeans(rbind(before, after)))
    }
  }
}

```

# 2021

```{r setup, include=FALSE}
#STRINGENCY INDEX
date_start <- ymd("2021-01-04")
date_end <- ymd("2022-01-02")
# Define the date of start 
start_date <- as.Date("2021-01-04")  

Governement_stringecy_index_oxford_latvia_2021 <- Governement_stringecy_index_oxford_latvia %>% 
  filter(date >= date_start & date <= date_end)

Governement_stringecy_index_oxford_latvia_2021$date <- as.Date(Governement_stringecy_index_oxford_latvia_2021$date)

Governement_stringecy_index_oxford_latvia_2021 <- Governement_stringecy_index_oxford_latvia_2021 %>%
  mutate(days_since_start = as.numeric(date - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_latvia_2021 <- Containement_health_index_oxford_latvia %>% 
  filter(Day >= date_start & Day <= date_end)

Containement_health_index_oxford_latvia_2021$Day <- as.Date(Containement_health_index_oxford_latvia_2021$Day)

Containement_health_index_oxford_latvia_2021 <- Containement_health_index_oxford_latvia_2021 %>%
  mutate(days_since_start = as.numeric(Day - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# Management of different date formats and date range filtering
data_hospital_filtered_latvia_2021 <- data_hospital_filtered_latvia %>%
filter(date >= date_start & date <= date_end)

#Grouping the file

data_hospital_filtered_latvia_2021$date <- as.Date(data_hospital_filtered_latvia_2021$date)

#Group by

data_grouped_hospital_latvia_2021 <- data_hospital_filtered_latvia_2021 %>%
mutate(days_since_start = as.numeric(date - start_date)) %>%
mutate(week_number = 1 + (days_since_start %/% 7)) %>%
group_by(country, indicator, week_number) %>%
summarize(
weekly_information = mean(value, na.rm = TRUE),
.groups = 'drop'
)

#DataFrame

db_hospital_Latvia_2021 <- data_grouped_hospital_latvia_2021 %>%
pivot_wider(names_from = indicator, values_from = weekly_information)

db_hospital_Latvia_2021 <- select(db_hospital_Latvia_2021, -country, -week_number)

#Data Death

data_death_filtered_latvia_2021 <- data_death %>%
filter(country %in% selected_countries_latvia)

#Filter data for the year 2021

data_death_filtered_latvia_2021 <- data_death_filtered_latvia_2021 %>%
filter(substr(year_week, 1, 4) == "2021")

#Data frame Cases and deaths

db_death_Latvia_2021 <- data_death_filtered_latvia_2021 %>%
select(-country, -country_code, -continent,-population,-rate_14_day, -cumulative_count ,-source,-note) %>%
pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Latvia_2021 <- select(db_death_Latvia_2021, -year_week)

db_Latvia_2021 <- cbind(db_hospital_Latvia_2021, db_death_Latvia_2021)

#Data Vaccine

data_vaccine_filtered_latvia_2021 <- data_vaccine_filtered_latvia %>%
filter(substr(YearWeekISO, 1, 4) == "2021" & TargetGroup == "ALL")

#count Nan

missing_counts_latvia_2021 <- data_vaccine_filtered_latvia_2021 %>%
summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_latvia_2021 <- data_vaccine_filtered_latvia_2021 %>%
summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

#Select the column

db_vaccine_Latvia_2021 <- select(data_vaccine_filtered_latvia_2021, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3,YearWeekISO)

db_vaccine_Latvia_2021 <- db_vaccine_Latvia_2021 %>%
mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Latvia_2021 <- db_vaccine_Latvia_2021 %>%
group_by(YearWeekISO) %>%
summarize(
FirstDose = sum(FirstDose, na.rm = TRUE),
SecondDose = sum(SecondDose, na.rm = TRUE),
Booster = sum(Booster, na.rm = TRUE)
)

#Data Variant

data_variant_filter_Latvia_2021 <- data_variant %>%
filter(Location == "Latvia",
!is.na(Variant) & Variant != "",
Collection_Date >= as.Date("2021-01-04") & Collection_Date <= as.Date("2022-01-02"))
data_variant_filter_Latvia_2021 <- select(data_variant_filter_Latvia_2021, Collection_Date, Variant)
start_date <- as.Date("2021-01-04")

#Group by

data_grouped_variant_latvia_2021 <- data_variant_filter_Latvia_2021 %>%
mutate(
days_since_start = as.numeric(Collection_Date - start_date),
week_number = 1 + (days_since_start %/% 7)
) %>%
group_by(week_number, Variant) %>%
summarize(count = n(), .groups = 'drop') %>%
group_by(week_number) %>%
mutate(percentage = (count / sum(count)) * 100) %>%
ungroup()

data_grouped_variant_latvia_2021 <- select(data_grouped_variant_latvia_2021,-count)

data_Variant_Latvia_2021 <- data_grouped_variant_latvia_2021 %>%
pivot_wider(
names_from = Variant,
values_from = percentage,
values_fill = list(percentage = 0)
)

all_weeks <- data.frame(week_number = 1:52)
data_Variant_Latvia_2021 <- data_Variant_Latvia_2021 %>%distinct()
data_Variant_Latvia_2021$week_number <- as.integer(data_Variant_Latvia_2021$week_number)
data_Variant_Latvia_2021 <- left_join(all_weeks, data_Variant_Latvia_2021, by = "week_number")

#Standardize the data

#db_Latvia_2021 <- db_Latvia_2021 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
#db_Latvia_2021 <- db_Latvia_2021 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

#db_Latvia_2021$Daily_ICU_occupancy <- (db_Latvia_2021$Daily_ICU_occupancy / population_latvia)*100000
#db_Latvia_2021$Daily_hospital_occupancy <- (db_Latvia_2021$Daily_hospital_occupancy / population_latvia)*100000
db_Latvia_2021$cases <- (db_Latvia_2021$cases / population_latvia)*100000
db_Latvia_2021$deaths <- (db_Latvia_2021$deaths / population_latvia)*100000

db_vaccine_Latvia_2021$FirstDose <- (db_vaccine_Latvia_2021$FirstDose / population_latvia)*100000
db_vaccine_Latvia_2021$SecondDose <- (db_vaccine_Latvia_2021$SecondDose / population_latvia)*100000
db_vaccine_Latvia_2021$Booster <- (db_vaccine_Latvia_2021$Booster / population_latvia)*100000

#variant processing data

max_expected_week_2021 <- max(data_Variant_Latvia_2021$week_number)
missing_weeks_2021 <- setdiff(1:max_expected_week_2021, data_Variant_Latvia_2021$week_number)

if (length(missing_weeks_2021) > 0) {
if (identical(missing_weeks_2021, 1:length(missing_weeks_2021))) {
for (week in missing_weeks_2021) {
data_Variant_Latvia_2021[data_Variant_Latvia_2021$week_number == week, ] <- data_Variant_Latvia_2021[data_Variant_Latvia_2021$week_number == max(data_Variant_Latvia_2021$week_number[data_Variant_Latvia_2021$week_number < week]), ]
}
} else {
existing_weeks_2021 <- intersect(1:max_expected_week_2021, data_Variant_Latvia_2021$week_number)
missing_between_2021 <- setdiff(existing_weeks_2021 + 1, data_Variant_Latvia_2021$week_number)
for (week in missing_between_2021) {
before <- data_Variant_Latvia_2021[data_Variant_Latvia_2021$week_number == max(data_Variant_Latvia_2021$week_number[data_Variant_Latvia_2021$week_number < week]), ]
after <- data_Variant_Latvia_2021[data_Variant_Latvia_2021$week_number == min(data_Variant_Latvia_2021$week_number[data_Variant_Latvia_2021$week_number > week]), ]
data_Variant_Latvia_2021 <- rbind(data_Variant_Latvia_2021, colMeans(rbind(before, after)))
}
}
}
```

# 2022

```{r setup, include=FALSE}
## 2022
date_start <- ymd("2022-01-03")
date_end <- ymd("2023-01-01")
start_date <- as.Date("2022-01-03") 

Governement_stringecy_index_oxford_latvia_2022 <- Governement_stringecy_index_oxford_latvia %>% 
  filter(date >= date_start & date <= date_end)

Governement_stringecy_index_oxford_latvia_2022$date <- as.Date(Governement_stringecy_index_oxford_latvia_2022$date)

Governement_stringecy_index_oxford_latvia_2022 <- Governement_stringecy_index_oxford_latvia_2022 %>%
  mutate(days_since_start = as.numeric(date - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_latvia_2022 <- Containement_health_index_oxford_latvia %>% 
  filter(Day >= date_start & Day <= date_end)

Containement_health_index_oxford_latvia_2022$Day <- as.Date(Containement_health_index_oxford_latvia_2022$Day)

Containement_health_index_oxford_latvia_2022 <- Containement_health_index_oxford_latvia_2022 %>%
  mutate(days_since_start = as.numeric(Day - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# Management of different date formats and date range filtering
data_hospital_filtered_latvia_2022 <- data_hospital_filtered_latvia %>% 
  filter(date >= date_start & date <= date_end)

## Grouping the file 
data_hospital_filtered_latvia_2022$date <- as.Date(data_hospital_filtered_latvia_2022$date)

# Group by  
data_grouped_hospital_latvia_2022 <- data_hospital_filtered_latvia_2022 %>%
  mutate(days_since_start = as.numeric(date - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Latvia_2022 <- data_grouped_hospital_latvia_2022 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information)

db_hospital_Latvia_2022 <- select(db_hospital_Latvia_2022, -country, -week_number)

# Data Death
data_death_filtered_latvia_2022 <- data_death %>% 
  filter(country %in% selected_countries_latvia)

# Filter data for the year 2022
data_death_filtered_latvia_2022 <- data_death_filtered_latvia_2022 %>%
  filter(substr(year_week, 1, 4) == "2022")

# Data frame Cases and deaths 
db_death_Latvia_2022 <- data_death_filtered_latvia_2022 %>%
  select(-country, -country_code, -continent,-population,-rate_14_day, -cumulative_count ,-source,-note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Latvia_2022 <- select(db_death_Latvia_2022, -year_week)

db_Latvia_2022 <- cbind(db_hospital_Latvia_2022, db_death_Latvia_2022)

# Data Vaccine 
data_vaccine_filtered_latvia_2022 <- data_vaccine_filtered_latvia %>%
  filter(substr(YearWeekISO, 1, 4) == "2022" & TargetGroup == "ALL")
# count Nan
missing_counts_latvia_2022 <- data_vaccine_filtered_latvia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_latvia_2022 <- data_vaccine_filtered_latvia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

# Select the column 
db_vaccine_Latvia_2022 <- select(data_vaccine_filtered_latvia_2022, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3,YearWeekISO)

db_vaccine_Latvia_2022 <- db_vaccine_Latvia_2022 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Latvia_2022 <- db_vaccine_Latvia_2022 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
# Data Variant
data_variant_filter_Latvia_2022 <- data_variant %>%
  filter(Location == "Latvia", 
         !is.na(Variant) & Variant != "", 
         Collection_Date >= as.Date("2022-01-03") & Collection_Date <= as.Date("2023-01-01")) 
data_variant_filter_Latvia_2022 <- select(data_variant_filter_Latvia_2022,Collection_Date,Variant)
start_date <- as.Date("2022-01-03")  

# Group by  
data_grouped_variant_latvia_2022 <- data_variant_filter_Latvia_2022 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_latvia_2022 <-  select(data_grouped_variant_latvia_2022,-count)
  
data_Variant_Latvia_2022 <- data_grouped_variant_latvia_2022 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:52)
data_Variant_Latvia_2022 <- data_Variant_Latvia_2022 %>%distinct()
data_Variant_Latvia_2022$week_number <- as.integer(data_Variant_Latvia_2022$week_number)
data_Variant_Latvia_2022 <- left_join(all_weeks, data_Variant_Latvia_2022, by = "week_number")

# Standardize the data 
#db_Latvia_2022 <- db_Latvia_2022 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
#db_Latvia_2022 <- db_Latvia_2022 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

#db_Latvia_2022$Daily_ICU_occupancy <- (db_Latvia_2022$Daily_ICU_occupancy / population_latvia)*100000
#db_Latvia_2022$Daily_hospital_occupancy <- (db_Latvia_2022$Daily_hospital_occupancy / population_latvia)*100000
db_Latvia_2022$cases <- (db_Latvia_2022$cases / population_latvia)*100000
db_Latvia_2022$deaths <- (db_Latvia_2022$deaths / population_latvia)*100000

db_vaccine_Latvia_2022$FirstDose <- (db_vaccine_Latvia_2022$FirstDose / population_latvia)*100000
db_vaccine_Latvia_2022$SecondDose <- (db_vaccine_Latvia_2022$SecondDose / population_latvia)*100000
db_vaccine_Latvia_2022$Booster <- (db_vaccine_Latvia_2022$Booster / population_latvia)*100000

# Variant processing data 
max_expected_week_2022 <- max(data_Variant_Latvia_2022$week_number)
missing_weeks_2022 <- setdiff(1:max_expected_week_2022, data_Variant_Latvia_2022$week_number)

if (length(missing_weeks_2022) > 0) {
  if (identical(missing_weeks_2022, 1:length(missing_weeks_2022))) {
    for (week in missing_weeks_2022) {
      data_Variant_Latvia_2022[data_Variant_Latvia_2022$week_number == week, ] <- data_Variant_Latvia_2022[data_Variant_Latvia_2022$week_number == max(data_Variant_Latvia_2022$week_number[data_Variant_Latvia_2022$week_number < week]), ]
    }
  } else {
    existing_weeks_2022 <- intersect(1:max_expected_week_2022, data_Variant_Latvia_2022$week_number)
    missing_between_2022 <- setdiff(existing_weeks_2022 + 1, data_Variant_Latvia_2022$week_number)
    for (week in missing_between_2022) {
      before <- data_Variant_Latvia_2022[data_Variant_Latvia_2022$week_number == max(data_Variant_Latvia_2022$week_number[data_Variant_Latvia_2022$week_number < week]), ]
      after <- data_Variant_Latvia_2022[data_Variant_Latvia_2022$week_number == min(data_Variant_Latvia_2022$week_number[data_Variant_Latvia_2022$week_number > week]), ]
      data_Variant_Latvia_2022 <- rbind(data_Variant_Latvia_2022, colMeans(rbind(before, after)))
    }
  }
}
```

# SLOVENIA

```{r setup, include=FALSE}
selected_countries_slovenia <- c("Slovenia")

## LOAD DATA 
# HOSPITAL
data_hospital_filtered_slovenia <- data_hospital %>% 
  filter(country %in% selected_countries_slovenia)
data_hospital_filtered_slovenia$date <- parse_date_time(data_hospital_filtered_slovenia$date, orders = c("ymd", "ymd"))

## DEATH
data_death_filtered_slovenia <- data_death %>% 
  filter(country %in% selected_countries_slovenia)

# Obtain the population of the nation 
population_slovenia <- unique(data_death_filtered_slovenia$population)

# Data Vaccine 

# Filter with Nation of Interest 
selected_countries_slovenia_iso <- c("SI")  # ISO code for Slovenia
data_vaccine_filtered_slovenia <- data_vaccine %>% filter(ReportingCountry %in% selected_countries_slovenia_iso)

# Filter health_index_oxford
Containement_health_index_oxford_slovenia <- Containement_health_index_oxford %>% 
  filter(Entity %in% selected_countries_slovenia)
Containement_health_index_oxford_slovenia$Day <- parse_date_time(Containement_health_index_oxford_slovenia$Day, orders = c("ymd", "ymd"))

# Filter Government Index
Governement_stringecy_index_oxford_slovenia <- Governement_stringecy_index_oxford %>% 
  filter(location %in% selected_countries_slovenia)
Governement_stringecy_index_oxford_slovenia$date <- parse_date_time(Governement_stringecy_index_oxford_slovenia$date, orders = c("ymd", "ymd"))
```

# 2020

```{r setup, include=FALSE}
# For the year 2020
# STRINGENCY INDEX
date_start_2020 <- ymd("2020-01-05")
date_end_2020 <- ymd("2021-01-03")
# Define the date of start 
start_date_2020 <- as.Date("2020-01-05") 

Governement_stringecy_index_oxford_slovenia_2020 <- Governement_stringecy_index_oxford_slovenia %>% 
  filter(date >= date_start_2020 & date <= date_end_2020)

Governement_stringecy_index_oxford_slovenia_2020$date <- as.Date(Governement_stringecy_index_oxford_slovenia_2020$date)

Governement_stringecy_index_oxford_slovenia_2020 <- Governement_stringecy_index_oxford_slovenia_2020 %>%
  mutate(days_since_start = as.numeric(date - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_slovenia_2020 <- Containement_health_index_oxford_slovenia %>% 
  filter(Day >= date_start_2020 & Day <= date_end_2020)

Containement_health_index_oxford_slovenia_2020$Day <- as.Date(Containement_health_index_oxford_slovenia_2020$Day)

Containement_health_index_oxford_slovenia_2020 <- Containement_health_index_oxford_slovenia_2020 %>%
  mutate(days_since_start = as.numeric(Day - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# HOSPITAL
data_hospital_filtered_slovenia_2020 <- data_hospital_filtered_slovenia %>% 
  filter(date >= date_start_2020 & date <= date_end_2020)

## Grouping the file 
data_hospital_filtered_slovenia_2020$date <- as.Date(data_hospital_filtered_slovenia_2020$date)

# Group by  
data_grouped_hospital_slovenia_2020 <- data_hospital_filtered_slovenia_2020 %>%
  mutate(days_since_start = as.numeric(date - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Slovenia_2020 <- data_grouped_hospital_slovenia_2020 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information) %>%
  arrange(week_number)

# Create a dataframe with all week numbers from 1 to 53
all_weeks <- tibble(week_number = 1:53)

db_hospital_Slovenia_2020 <- all_weeks %>%
  left_join(db_hospital_Slovenia_2020, by = "week_number") %>%
  select(-country)

# DEATH
data_death_filtered_slovenia_2020 <- data_death_filtered_slovenia %>%
  filter(substr(year_week, 1, 4) == "2020")
# Data frame Cases and deaths 
db_death_Slovenia_2020 <- data_death_filtered_slovenia_2020 %>%
  select(-country, -country_code, -continent,-population,-rate_14_day, -cumulative_count ,-source,-note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Slovenia_2020 <- select(db_death_Slovenia_2020, -year_week)

db_Slovenia_2020 <- cbind(db_hospital_Slovenia_2020, db_death_Slovenia_2020)

# VACCINE 

# Filter data for the year 2020 and for not creating so much covariates I decide to maintain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_slovenia_2020 <- data_vaccine_filtered_slovenia %>%
  filter(substr(YearWeekISO, 1, 4) == "2020" & TargetGroup == "ALL")
# count Nan
missing_counts_slovenia_2020 <- data_vaccine_filtered_slovenia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_slovenia_2020 <- data_vaccine_filtered_slovenia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

db_vaccine_Slovenia_2020 <- select(data_vaccine_filtered_slovenia_2020, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3, YearWeekISO)

db_vaccine_Slovenia_2020 <- db_vaccine_Slovenia_2020 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Slovenia_2020 <- db_vaccine_Slovenia_2020 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
all_weeks <- data.frame(YearWeekISO = sprintf("2020-W%02d", 1:53))
# Join the summarized data with the dataframe of all weeks
db_vaccine_Slovenia_2020 <- left_join(all_weeks, db_vaccine_Slovenia_2020, by = "YearWeekISO") %>%
  replace_na(list(FirstDose = 0, SecondDose = 0, Booster = 0))

# VARIANT 
data_variant_filter_Slovenia_2020 <- data_variant %>%
  filter(Location == "Slovenia", !is.na(Variant) & Variant != "", Collection_Date >= as.Date("2020-01-05") & Collection_Date <= as.Date("2021-01-03")) 
data_variant_filter_Slovenia_2020 <-select(data_variant_filter_Slovenia_2020,Collection_Date,Variant)
start_date_2020 <- as.Date("2020-01-05")  

# Group by  
data_grouped_variant_slovenia_2020 <- data_variant_filter_Slovenia_2020 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date_2020),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_slovenia_2020 <-  select(data_grouped_variant_slovenia_2020,-count)
  
data_Variant_Slovenia_2020 <- data_grouped_variant_slovenia_2020 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:53)
data_Variant_Slovenia_2020 <- data_Variant_Slovenia_2020 %>%distinct()
data_Variant_Slovenia_2020$week_number <- as.integer(data_Variant_Slovenia_2020$week_number)
data_Variant_Slovenia_2020 <- left_join(all_weeks, data_Variant_Slovenia_2020, by = "week_number")

# Standardize the data 
db_Slovenia_2020 <- db_Slovenia_2020 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
db_Slovenia_2020 <- db_Slovenia_2020 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

db_Slovenia_2020$Daily_ICU_occupancy <- (db_Slovenia_2020$Daily_ICU_occupancy / population_slovenia)*100000
db_Slovenia_2020$Daily_hospital_occupancy <- (db_Slovenia_2020$Daily_hospital_occupancy / population_slovenia)*100000
db_Slovenia_2020$cases <- (db_Slovenia_2020$cases / population_slovenia)*100000
db_Slovenia_2020$deaths <- (db_Slovenia_2020$deaths / population_slovenia)*100000

db_vaccine_Slovenia_2020$FirstDose <- (db_vaccine_Slovenia_2020$FirstDose / population_slovenia)*100000
db_vaccine_Slovenia_2020$SecondDose <- (db_vaccine_Slovenia_2020$SecondDose / population_slovenia)*100000
db_vaccine_Slovenia_2020$Booster <- (db_vaccine_Slovenia_2020$Booster / population_slovenia)*100000

# variant processing data 
max_expected_week_2020 <- max(data_Variant_Slovenia_2020$week_number)
missing_weeks_2020 <- setdiff(1:max_expected_week_2020, data_Variant_Slovenia_2020$week_number)

if (length(missing_weeks_2020) > 0) {
  if (identical(missing_weeks_2020, 1:length(missing_weeks_2020))) {
    for (week in missing_weeks_2020) {
      data_Variant_Slovenia_2020[data_Variant_Slovenia_2020$week_number == week, ] <- data_Variant_Slovenia_2020[data_Variant_Slovenia_2020$week_number == max(data_Variant_Slovenia_2020$week_number[data_Variant_Slovenia_2020$week_number < week]), ]
    }
  } else {
    existing_weeks <- intersect(1:max_expected_week_2020, data_Variant_Slovenia_2020$week_number)
    missing_between <- setdiff(existing_weeks + 1, data_Variant_Slovenia_2020$week_number)
    for (week in missing_between) {
      before <- data_Variant_Slovenia_2020[data_Variant_Slovenia_2020$week_number == max(data_Variant_Slovenia_2020$week_number[data_Variant_Slovenia_2020$week_number < week]), ]
      after <- data_Variant_Slovenia_2020[data_Variant_Slovenia_2020$week_number == min(data_Variant_Slovenia_2020$week_number[data_Variant_Slovenia_2020$week_number > week]), ]
      data_Variant_Slovenia_2020 <- rbind(data_Variant_Slovenia_2020, colMeans(rbind(before, after)))
    }
  }
}

```

# 2021
```{r setup, include=FALSE}
# For the year 2021
# STRINGENCY INDEX
date_start_2021 <- ymd("2021-01-04")
date_end_2021 <- ymd("2022-01-02")
# Define the date of start 
start_date_2021 <- as.Date("2021-01-04") 

Governement_stringecy_index_oxford_slovenia_2021 <- Governement_stringecy_index_oxford_slovenia %>% 
  filter(date >= date_start_2021 & date <= date_end_2021)

Governement_stringecy_index_oxford_slovenia_2021$date <- as.Date(Governement_stringecy_index_oxford_slovenia_2021$date)

Governement_stringecy_index_oxford_slovenia_2021 <- Governement_stringecy_index_oxford_slovenia_2021 %>%
  mutate(days_since_start = as.numeric(date - start_date_2021)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_slovenia_2021 <- Containement_health_index_oxford_slovenia %>% 
  filter(Day >= date_start_2021 & Day <= date_end_2021)

Containement_health_index_oxford_slovenia_2021$Day <- as.Date(Containement_health_index_oxford_slovenia_2021$Day)

Containement_health_index_oxford_slovenia_2021 <- Containement_health_index_oxford_slovenia_2021 %>%
  mutate(days_since_start = as.numeric(Day - start_date_2021)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# HOSPITAL
data_hospital_filtered_slovenia_2021 <- data_hospital_filtered_slovenia %>% 
  filter(date >= date_start_2021 & date <= date_end_2021)

## Grouping the file 
data_hospital_filtered_slovenia_2021$date <- as.Date(data_hospital_filtered_slovenia_2021$date)

# Group by  
data_grouped_hospital_slovenia_2021 <- data_hospital_filtered_slovenia_2021 %>%
  mutate(days_since_start = as.numeric(date - start_date_2021)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Slovenia_2021 <- data_grouped_hospital_slovenia_2021 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information)

# Create a dataframe with all week numbers from 1 to 52
all_weeks <- tibble(week_number = 1:52)

db_hospital_Slovenia_2021 <- all_weeks %>%
  left_join(db_hospital_Slovenia_2021, by = "week_number") %>%
  select(-country)

# DEATH
data_death_filtered_slovenia_2021 <- data_death_filtered_slovenia %>%
  filter(substr(year_week, 1, 4) == "2021")
# Data frame Cases and deaths 
db_death_Slovenia_2021 <- data_death_filtered_slovenia_2021 %>%
  select(-country, -country_code, -continent,-population,-rate_14_day, -cumulative_count ,-source,-note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Slovenia_2021 <- select(db_death_Slovenia_2021, -year_week)

db_Slovenia_2021 <- cbind(db_hospital_Slovenia_2021, db_death_Slovenia_2021)

# VACCINE 
data_vaccine_filtered_slovenia_2021 <- data_vaccine_filtered_slovenia %>%
  filter(substr(YearWeekISO, 1, 4) == "2021" & TargetGroup == "ALL")
# count Nan
missing_counts_slovenia_2021 <- data_vaccine_filtered_slovenia_2021 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_slovenia_2021 <- data_vaccine_filtered_slovenia_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

db_vaccine_Slovenia_2021 <- select(data_vaccine_filtered_slovenia_2021, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3,YearWeekISO)

db_vaccine_Slovenia_2021 <- db_vaccine_Slovenia_2021 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Slovenia_2021 <- db_vaccine_Slovenia_2021 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )

# VARIANT 
data_variant_filter_Slovenia_2021 <- data_variant %>%
  filter(Location == "Slovenia", !is.na(Variant) & Variant != "", Collection_Date >= as.Date("2021-01-04") & Collection_Date <= as.Date("2022-01-02")) 
data_variant_filter_Slovenia_2021 <-select(data_variant_filter_Slovenia_2021,Collection_Date,Variant)

# Group by  
data_grouped_variant_slovenia_2021 <- data_variant_filter_Slovenia_2021 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date_2021),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_slovenia_2021 <-  select(data_grouped_variant_slovenia_2021,-count)
  
data_Variant_Slovenia_2021 <- data_grouped_variant_slovenia_2021 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

data_Variant_Slovenia_2021 <- left_join(all_weeks, data_Variant_Slovenia_2021, by = "week_number")

# Standardize the data 
db_Slovenia_2021 <- db_Slovenia_2021 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
db_Slovenia_2021 <- db_Slovenia_2021 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

db_Slovenia_2021$Daily_ICU_occupancy <- (db_Slovenia_2021$Daily_ICU_occupancy / population_slovenia)*100000
db_Slovenia_2021$Daily_hospital_occupancy <- (db_Slovenia_2021$Daily_hospital_occupancy / population_slovenia)*100000
db_Slovenia_2021$cases <- (db_Slovenia_2021$cases / population_slovenia)*100000
db_Slovenia_2021$deaths <- (db_Slovenia_2021$deaths / population_slovenia)*100000

db_vaccine_Slovenia_2021$FirstDose <- (db_vaccine_Slovenia_2021$FirstDose / population_slovenia)*100000
db_vaccine_Slovenia_2021$SecondDose <- (db_vaccine_Slovenia_2021$SecondDose / population_slovenia)*100000
db_vaccine_Slovenia_2021$Booster <- (db_vaccine_Slovenia_2021$Booster / population_slovenia)*100000

# VARIANT PROCESSING
# Maximum expected week for the year
max_expected_week_2021 <- max(data_Variant_Slovenia_2021$week_number)

# Identify any missing weeks in the dataset
missing_weeks_2021 <- setdiff(1:max_expected_week_2021, data_Variant_Slovenia_2021$week_number)

# Fill in data for missing weeks
if (length(missing_weeks_2021) > 0) {
    if (identical(missing_weeks_2021, 1:length(missing_weeks_2021))) {
        for (week in missing_weeks_2021) {
            data_Variant_Slovenia_2021[data_Variant_Slovenia_2021$week_number == week, ] <- data_Variant_Slovenia_2021[data_Variant_Slovenia_2021$week_number == max(data_Variant_Slovenia_2021$week_number[data_Variant_Slovenia_2021$week_number < week]), ]
        }
    } else {
        existing_weeks_2021 <- intersect(1:max_expected_week_2021, data_Variant_Slovenia_2021$week_number)
        missing_between_2021 <- setdiff(existing_weeks_2021 + 1, data_Variant_Slovenia_2021$week_number)
        for (week in missing_between_2021) {
            before <- data_Variant_Slovenia_2021[data_Variant_Slovenia_2021$week_number == max(data_Variant_Slovenia_2021$week_number[data_Variant_Slovenia_2021$week_number < week]), ]
            after <- data_Variant_Slovenia_2021[data_Variant_Slovenia_2021$week_number == min(data_Variant_Slovenia_2021$week_number[data_Variant_Slovenia_2021$week_number > week]), ]
            data_Variant_Slovenia_2021 <- rbind(data_Variant_Slovenia_2021, colMeans(rbind(before, after), na.rm = TRUE))
        }
    }
}

```

# 2022

```{r setup, include=FALSE}

# For the year 2022
# STRINGENCY INDEX
date_start_2022 <- ymd("2022-01-03")
date_end_2022 <- ymd("2023-01-01")
# Define the date of start 
start_date_2022 <- as.Date("2022-01-03") 

Governement_stringecy_index_oxford_slovenia_2022 <- Governement_stringecy_index_oxford_slovenia %>% 
  filter(date >= date_start_2022 & date <= date_end_2022)

Governement_stringecy_index_oxford_slovenia_2022$date <- as.Date(Governement_stringecy_index_oxford_slovenia_2022$date)

Governement_stringecy_index_oxford_slovenia_2022 <- Governement_stringecy_index_oxford_slovenia_2022 %>%
  mutate(days_since_start = as.numeric(date - start_date_2022)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_slovenia_2022 <- Containement_health_index_oxford_slovenia %>% 
  filter(Day >= date_start_2022 & Day <= date_end_2022)

Containement_health_index_oxford_slovenia_2022$Day <- as.Date(Containement_health_index_oxford_slovenia_2022$Day)

Containement_health_index_oxford_slovenia_2022 <- Containement_health_index_oxford_slovenia_2022 %>%
  mutate(days_since_start = as.numeric(Day - start_date_2022)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# HOSPITAL
data_hospital_filtered_slovenia_2022 <- data_hospital_filtered_slovenia %>% 
  filter(date >= date_start_2022 & date <= date_end_2022)

## Grouping the file 
data_hospital_filtered_slovenia_2022$date <- as.Date(data_hospital_filtered_slovenia_2022$date)

# Group by  
data_grouped_hospital_slovenia_2022 <- data_hospital_filtered_slovenia_2022 %>%
  mutate(days_since_start = as.numeric(date - start_date_2022)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Slovenia_2022 <- data_grouped_hospital_slovenia_2022 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information)

db_hospital_Slovenia_2022 <- select(db_hospital_Slovenia_2022, -country, -week_number)

# Data Death
data_death_filtered_slovenia_2022 <- data_death_filtered_slovenia %>%
  filter(substr(year_week, 1, 4) == "2022")
# Data frame Cases and deaths 
db_death_Slovenia_2022 <- data_death_filtered_slovenia_2022 %>%
  select(-country, -country_code, -continent,-population,-rate_14_day, -cumulative_count ,-source,-note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Slovenia_2022 <- select(db_death_Slovenia_2022, -year_week)

db_Slovenia_2022 <- cbind(db_hospital_Slovenia_2022, db_death_Slovenia_2022)

# Data Vaccine 
data_vaccine_filtered_slovenia_2022 <- data_vaccine_filtered_slovenia %>%
  filter(substr(YearWeekISO, 1, 4) == "2022" & TargetGroup == "ALL")
# count Nan
missing_counts_slovenia_2022 <- data_vaccine_filtered_slovenia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_slovenia_2022 <- data_vaccine_filtered_slovenia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

db_vaccine_Slovenia_2022 <- select(data_vaccine_filtered_slovenia_2022, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3,YearWeekISO)

db_vaccine_Slovenia_2022 <- db_vaccine_Slovenia_2022 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Slovenia_2022 <- db_vaccine_Slovenia_2022 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
# Data Variant
data_variant_filter_Slovenia_2022 <- data_variant %>%
  filter(Location == "Slovenia", 
         !is.na(Variant) & Variant != "", 
         Collection_Date >= as.Date("2022-01-03") & Collection_Date <= as.Date("2023-01-01")) 
data_variant_filter_Slovenia_2022 <- select(data_variant_filter_Slovenia_2022,Collection_Date,Variant)
start_date_2022 <- as.Date("2022-01-03")  

# Group by  
data_grouped_variant_slovenia_2022 <- data_variant_filter_Slovenia_2022 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date_2022),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_slovenia_2022 <-  select(data_grouped_variant_slovenia_2022,-count)
  
data_Variant_Slovenia_2022 <- data_grouped_variant_slovenia_2022 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:52)
data_Variant_Slovenia_2022 <- data_Variant_Slovenia_2022 %>%distinct()
data_Variant_Slovenia_2022$week_number <- as.integer(data_Variant_Slovenia_2022$week_number)
data_Variant_Slovenia_2022 <- left_join(all_weeks, data_Variant_Slovenia_2022, by = "week_number")

# Standardize the data 
db_Slovenia_2022 <- db_Slovenia_2022 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
db_Slovenia_2022 <- db_Slovenia_2022 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

db_Slovenia_2022$Daily_ICU_occupancy <- (db_Slovenia_2022$Daily_ICU_occupancy / population_slovenia)*100000
db_Slovenia_2022$Daily_hospital_occupancy <- (db_Slovenia_2022$Daily_hospital_occupancy / population_slovenia)*100000
db_Slovenia_2022$cases <- (db_Slovenia_2022$cases / population_slovenia)*100000
db_Slovenia_2022$deaths <- (db_Slovenia_2022$deaths / population_slovenia)*100000

db_vaccine_Slovenia_2022$FirstDose <- (db_vaccine_Slovenia_2022$FirstDose / population_slovenia)*100000
db_vaccine_Slovenia_2022$SecondDose <- (db_vaccine_Slovenia_2022$SecondDose / population_slovenia)*100000
db_vaccine_Slovenia_2022$Booster <- (db_vaccine_Slovenia_2022$Booster / population_slovenia)*100000

# VARIANT PROCESSING
# Maximum expected week for the year
max_expected_week_2022 <- max(data_Variant_Slovenia_2022$week_number)

# Identify any missing weeks in the dataset
missing_weeks_2022 <- setdiff(1:max_expected_week_2022, data_Variant_Slovenia_2022$week_number)

# Fill in data for missing weeks
if (length(missing_weeks_2022) > 0) {
    if (identical(missing_weeks_2022, 1:length(missing_weeks_2022))) {
        for (week in missing_weeks_2022) {
            data_Variant_Slovenia_2022[data_Variant_Slovenia_2022$week_number == week, ] <- data_Variant_Slovenia_2022[data_Variant_Slovenia_2022$week_number == max(data_Variant_Slovenia_2022$week_number[data_Variant_Slovenia_2022$week_number < week]), ]
        }
    } else {
        existing_weeks_2022 <- intersect(1:max_expected_week_2022, data_Variant_Slovenia_2022$week_number)
        missing_between_2022 <- setdiff(existing_weeks_2022 + 1, data_Variant_Slovenia_2022$week_number)
        for (week in missing_between_2022) {
            before <- data_Variant_Slovenia_2022[data_Variant_Slovenia_2022$week_number == max(data_Variant_Slovenia_2022$week_number[data_Variant_Slovenia_2022$week_number < week]), ]
            after <- data_Variant_Slovenia_2022[data_Variant_Slovenia_2022$week_number == min(data_Variant_Slovenia_2022$week_number[data_Variant_Slovenia_2022$week_number > week]), ]
            data_Variant_Slovenia_2022 <- rbind(data_Variant_Slovenia_2022, colMeans(rbind(before, after), na.rm = TRUE))
        }
    }
}

```

# GREECE

```{r setup, include=FALSE}
selected_countries_greece <- c("Greece")

## LOAD DATA 
# HOSPITAL
data_hospital_filtered_greece <- data_hospital %>% 
  filter(country %in% selected_countries_greece)
data_hospital_filtered_greece$date <- parse_date_time(data_hospital_filtered_greece$date, orders = c("ymd", "ymd"))

## DEATH
data_death_filtered_greece <- data_death %>% 
  filter(country %in% selected_countries_greece)

# Obtain the population of the nation 
population_greece <- unique(data_death_filtered_greece$population)

# Data Vaccine 

# Filter with Nation of Interest 
selected_countries_greece_iso <- c("GR")  # ISO code for Greece
data_vaccine_filtered_greece <- data_vaccine %>% filter(ReportingCountry %in% selected_countries_greece_iso)

# Filter health_index_oxford
Containement_health_index_oxford_greece <- Containement_health_index_oxford %>% 
  filter(Entity %in% selected_countries_greece)
Containement_health_index_oxford_greece$Day <- parse_date_time(Containement_health_index_oxford_greece$Day, orders = c("ymd", "ymd"))

# Filter Government Index
Governement_stringecy_index_oxford_greece <- Governement_stringecy_index_oxford %>% 
  filter(location %in% selected_countries_greece)
Governement_stringecy_index_oxford_greece$date <- parse_date_time(Governement_stringecy_index_oxford_greece$date, orders = c("ymd", "ymd"))
```

# 2020

``` {r setup, include=FALSE}
# For the year 2020
# STRINGENCY INDEX
date_start_2020 <- ymd("2020-01-05")
date_end_2020 <- ymd("2021-01-03")
# Define the date of start 
start_date_2020 <- as.Date("2020-01-05") 

Governement_stringecy_index_oxford_greece_2020 <- Governement_stringecy_index_oxford_greece %>% 
  filter(date >= date_start_2020 & date <= date_end_2020)

Governement_stringecy_index_oxford_greece_2020$date <- as.Date(Governement_stringecy_index_oxford_greece_2020$date)

Governement_stringecy_index_oxford_greece_2020 <- Governement_stringecy_index_oxford_greece_2020 %>%
  mutate(days_since_start = as.numeric(date - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_greece_2020 <- Containement_health_index_oxford_greece %>% 
  filter(Day >= date_start_2020 & Day <= date_end_2020)

Containement_health_index_oxford_greece_2020$Day <- as.Date(Containement_health_index_oxford_greece_2020$Day)

Containement_health_index_oxford_greece_2020 <- Containement_health_index_oxford_greece_2020 %>%
  mutate(days_since_start = as.numeric(Day - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# HOSPITAL
data_hospital_filtered_greece_2020 <- data_hospital_filtered_greece %>% 
  filter(date >= date_start_2020 & date <= date_end_2020)

## Grouping the file 
data_hospital_filtered_greece_2020$date <- as.Date(data_hospital_filtered_greece_2020$date)

# Group by  
data_grouped_hospital_greece_2020 <- data_hospital_filtered_greece_2020 %>%
  mutate(days_since_start = as.numeric(date - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Greece_2020 <- data_grouped_hospital_greece_2020 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information) %>%
  arrange(week_number)

# Create a dataframe with all week numbers from 1 to 53
all_weeks <- tibble(week_number = 1:53)

db_hospital_Greece_2020 <- all_weeks %>%
  left_join(db_hospital_Greece_2020, by = "week_number") %>%
  select(-country)

# DEATH
data_death_filtered_greece_2020 <- data_death_filtered_greece %>%
  filter(substr(year_week, 1, 4) == "2020")
# Data frame Cases and deaths 
db_death_Greece_2020 <- data_death_filtered_greece_2020 %>%
  select(-country, -country_code, -continent,-population,-rate_14_day, -cumulative_count ,-source,-note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Greece_2020 <- select(db_death_Greece_2020, -year_week)

db_Greece_2020 <- cbind(db_hospital_Greece_2020, db_death_Greece_2020)

# VACCINE 

# Filter data for the year 2020 and for not creating so much covariates I decide to maintain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_greece_2020 <- data_vaccine_filtered_greece %>%
  filter(substr(YearWeekISO, 1, 4) == "2020" & TargetGroup == "ALL")
# count Nan
missing_counts_greece_2020 <- data_vaccine_filtered_greece_2020 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_greece_2020 <- data_vaccine_filtered_greece_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

db_vaccine_Greece_2020 <- select(data_vaccine_filtered_greece_2020, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3,YearWeekISO)

db_vaccine_Greece_2020 <- db_vaccine_Greece_2020 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Greece_2020 <- db_vaccine_Greece_2020 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
all_weeks <- data.frame(YearWeekISO = sprintf("2020-W%02d", 1:53))
# Unisci i dati riassunti con il dataframe di tutte le settimane
db_vaccine_Greece_2020 <- left_join(all_weeks, db_vaccine_Greece_2020, by = "YearWeekISO") %>%
  replace_na(list(FirstDose = 0, SecondDose = 0, Booster = 0))

# VARIANT 
data_variant_filter_Greece_2020 <- data_variant %>%
  filter(Location == "Greece", !is.na(Variant) & Variant != "", Collection_Date >= as.Date("2020-01-05") & Collection_Date <= as.Date("2021-01-03")) 
data_variant_filter_Greece_2020 <-select(data_variant_filter_Greece_2020,Collection_Date,Variant)
start_date_2020 <- as.Date("2020-01-05")  

# Group by  
data_grouped_variant_greece_2020 <- data_variant_filter_Greece_2020 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date_2020),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_greece_2020 <-  select(data_grouped_variant_greece_2020,-count)
  
data_Variant_Greece_2020 <- data_grouped_variant_greece_2020 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:53)
data_Variant_Greece_2020 <- data_Variant_Greece_2020 %>%distinct()
data_Variant_Greece_2020$week_number <- as.integer(data_Variant_Greece_2020$week_number)
data_Variant_Greece_2020 <- left_join(all_weeks, data_Variant_Greece_2020, by = "week_number")

# Standardize the data 
#db_Greece_2020 <- db_Greece_2020 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
#db_Greece_2020 <- db_Greece_2020 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

#db_Greece_2020$Daily_ICU_occupancy <- (db_Greece_2020$Daily_ICU_occupancy / population_greece)*100000
#db_Greece_2020$Daily_hospital_occupancy <- (db_Greece_2020$Daily_hospital_occupancy / population_greece)*100000
db_Greece_2020$cases <- (db_Greece_2020$cases / population_greece)*100000
db_Greece_2020$deaths <- (db_Greece_2020$deaths / population_greece)*100000

db_vaccine_Greece_2020$FirstDose <- (db_vaccine_Greece_2020$FirstDose / population_greece)*100000
db_vaccine_Greece_2020$SecondDose <- (db_vaccine_Greece_2020$SecondDose / population_greece)*100000
db_vaccine_Greece_2020$Booster <- (db_vaccine_Greece_2020$Booster / population_greece)*100000

# variant processing data 
max_expected_week_2020 <- max(data_Variant_Greece_2020$week_number)
missing_weeks_2020 <- setdiff(1:max_expected_week_2020, data_Variant_Greece_2020$week_number)

if (length(missing_weeks_2020) > 0) {
  if (identical(missing_weeks_2020, 1:length(missing_weeks_2020))) {
    for (week in missing_weeks_2020) {
      data_Variant_Greece_2020[data_Variant_Greece_2020$week_number == week, ] <- data_Variant_Greece_2020[data_Variant_Greece_2020$week_number == max(data_Variant_Greece_2020$week_number[data_Variant_Greece_2020$week_number < week]), ]
    }
  } else {
    existing_weeks <- intersect(1:max_expected_week_2020, data_Variant_Greece_2020$week_number)
    missing_between <- setdiff(existing_weeks + 1, data_Variant_Greece_2020$week_number)
    for (week in missing_between) {
      before <- data_Variant_Greece_2020[data_Variant_Greece_2020$week_number == max(data_Variant_Greece_2020$week_number[data_Variant_Greece_2020$week_number < week]), ]
      after <- data_Variant_Greece_2020[data_Variant_Greece_2020$week_number == min(data_Variant_Greece_2020$week_number[data_Variant_Greece_2020$week_number > week]), ]
      data_Variant_Greece_2020 <- rbind(data_Variant_Greece_2020, colMeans(rbind(before, after)))
    }
  }
}
```

# 2021

```{r setup, include=FALSE}
# STRINGENCY INDEX
date_start_2021 <- ymd("2021-01-04")
date_end_2021 <- ymd("2022-01-02")
# Define the date of start 
start_date_2021 <- as.Date("2021-01-04")  

Governement_stringecy_index_oxford_greece_2021 <- Governement_stringecy_index_oxford_greece %>% 
  filter(date >= date_start_2021 & date <= date_end_2021)

Governement_stringecy_index_oxford_greece_2021$date <- as.Date(Governement_stringecy_index_oxford_greece_2021$date)

Governement_stringecy_index_oxford_greece_2021 <- Governement_stringecy_index_oxford_greece_2021 %>%
  mutate(days_since_start = as.numeric(date - start_date_2021)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_greece_2021 <- Containement_health_index_oxford_greece %>% 
  filter(Day >= date_start_2021 & Day <= date_end_2021)

Containement_health_index_oxford_greece_2021$Day <- as.Date(Containement_health_index_oxford_greece_2021$Day)

Containement_health_index_oxford_greece_2021 <- Containement_health_index_oxford_greece_2021 %>%
  mutate(days_since_start = as.numeric(Day - start_date_2021)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# HOSPITAL
data_hospital_filtered_greece_2021 <- data_hospital_filtered_greece %>% 
  filter(date >= date_start_2021 & date <= date_end_2021)

## Grouping the file 
data_hospital_filtered_greece_2021$date <- as.Date(data_hospital_filtered_greece_2021$date)

# Group by  
data_grouped_hospital_greece_2021 <- data_hospital_filtered_greece_2021 %>%
  mutate(days_since_start = as.numeric(date - start_date_2021)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Greece_2021 <- data_grouped_hospital_greece_2021 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information) %>%
  arrange(week_number)

# Create a dataframe with all week numbers from 1 to 52
all_weeks <- tibble(week_number = 1:52)

db_hospital_Greece_2021 <- all_weeks %>%
  left_join(db_hospital_Greece_2021, by = "week_number") %>%
  select(-country)

# DEATH
data_death_filtered_greece_2021 <- data_death_filtered_greece %>%
  filter(substr(year_week, 1, 4) == "2021")
# Data frame Cases and deaths 
db_death_Greece_2021 <- data_death_filtered_greece_2021 %>%
  select(-country, -country_code, -continent,-population,-rate_14_day, -cumulative_count ,-source,-note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Greece_2021 <- select(db_death_Greece_2021, -year_week)

db_Greece_2021 <- cbind(db_hospital_Greece_2021, db_death_Greece_2021)

# VACCINE 

# Filter data for the year 2021 and for not creating so much covariates I decide to maintain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_greece_2021 <- data_vaccine_filtered_greece %>%
  filter(substr(YearWeekISO, 1, 4) == "2021" & TargetGroup == "ALL")
# count Nan
missing_counts_greece_2021 <- data_vaccine_filtered_greece_2021 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_greece_2021 <- data_vaccine_filtered_greece_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

db_vaccine_Greece_2021 <- select(data_vaccine_filtered_greece_2021, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3,YearWeekISO)

db_vaccine_Greece_2021 <- db_vaccine_Greece_2021 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Greece_2021 <- db_vaccine_Greece_2021 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
all_weeks <- data.frame(YearWeekISO = sprintf("2021-W%02d", 1:52))
# Unisci i dati riassunti con il dataframe di tutte le settimane
db_vaccine_Greece_2021 <- left_join(all_weeks, db_vaccine_Greece_2021, by = "YearWeekISO") %>%
  replace_na(list(FirstDose = 0, SecondDose = 0, Booster = 0))

# VARIANT 
data_variant_filter_Greece_2021 <- data_variant %>%
  filter(Location == "Greece", !is.na(Variant) & Variant != "", Collection_Date >= as.Date("2021-01-04") & Collection_Date <= as.Date("2022-01-02")) 
data_variant_filter_Greece_2021 <-select(data_variant_filter_Greece_2021,Collection_Date,Variant)
start_date_2021 <- as.Date("2021-01-04")  

# Group by  
data_grouped_variant_greece_2021 <- data_variant_filter_Greece_2021 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date_2021),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_greece_2021 <-  select(data_grouped_variant_greece_2021,-count)
  
data_Variant_Greece_2021 <- data_grouped_variant_greece_2021 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:52)
data_Variant_Greece_2021 <- data_Variant_Greece_2021 %>%distinct()
data_Variant_Greece_2021$week_number <- as.integer(data_Variant_Greece_2021$week_number)
data_Variant_Greece_2021 <- left_join(all_weeks, data_Variant_Greece_2021, by = "week_number")

# Standardize the data 
#db_Greece_2021 <- db_Greece_2021 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
#db_Greece_2021 <- db_Greece_2021 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

#db_Greece_2021$Daily_ICU_occupancy <- (db_Greece_2021$Daily_ICU_occupancy / population_greece)*100000
#db_Greece_2021$Daily_hospital_occupancy <- (db_Greece_2021$Daily_hospital_occupancy / population_greece)*100000
db_Greece_2021$cases <- (db_Greece_2021$cases / population_greece)*100000
db_Greece_2021$deaths <- (db_Greece_2021$deaths / population_greece)*100000

db_vaccine_Greece_2021$FirstDose <- (db_vaccine_Greece_2021$FirstDose / population_greece)*100000
db_vaccine_Greece_2021$SecondDose <- (db_vaccine_Greece_2021$SecondDose / population_greece)*100000
db_vaccine_Greece_2021$Booster <- (db_vaccine_Greece_2021$Booster / population_greece)*100000

# variant processing data 
max_expected_week_2021 <- max(data_Variant_Greece_2021$week_number)
missing_weeks_2021 <- setdiff(1:max_expected_week_2021, data_Variant_Greece_2021$week_number)

if (length(missing_weeks_2021) > 0) {
  if (identical(missing_weeks_2021, 1:length(missing_weeks_2021))) {
    for (week in missing_weeks_2021) {
      data_Variant_Greece_2021[data_Variant_Greece_2021$week_number == week, ] <- data_Variant_Greece_2021[data_Variant_Greece_2021$week_number == max(data_Variant_Greece_2021$week_number[data_Variant_Greece_2021$week_number < week]), ]
    }
  } else {
    existing_weeks <- intersect(1:max_expected_week_2021, data_Variant_Greece_2021$week_number)
    missing_between <- setdiff(existing_weeks + 1, data_Variant_Greece_2021$week_number)
    for (week in missing_between) {
      before <- data_Variant_Greece_2021[data_Variant_Greece_2021$week_number == max(data_Variant_Greece_2021$week_number[data_Variant_Greece_2021$week_number < week]), ]
      after <- data_Variant_Greece_2021[data_Variant_Greece_2021$week_number == min(data_Variant_Greece_2021$week_number[data_Variant_Greece_2021$week_number > week]), ]
      data_Variant_Greece_2021 <- rbind(data_Variant_Greece_2021, colMeans(rbind(before, after)))
    }
  }
}

```

# 2022

```{r setup, include=FALSE}
# STRINGENCY INDEX
date_start_2022 <- ymd("2022-01-03")
date_end_2022 <- ymd("2023-01-01")
# Define the date of start 
start_date_2022 <- as.Date("2022-01-03")  

Governement_stringecy_index_oxford_greece_2022 <- Governement_stringecy_index_oxford_greece %>% 
  filter(date >= date_start_2022 & date <= date_end_2022)

Governement_stringecy_index_oxford_greece_2022$date <- as.Date(Governement_stringecy_index_oxford_greece_2022$date)

Governement_stringecy_index_oxford_greece_2022 <- Governement_stringecy_index_oxford_greece_2022 %>%
  mutate(days_since_start = as.numeric(date - start_date_2022)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_greece_2022 <- Containement_health_index_oxford_greece %>% 
  filter(Day >= date_start_2022 & Day <= date_end_2022)

Containement_health_index_oxford_greece_2022$Day <- as.Date(Containement_health_index_oxford_greece_2022$Day)

Containement_health_index_oxford_greece_2022 <- Containement_health_index_oxford_greece_2022 %>%
  mutate(days_since_start = as.numeric(Day - start_date_2022)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# HOSPITAL
data_hospital_filtered_greece_2022 <- data_hospital_filtered_greece %>% 
  filter(date >= date_start_2022 & date <= date_end_2022)

## Grouping the file 
data_hospital_filtered_greece_2022$date <- as.Date(data_hospital_filtered_greece_2022$date)

# Group by  
data_grouped_hospital_greece_2022 <- data_hospital_filtered_greece_2022 %>%
  mutate(days_since_start = as.numeric(date - start_date_2022)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Greece_2022 <- data_grouped_hospital_greece_2022 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information) %>%
  arrange(week_number)

# Create a dataframe with all week numbers from 1 to 52
all_weeks <- tibble(week_number = 1:52)

db_hospital_Greece_2022 <- all_weeks %>%
  left_join(db_hospital_Greece_2022, by = "week_number") %>%
  select(-country)

# DEATH
data_death_filtered_greece_2022 <- data_death_filtered_greece %>%
  filter(substr(year_week, 1, 4) == "2022")
# Data frame Cases and deaths 
db_death_Greece_2022 <- data_death_filtered_greece_2022 %>%
  select(-country, -country_code, -continent,-population,-rate_14_day, -cumulative_count ,-source,-note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Greece_2022 <- select(db_death_Greece_2022, -year_week)

db_Greece_2022 <- cbind(db_hospital_Greece_2022, db_death_Greece_2022)

# VACCINE 

# Filter data for the year 2022 and for not creating so much covariates I decide to maintain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_greece_2022 <- data_vaccine_filtered_greece %>%
  filter(substr(YearWeekISO, 1, 4) == "2022" & TargetGroup == "ALL")
# count Nan
missing_counts_greece_2022 <- data_vaccine_filtered_greece_2022 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_greece_2022 <- data_vaccine_filtered_greece_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

db_vaccine_Greece_2022 <- select(data_vaccine_filtered_greece_2022, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3,YearWeekISO)

db_vaccine_Greece_2022 <- db_vaccine_Greece_2022 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Greece_2022 <- db_vaccine_Greece_2022 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
all_weeks <- data.frame(YearWeekISO = sprintf("2022-W%02d", 1:52))
# Unisci i dati riassunti con il dataframe di tutte le settimane
db_vaccine_Greece_2022 <- left_join(all_weeks, db_vaccine_Greece_2022, by = "YearWeekISO") %>%
  replace_na(list(FirstDose = 0, SecondDose = 0, Booster = 0))

# VARIANT 
data_variant_filter_Greece_2022 <- data_variant %>%
  filter(Location == "Greece", !is.na(Variant) & Variant != "", Collection_Date >= as.Date("2022-01-03") & Collection_Date <= as.Date("2023-01-01")) 
data_variant_filter_Greece_2022 <-select(data_variant_filter_Greece_2022,Collection_Date,Variant)
start_date_2022 <- as.Date("2022-01-03")  

# Group by  
data_grouped_variant_greece_2022 <- data_variant_filter_Greece_2022 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date_2022),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_greece_2022 <-  select(data_grouped_variant_greece_2022,-count)
  
data_Variant_Greece_2022 <- data_grouped_variant_greece_2022 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:52)
data_Variant_Greece_2022 <- data_Variant_Greece_2022 %>%distinct()
data_Variant_Greece_2022$week_number <- as.integer(data_Variant_Greece_2022$week_number)
data_Variant_Greece_2022 <- left_join(all_weeks, data_Variant_Greece_2022, by = "week_number")

# Standardize the data 
#db_Greece_2022 <- db_Greece_2022 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
#db_Greece_2022 <- db_Greece_2022 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

#db_Greece_2022$Daily_ICU_occupancy <- (db_Greece_2022$Daily_ICU_occupancy / population_greece)*100000
#db_Greece_2022$Daily_hospital_occupancy <- (db_Greece_2022$Daily_hospital_occupancy / population_greece)*100000
db_Greece_2022$cases <- (db_Greece_2022$cases / population_greece)*100000
db_Greece_2022$deaths <- (db_Greece_2022$deaths / population_greece)*100000

db_vaccine_Greece_2022$FirstDose <- (db_vaccine_Greece_2022$FirstDose / population_greece)*100000
db_vaccine_Greece_2022$SecondDose <- (db_vaccine_Greece_2022$SecondDose / population_greece)*100000
db_vaccine_Greece_2022$Booster <- (db_vaccine_Greece_2022$Booster / population_greece)*100000

# variant processing data 
max_expected_week_2022 <- max(data_Variant_Greece_2022$week_number)
missing_weeks_2022 <- setdiff(1:max_expected_week_2022, data_Variant_Greece_2022$week_number)

if (length(missing_weeks_2022) > 0) {
  if (identical(missing_weeks_2022, 1:length(missing_weeks_2022))) {
    for (week in missing_weeks_2022) {
      data_Variant_Greece_2022[data_Variant_Greece_2022$week_number == week, ] <- data_Variant_Greece_2022[data_Variant_Greece_2022$week_number == max(data_Variant_Greece_2022$week_number[data_Variant_Greece_2022$week_number < week]), ]
    }
  } else {
    existing_weeks <- intersect(1:max_expected_week_2022, data_Variant_Greece_2022$week_number)
    missing_between <- setdiff(existing_weeks + 1, data_Variant_Greece_2022$week_number)
    for (week in missing_between) {
      before <- data_Variant_Greece_2022[data_Variant_Greece_2022$week_number == max(data_Variant_Greece_2022$week_number[data_Variant_Greece_2022$week_number < week]), ]
      after <- data_Variant_Greece_2022[data_Variant_Greece_2022$week_number == min(data_Variant_Greece_2022$week_number[data_Variant_Greece_2022$week_number > week]), ]
      data_Variant_Greece_2022 <- rbind(data_Variant_Greece_2022, colMeans(rbind(before, after)))
    }
  }
}

```

# IRELAND
```{r setup, include=FALSE}
selected_countries_ireland <- c("Ireland")

## LOAD DATA 
# HOSPITAL
data_hospital_filtered_ireland <- data_hospital %>% 
  filter(country %in% selected_countries_ireland)
data_hospital_filtered_ireland$date <- parse_date_time(data_hospital_filtered_ireland$date, orders = c("ymd", "ymd"))

## DEATH
data_death_filtered_ireland <- data_death %>% 
  filter(country %in% selected_countries_ireland)

# Obtain the population of the nation 
population_ireland <- unique(data_death_filtered_ireland$population)

# Data Vaccine 

# Filter with Nation of Interest 
selected_countries_ireland_iso <- c("IE")  # ISO code for Ireland
data_vaccine_filtered_ireland <- data_vaccine %>% filter(ReportingCountry %in% selected_countries_ireland_iso)

# Filter health_index_oxford
Containement_health_index_oxford_ireland <- Containement_health_index_oxford %>% 
  filter(Entity %in% selected_countries_ireland)
Containement_health_index_oxford_ireland$Day <- parse_date_time(Containement_health_index_oxford_ireland$Day, orders = c("ymd", "ymd"))

# Filter Government Index
Governement_stringecy_index_oxford_ireland <- Governement_stringecy_index_oxford %>% 
  filter(location %in% selected_countries_ireland)
Governement_stringecy_index_oxford_ireland$date <- parse_date_time(Governement_stringecy_index_oxford_ireland$date, orders = c("ymd", "ymd"))

```

# 2020

```{r setup, include=FALSE}
# STRINGENCY INDEX
date_start_2020 <- ymd("2020-01-05")
date_end_2020 <- ymd("2021-01-03")
# Define the date of start 
start_date_2020 <- as.Date("2020-01-05")  

Governement_stringecy_index_oxford_ireland_2020 <- Governement_stringecy_index_oxford_ireland %>% 
  filter(date >= date_start_2020 & date <= date_end_2020)

Governement_stringecy_index_oxford_ireland_2020$date <- as.Date(Governement_stringecy_index_oxford_ireland_2020$date)

Governement_stringecy_index_oxford_ireland_2020 <- Governement_stringecy_index_oxford_ireland_2020 %>%
  mutate(days_since_start = as.numeric(date - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_ireland_2020 <- Containement_health_index_oxford_ireland %>% 
  filter(Day >= date_start_2020 & Day <= date_end_2020)

Containement_health_index_oxford_ireland_2020$Day <- as.Date(Containement_health_index_oxford_ireland_2020$Day)

Containement_health_index_oxford_ireland_2020 <- Containement_health_index_oxford_ireland_2020 %>%
  mutate(days_since_start = as.numeric(Day - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# HOSPITAL
data_hospital_filtered_ireland_2020 <- data_hospital_filtered_ireland %>% 
  filter(date >= date_start_2020 & date <= date_end_2020)

## Grouping the file 
data_hospital_filtered_ireland_2020$date <- as.Date(data_hospital_filtered_ireland_2020$date)

# Group by  
data_grouped_hospital_ireland_2020 <- data_hospital_filtered_ireland_2020 %>%
  mutate(days_since_start = as.numeric(date - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Ireland_2020 <- data_grouped_hospital_ireland_2020 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information) %>%
  arrange(week_number)

# Create a dataframe with all week numbers from 1 to 53
all_weeks <- tibble(week_number = 1:53)

db_hospital_Ireland_2020 <- all_weeks %>%
  left_join(db_hospital_Ireland_2020, by = "week_number") %>%
  select(-country)

# DEATH
data_death_filtered_ireland_2020 <- data_death_filtered_ireland %>%
  filter(substr(year_week, 1, 4) == "2020")
# Data frame Cases and deaths 
db_death_Ireland_2020 <- data_death_filtered_ireland_2020 %>%
  select(-country, -country_code, -continent,-population,-rate_14_day, -cumulative_count ,-source,-note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Ireland_2020 <- select(db_death_Ireland_2020, -year_week)

db_Ireland_2020 <- cbind(db_hospital_Ireland_2020, db_death_Ireland_2020)

# VACCINE 

# Filter data for the year 2020 and for not creating so many covariates I decide to maintain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_ireland_2020 <- data_vaccine_filtered_ireland %>%
  filter(substr(YearWeekISO, 1, 4) == "2020" & TargetGroup == "ALL")
# count Nan
missing_counts_ireland_2020 <- data_vaccine_filtered_ireland_2020 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_ireland_2020 <- data_vaccine_filtered_ireland_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

db_vaccine_Ireland_2020 <- select(data_vaccine_filtered_ireland_2020, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3,YearWeekISO)

db_vaccine_Ireland_2020 <- db_vaccine_Ireland_2020 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Ireland_2020 <- db_vaccine_Ireland_2020 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
all_weeks <- data.frame(YearWeekISO = sprintf("2020-W%02d", 1:53))
# Merge the summarized data with the dataframe of all weeks
db_vaccine_Ireland_2020 <- left_join(all_weeks, db_vaccine_Ireland_2020, by = "YearWeekISO") %>%
  replace_na(list(FirstDose = 0, SecondDose = 0, Booster = 0))

# VARIANT 
data_variant_filter_Ireland_2020 <- data_variant %>%
  filter(Location == "Ireland", !is.na(Variant) & Variant != "", Collection_Date >= as.Date("2020-01-05") & Collection_Date <= as.Date("2021-01-03")) 
data_variant_filter_Ireland_2020 <- select(data_variant_filter_Ireland_2020, Collection_Date, Variant)
start_date_2020 <- as.Date("2020-01-05")  

# Group by  
data_grouped_variant_ireland_2020 <- data_variant_filter_Ireland_2020 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date_2020),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_ireland_2020 <- select(data_grouped_variant_ireland_2020, -count)
  
data_Variant_Ireland_2020 <- data_grouped_variant_ireland_2020 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:53)
data_Variant_Ireland_2020 <- data_Variant_Ireland_2020 %>%distinct()
data_Variant_Ireland_2020$week_number <- as.integer(data_Variant_Ireland_2020$week_number)
data_Variant_Ireland_2020 <- left_join(all_weeks, data_Variant_Ireland_2020, by = "week_number")

# Standardize the data 
#db_Ireland_2020 <- db_Ireland_2020 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
db_Ireland_2020 <- db_Ireland_2020 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

#db_Ireland_2020$Daily_ICU_occupancy <- (db_Ireland_2020$Daily_ICU_occupancy / population_ireland)*100000
db_Ireland_2020$Daily_hospital_occupancy <- (db_Ireland_2020$Daily_hospital_occupancy / population_ireland)*100000
db_Ireland_2020$cases <- (db_Ireland_2020$cases / population_ireland)*100000
db_Ireland_2020$deaths <- (db_Ireland_2020$deaths / population_ireland)*100000

db_vaccine_Ireland_2020$FirstDose <- (db_vaccine_Ireland_2020$FirstDose / population_ireland)*100000
db_vaccine_Ireland_2020$SecondDose <- (db_vaccine_Ireland_2020$SecondDose / population_ireland)*100000
db_vaccine_Ireland_2020$Booster <- (db_vaccine_Ireland_2020$Booster / population_ireland)*100000

# Variant processing data 
max_expected_week_2020 <- max(data_Variant_Ireland_2020$week_number)
missing_weeks_2020 <- setdiff(1:max_expected_week_2020, data_Variant_Ireland_2020$week_number)

if (length(missing_weeks_2020) > 0) {
  if (identical(missing_weeks_2020, 1:length(missing_weeks_2020))) {
    for (week in missing_weeks_2020) {
      data_Variant_Ireland_2020[data_Variant_Ireland_2020$week_number == week, ] <- data_Variant_Ireland_2020[data_Variant_Ireland_2020$week_number == max(data_Variant_Ireland_2020$week_number[data_Variant_Ireland_2020$week_number < week]), ]
    }
  } else {
    existing_weeks <- intersect(1:max_expected_week_2020, data_Variant_Ireland_2020$week_number)
    missing_between <- setdiff(existing_weeks + 1, data_Variant_Ireland_2020$week_number)
    for (week in missing_between) {
      before <- data_Variant_Ireland_2020[data_Variant_Ireland_2020$week_number == max(data_Variant_Ireland_2020$week_number[data_Variant_Ireland_2020$week_number < week]), ]
      after <- data_Variant_Ireland_2020[data_Variant_Ireland_2020$week_number == min(data_Variant_Ireland_2020$week_number[data_Variant_Ireland_2020$week_number > week]), ]
      data_Variant_Ireland_2020 <- rbind(data_Variant_Ireland_2020, colMeans(rbind(before, after)))
    }
  }
}

```

# 2021

```{r setup, include=FALSE}
# STRINGENCY INDEX
date_start_2021 <- ymd("2021-01-04")
date_end_2021 <- ymd("2022-01-02")
# Define the date of start 
start_date_2021 <- as.Date("2021-01-04")  

Governement_stringecy_index_oxford_ireland_2021 <- Governement_stringecy_index_oxford_ireland %>% 
  filter(date >= date_start_2021 & date <= date_end_2021)

Governement_stringecy_index_oxford_ireland_2021$date <- as.Date(Governement_stringecy_index_oxford_ireland_2021$date)

Governement_stringecy_index_oxford_ireland_2021 <- Governement_stringecy_index_oxford_ireland_2021 %>%
  mutate(days_since_start = as.numeric(date - start_date_2021)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_ireland_2021 <- Containement_health_index_oxford_ireland %>% 
  filter(Day >= date_start_2021 & Day <= date_end_2021)

Containement_health_index_oxford_ireland_2021$Day <- as.Date(Containement_health_index_oxford_ireland_2021$Day)

Containement_health_index_oxford_ireland_2021 <- Containement_health_index_oxford_ireland_2021 %>%
  mutate(days_since_start = as.numeric(Day - start_date_2021)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# HOSPITAL
data_hospital_filtered_ireland_2021 <- data_hospital_filtered_ireland %>% 
  filter(date >= date_start_2021 & date <= date_end_2021)

## Grouping the file 
data_hospital_filtered_ireland_2021$date <- as.Date(data_hospital_filtered_ireland_2021$date)

# Group by  
data_grouped_hospital_ireland_2021 <- data_hospital_filtered_ireland_2021 %>%
  mutate(days_since_start = as.numeric(date - start_date_2021)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Ireland_2021 <- data_grouped_hospital_ireland_2021 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information) %>%
  arrange(week_number)

# Create a dataframe with all week numbers from 1 to 52
all_weeks <- tibble(week_number = 1:52)

db_hospital_Ireland_2021 <- all_weeks %>%
  left_join(db_hospital_Ireland_2021, by = "week_number") %>%
  select(-country)

# DEATH
data_death_filtered_ireland_2021 <- data_death_filtered_ireland %>%
  filter(substr(year_week, 1, 4) == "2021")
# Data frame Cases and deaths 
db_death_Ireland_2021 <- data_death_filtered_ireland_2021 %>%
  select(-country, -country_code, -continent, -population, -rate_14_day, -cumulative_count, -source, -note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Ireland_2021 <- select(db_death_Ireland_2021, -year_week)

db_Ireland_2021 <- cbind(db_hospital_Ireland_2021, db_death_Ireland_2021)

# VACCINE 
# Filter data for the year 2021 and for not creating so many covariates I decide to maintain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_ireland_2021 <- data_vaccine_filtered_ireland %>%
  filter(substr(YearWeekISO, 1, 4) == "2021" & TargetGroup == "ALL")
# count Nan
missing_counts_ireland_2021 <- data_vaccine_filtered_ireland_2021 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_ireland_2021 <- data_vaccine_filtered_ireland_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

db_vaccine_Ireland_2021 <- select(data_vaccine_filtered_ireland_2021, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3, YearWeekISO)

db_vaccine_Ireland_2021 <- db_vaccine_Ireland_2021 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Ireland_2021 <- db_vaccine_Ireland_2021 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
all_weeks <- data.frame(YearWeekISO = sprintf("2021-W%02d", 1:52))
# Merge the summarized data with the dataframe of all weeks
db_vaccine_Ireland_2021 <- left_join(all_weeks, db_vaccine_Ireland_2021, by = "YearWeekISO") %>%
  replace_na(list(FirstDose = 0, SecondDose = 0, Booster = 0))

# VARIANT 
data_variant_filter_Ireland_2021 <- data_variant %>%
  filter(Location == "Ireland", !is.na(Variant) & Variant != "", Collection_Date >= as.Date("2021-01-04") & Collection_Date <= as.Date("2022-01-02")) 
data_variant_filter_Ireland_2021 <- select(data_variant_filter_Ireland_2021, Collection_Date, Variant)
start_date_2021 <- as.Date("2021-01-04")  

# Group by  
data_grouped_variant_ireland_2021 <- data_variant_filter_Ireland_2021 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date_2021),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_ireland_2021 <- select(data_grouped_variant_ireland_2021, -count)
  
data_Variant_Ireland_2021 <- data_grouped_variant_ireland_2021 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:52)
data_Variant_Ireland_2021 <- data_Variant_Ireland_2021 %>%distinct()
data_Variant_Ireland_2021$week_number <- as.integer(data_Variant_Ireland_2021$week_number)
data_Variant_Ireland_2021 <- left_join(all_weeks, data_Variant_Ireland_2021, by = "week_number")

# Standardize the data 
#db_Ireland_2021 <- db_Ireland_2021 %>% rename('Daily_ICU_occupancy' = 'Daily ICU occupancy')
db_Ireland_2021 <- db_Ireland_2021 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

#db_Ireland_2021$Daily_ICU_occupancy <- (db_Ireland_2021$Daily_ICU_occupancy / population_ireland) * 100000
db_Ireland_2021$Daily_hospital_occupancy <- (db_Ireland_2021$Daily_hospital_occupancy / population_ireland) * 100000
db_Ireland_2021$cases <- (db_Ireland_2021$cases / population_ireland) * 100000
db_Ireland_2021$deaths <- (db_Ireland_2021$deaths / population_ireland) * 100000

db_vaccine_Ireland_2021$FirstDose <- (db_vaccine_Ireland_2021$FirstDose / population_ireland) * 100000
db_vaccine_Ireland_2021$SecondDose <- (db_vaccine_Ireland_2021$SecondDose / population_ireland) * 100000
db_vaccine_Ireland_2021$Booster <- (db_vaccine_Ireland_2021$Booster / population_ireland) * 100000

# Variant processing data 
max_expected_week_2021 <- max(data_Variant_Ireland_2021$week_number)
missing_weeks_2021 <- setdiff(1:max_expected_week_2021, data_Variant_Ireland_2021$week_number)

if (length(missing_weeks_2021) > 0) {
  if (identical(missing_weeks_2021, 1:length(missing_weeks_2021))) {
    for (week in missing_weeks_2021) {
      data_Variant_Ireland_2021[data_Variant_Ireland_2021$week_number == week, ] <- data_Variant_Ireland_2021[data_Variant_Ireland_2021$week_number == max(data_Variant_Ireland_2021$week_number[data_Variant_Ireland_2021$week_number < week]), ]
    }
  } else {
    existing_weeks_2021 <- intersect(1:max_expected_week_2021, data_Variant_Ireland_2021$week_number)
    missing_between_2021 <- setdiff(existing_weeks_2021 + 1, data_Variant_Ireland_2021$week_number)
    for (week in missing_between_2021) {
      before <- data_Variant_Ireland_2021[data_Variant_Ireland_2021$week_number == max(data_Variant_Ireland_2021$week_number[data_Variant_Ireland_2021$week_number < week]), ]
      after <- data_Variant_Ireland_2021[data_Variant_Ireland_2021$week_number == min(data_Variant_Ireland_2021$week_number[data_Variant_Ireland_2021$week_number > week]), ]
      data_Variant_Ireland_2021 <- rbind(data_Variant_Ireland_2021, colMeans(rbind(before, after)))
    }
  }
}
```

# 2022

```{r setup, include=FALSE}
# STRINGENCY INDEX
date_start_2022 <- ymd("2022-01-03")
date_end_2022 <- ymd("2023-01-01")
# Define the date of start 
start_date_2022 <- as.Date("2022-01-03")  

Governement_stringecy_index_oxford_ireland_2022 <- Governement_stringecy_index_oxford_ireland %>% 
  filter(date >= date_start_2022 & date <= date_end_2022)

Governement_stringecy_index_oxford_ireland_2022$date <- as.Date(Governement_stringecy_index_oxford_ireland_2022$date)

Governement_stringecy_index_oxford_ireland_2022 <- Governement_stringecy_index_oxford_ireland_2022 %>%
  mutate(days_since_start = as.numeric(date - start_date_2022)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_ireland_2022 <- Containement_health_index_oxford_ireland %>% 
  filter(Day >= date_start_2022 & Day <= date_end_2022)

Containement_health_index_oxford_ireland_2022$Day <- as.Date(Containement_health_index_oxford_ireland_2022$Day)

Containement_health_index_oxford_ireland_2022 <- Containement_health_index_oxford_ireland_2022 %>%
  mutate(days_since_start = as.numeric(Day - start_date_2022)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# HOSPITAL
data_hospital_filtered_ireland_2022 <- data_hospital_filtered_ireland %>% 
  filter(date >= date_start_2022 & date <= date_end_2022)

## Grouping the file 
data_hospital_filtered_ireland_2022$date <- as.Date(data_hospital_filtered_ireland_2022$date)

# Group by  
data_grouped_hospital_ireland_2022 <- data_hospital_filtered_ireland_2022 %>%
  mutate(days_since_start = as.numeric(date - start_date_2022)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Ireland_2022 <- data_grouped_hospital_ireland_2022 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information) %>%
  arrange(week_number)

# Create a dataframe with all week numbers from 1 to 52
all_weeks <- tibble(week_number = 1:52)

db_hospital_Ireland_2022 <- all_weeks %>%
  left_join(db_hospital_Ireland_2022, by = "week_number") %>%
  select(-country)

# DEATH
data_death_filtered_ireland_2022 <- data_death_filtered_ireland %>%
  filter(substr(year_week, 1, 4) == "2022")
# Data frame Cases and deaths 
db_death_Ireland_2022 <- data_death_filtered_ireland_2022 %>%
  select(-country, -country_code, -continent, -population, -rate_14_day, -cumulative_count, -source, -note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Ireland_2022 <- select(db_death_Ireland_2022, -year_week)

db_Ireland_2022 <- cbind(db_hospital_Ireland_2022, db_death_Ireland_2022)

# VACCINE 
# Filter data for the year 2022 and for not creating so many covariates I decide to maintain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_ireland_2022 <- data_vaccine_filtered_ireland %>%
  filter(substr(YearWeekISO, 1, 4) == "2022" & TargetGroup == "ALL")
# count Nan
missing_counts_ireland_2022 <- data_vaccine_filtered_ireland_2022 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_ireland_2022 <- data_vaccine_filtered_ireland_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

db_vaccine_Ireland_2022 <- select(data_vaccine_filtered_ireland_2022, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3, YearWeekISO)

db_vaccine_Ireland_2022 <- db_vaccine_Ireland_2022 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Ireland_2022 <- db_vaccine_Ireland_2022 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
all_weeks <- data.frame(YearWeekISO = sprintf("2022-W%02d", 1:52))
# Merge the summarized data with the dataframe of all weeks
db_vaccine_Ireland_2022 <- left_join(all_weeks, db_vaccine_Ireland_2022, by = "YearWeekISO") %>%
  replace_na(list(FirstDose = 0, SecondDose = 0, Booster = 0))

# VARIANT 
data_variant_filter_Ireland_2022 <- data_variant %>%
  filter(Location == "Ireland", !is.na(Variant) & Variant != "", Collection_Date >= as.Date("2022-01-03") & Collection_Date <= as.Date("2023-01-01")) 
data_variant_filter_Ireland_2022 <- select(data_variant_filter_Ireland_2022, Collection_Date, Variant)
start_date_2022 <- as.Date("2022-01-03")  

# Group by  
data_grouped_variant_ireland_2022 <- data_variant_filter_Ireland_2022 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date_2022),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_ireland_2022 <- select(data_grouped_variant_ireland_2022, -count)
  
data_Variant_Ireland_2022 <- data_grouped_variant_ireland_2022 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:52)
data_Variant_Ireland_2022 <- data_Variant_Ireland_2022 %>%distinct()
data_Variant_Ireland_2022$week_number <- as.integer(data_Variant_Ireland_2022$week_number)
data_Variant_Ireland_2022 <- left_join(all_weeks, data_Variant_Ireland_2022, by = "week_number")

# Standardize the data 
#db_Ireland_2022 <- db_Ireland_2022 %>% rename('Daily_ICU_occupancy' = 'Daily ICU occupancy')
db_Ireland_2022 <- db_Ireland_2022 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

#db_Ireland_2022$Daily_ICU_occupancy <- (db_Ireland_2022$Daily_ICU_occupancy / population_ireland) * 100000
db_Ireland_2022$Daily_hospital_occupancy <- (db_Ireland_2022$Daily_hospital_occupancy / population_ireland) * 100000
db_Ireland_2022$cases <- (db_Ireland_2022$cases / population_ireland) * 100000
db_Ireland_2022$deaths <- (db_Ireland_2022$deaths / population_ireland) * 100000

db_vaccine_Ireland_2022$FirstDose <- (db_vaccine_Ireland_2022$FirstDose / population_ireland) * 100000
db_vaccine_Ireland_2022$SecondDose <- (db_vaccine_Ireland_2022$SecondDose / population_ireland) * 100000
db_vaccine_Ireland_2022$Booster <- (db_vaccine_Ireland_2022$Booster / population_ireland) * 100000

# Variant processing data 
max_expected_week_2022 <- max(data_Variant_Ireland_2022$week_number)
missing_weeks_2022 <- setdiff(1:max_expected_week_2022, data_Variant_Ireland_2022$week_number)

if (length(missing_weeks_2022) > 0) {
  if (identical(missing_weeks_2022, 1:length(missing_weeks_2022))) {
    for (week in missing_weeks_2022) {
      data_Variant_Ireland_2022[data_Variant_Ireland_2022$week_number == week, ] <- data_Variant_Ireland_2022[data_Variant_Ireland_2022$week_number == max(data_Variant_Ireland_2022$week_number[data_Variant_Ireland_2022$week_number < week]), ]
    }
  } else {
    existing_weeks_2022 <- intersect(1:max_expected_week_2022, data_Variant_Ireland_2022$week_number)
    missing_between_2022 <- setdiff(existing_weeks_2022 + 1, data_Variant_Ireland_2022$week_number)
    for (week in missing_between_2022) {
      before <- data_Variant_Ireland_2022[data_Variant_Ireland_2022$week_number == max(data_Variant_Ireland_2022$week_number[data_Variant_Ireland_2022$week_number < week]), ]
      after <- data_Variant_Ireland_2022[data_Variant_Ireland_2022$week_number == min(data_Variant_Ireland_2022$week_number[data_Variant_Ireland_2022$week_number > week]), ]
      data_Variant_Ireland_2022 <- rbind(data_Variant_Ireland_2022, colMeans(rbind(before, after)))
    }
  }
}
```

# CYPRUS
```{r setup, include=FALSE}
selected_countries_cyprus <- c("Cyprus")

## LOAD DATA 
# HOSPITAL
data_hospital_filtered_cyprus <- data_hospital %>% 
  filter(country %in% selected_countries_cyprus)
data_hospital_filtered_cyprus$date <- parse_date_time(data_hospital_filtered_cyprus$date, orders = c("ymd", "ymd"))

## DEATH
data_death_filtered_cyprus <- data_death %>% 
  filter(country %in% selected_countries_cyprus)

# Obtain the population of the nation 
population_cyprus <- unique(data_death_filtered_cyprus$population)

# Data Vaccine 

# Filter with Nation of Interest 
selected_countries_cyprus_iso <- c("CY")  # ISO code for Cyprus
data_vaccine_filtered_cyprus <- data_vaccine %>% filter(ReportingCountry %in% selected_countries_cyprus_iso)

# Filter health_index_oxford
Containement_health_index_oxford_cyprus <- Containement_health_index_oxford %>% 
  filter(Entity %in% selected_countries_cyprus)
Containement_health_index_oxford_cyprus$Day <- parse_date_time(Containement_health_index_oxford_cyprus$Day, orders = c("ymd", "ymd"))

# Filter Government Index
Governement_stringecy_index_oxford_cyprus <- Governement_stringecy_index_oxford %>% 
  filter(location %in% selected_countries_cyprus)
Governement_stringecy_index_oxford_cyprus$date <- parse_date_time(Governement_stringecy_index_oxford_cyprus$date, orders = c("ymd", "ymd"))
```



# 2020

```{r setup, include=FALSE}
# STRINGENCY INDEX
date_start_2020 <- ymd("2020-01-05")
date_end_2020 <- ymd("2021-01-03")
# Define the date of start 
start_date_2020 <- as.Date("2020-01-05")  

Governement_stringecy_index_oxford_cyprus_2020 <- Governement_stringecy_index_oxford_cyprus %>% 
  filter(date >= date_start_2020 & date <= date_end_2020)

Governement_stringecy_index_oxford_cyprus_2020$date <- as.Date(Governement_stringecy_index_oxford_cyprus_2020$date)

Governement_stringecy_index_oxford_cyprus_2020 <- Governement_stringecy_index_oxford_cyprus_2020 %>%
  mutate(days_since_start = as.numeric(date - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_cyprus_2020 <- Containement_health_index_oxford_cyprus %>% 
  filter(Day >= date_start_2020 & Day <= date_end_2020)

Containement_health_index_oxford_cyprus_2020$Day <- as.Date(Containement_health_index_oxford_cyprus_2020$Day)

Containement_health_index_oxford_cyprus_2020 <- Containement_health_index_oxford_cyprus_2020 %>%
  mutate(days_since_start = as.numeric(Day - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# HOSPITAL
data_hospital_filtered_cyprus_2020 <- data_hospital_filtered_cyprus %>% 
  filter(date >= date_start_2020 & date <= date_end_2020)

## Grouping the file 
data_hospital_filtered_cyprus_2020$date <- as.Date(data_hospital_filtered_cyprus_2020$date)

# Group by  
data_grouped_hospital_cyprus_2020 <- data_hospital_filtered_cyprus_2020 %>%
  mutate(days_since_start = as.numeric(date - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Cyprus_2020 <- data_grouped_hospital_cyprus_2020 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information) %>%
  arrange(week_number)

# Create a dataframe with all week numbers from 1 to 53
all_weeks <- tibble(week_number = 1:53)

db_hospital_Cyprus_2020 <- all_weeks %>%
  left_join(db_hospital_Cyprus_2020, by = "week_number") %>%
  select(-country)

# DEATH
data_death_filtered_cyprus_2020 <- data_death_filtered_cyprus %>%
  filter(substr(year_week, 1, 4) == "2020")
# Data frame Cases and deaths 
db_death_Cyprus_2020 <- data_death_filtered_cyprus_2020 %>%
  select(-country, -country_code, -continent, -population, -rate_14_day, -cumulative_count, -source, -note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Cyprus_2020 <- select(db_death_Cyprus_2020, -year_week)

db_Cyprus_2020 <- cbind(db_hospital_Cyprus_2020, db_death_Cyprus_2020)

# VACCINE 
# Filter data for the year 2020 and for not creating so many covariates I decide to maintain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_cyprus_2020 <- data_vaccine_filtered_cyprus %>%
  filter(substr(YearWeekISO, 1, 4) == "2020" & TargetGroup == "ALL")
# count Nan
missing_counts_cyprus_2020 <- data_vaccine_filtered_cyprus_2020 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_cyprus_2020 <- data_vaccine_filtered_cyprus_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

db_vaccine_Cyprus_2020 <- select(data_vaccine_filtered_cyprus_2020, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3, YearWeekISO)

db_vaccine_Cyprus_2020 <- db_vaccine_Cyprus_2020 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Cyprus_2020 <- db_vaccine_Cyprus_2020 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
all_weeks <- data.frame(YearWeekISO = sprintf("2020-W%02d", 1:53))
# Merge the summarized data with the dataframe of all weeks
db_vaccine_Cyprus_2020 <- left_join(all_weeks, db_vaccine_Cyprus_2020, by = "YearWeekISO") %>%
  replace_na(list(FirstDose = 0, SecondDose = 0, Booster = 0))

# VARIANT 
data_variant_filter_Cyprus_2020 <- data_variant %>%
  filter(Location == "Cyprus", !is.na(Variant) & Variant != "", Collection_Date >= as.Date("2020-01-05") & Collection_Date <= as.Date("2021-01-03")) 
data_variant_filter_Cyprus_2020 <- select(data_variant_filter_Cyprus_2020, Collection_Date, Variant)
start_date_2020 <- as.Date("2020-01-05")  

# Group by  
data_grouped_variant_cyprus_2020 <- data_variant_filter_Cyprus_2020 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date_2020),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_cyprus_2020 <- select(data_grouped_variant_cyprus_2020, -count)
  
data_Variant_Cyprus_2020 <- data_grouped_variant_cyprus_2020 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:53)
data_Variant_Cyprus_2020 <- data_Variant_Cyprus_2020 %>%distinct()
data_Variant_Cyprus_2020$week_number <- as.integer(data_Variant_Cyprus_2020$week_number)
data_Variant_Cyprus_2020 <- left_join(all_weeks, data_Variant_Cyprus_2020, by = "week_number")

# Standardize the data 
db_Cyprus_2020 <- db_Cyprus_2020 %>% rename('Daily_ICU_occupancy' = 'Daily ICU occupancy')
db_Cyprus_2020 <- db_Cyprus_2020 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

db_Cyprus_2020$Daily_ICU_occupancy <- (db_Cyprus_2020$Daily_ICU_occupancy / population_cyprus) * 100000
db_Cyprus_2020$Daily_hospital_occupancy <- (db_Cyprus_2020$Daily_hospital_occupancy / population_cyprus) * 100000
db_Cyprus_2020$cases <- (db_Cyprus_2020$cases / population_cyprus) * 100000
db_Cyprus_2020$deaths <- (db_Cyprus_2020$deaths / population_cyprus) * 100000

db_vaccine_Cyprus_2020$FirstDose <- (db_vaccine_Cyprus_2020$FirstDose / population_cyprus) * 100000
db_vaccine_Cyprus_2020$SecondDose <- (db_vaccine_Cyprus_2020$SecondDose / population_cyprus) * 100000
db_vaccine_Cyprus_2020$Booster <- (db_vaccine_Cyprus_2020$Booster / population_cyprus) * 100000

# Variant processing data 
max_expected_week_2020 <- max(data_Variant_Cyprus_2020$week_number)
missing_weeks_2020 <- setdiff(1:max_expected_week_2020, data_Variant_Cyprus_2020$week_number)

if (length(missing_weeks_2020) > 0) {
  if (identical(missing_weeks_2020, 1:length(missing_weeks_2020))) {
    for (week in missing_weeks_2020) {
      data_Variant_Cyprus_2020[data_Variant_Cyprus_2020$week_number == week, ] <- data_Variant_Cyprus_2020[data_Variant_Cyprus_2020$week_number == max(data_Variant_Cyprus_2020$week_number[data_Variant_Cyprus_2020$week_number < week]), ]
    }
  } else {
    existing_weeks <- intersect(1:max_expected_week_2020, data_Variant_Cyprus_2020$week_number)
    missing_between <- setdiff(existing_weeks + 1, data_Variant_Cyprus_2020$week_number)
    for (week in missing_between) {
      before <- data_Variant_Cyprus_2020[data_Variant_Cyprus_2020$week_number == max(data_Variant_Cyprus_2020$week_number[data_Variant_Cyprus_2020$week_number < week]), ]
      after <- data_Variant_Cyprus_2020[data_Variant_Cyprus_2020$week_number == min(data_Variant_Cyprus_2020$week_number[data_Variant_Cyprus_2020$week_number > week]), ]
      data_Variant_Cyprus_2020 <- rbind(data_Variant_Cyprus_2020, colMeans(rbind(before, after)))
    }
  }
}
```

# 2021

```{r setup, include=FALSE}
# STRINGENCY INDEX
date_start_2021 <- ymd("2021-01-04")
date_end_2021 <- ymd("2022-01-02")
# Define the date of start 
start_date_2021 <- as.Date("2021-01-04")  

Governement_stringecy_index_oxford_cyprus_2021 <- Governement_stringecy_index_oxford_cyprus %>% 
  filter(date >= date_start_2021 & date <= date_end_2021)

Governement_stringecy_index_oxford_cyprus_2021$date <- as.Date(Governement_stringecy_index_oxford_cyprus_2021$date)

Governement_stringecy_index_oxford_cyprus_2021 <- Governement_stringecy_index_oxford_cyprus_2021 %>%
  mutate(days_since_start = as.numeric(date - start_date_2021)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_cyprus_2021 <- Containement_health_index_oxford_cyprus %>% 
  filter(Day >= date_start_2021 & Day <= date_end_2021)

Containement_health_index_oxford_cyprus_2021$Day <- as.Date(Containement_health_index_oxford_cyprus_2021$Day)

Containement_health_index_oxford_cyprus_2021 <- Containement_health_index_oxford_cyprus_2021 %>%
  mutate(days_since_start = as.numeric(Day - start_date_2021)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# HOSPITAL
data_hospital_filtered_cyprus_2021 <- data_hospital_filtered_cyprus %>% 
  filter(date >= date_start_2021 & date <= date_end_2021)

## Grouping the file 
data_hospital_filtered_cyprus_2021$date <- as.Date(data_hospital_filtered_cyprus_2021$date)

# Group by  
data_grouped_hospital_cyprus_2021 <- data_hospital_filtered_cyprus_2021 %>%
  mutate(days_since_start = as.numeric(date - start_date_2021)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Cyprus_2021 <- data_grouped_hospital_cyprus_2021 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information) %>%
  arrange(week_number)

# Create a dataframe with all week numbers from 1 to 52
all_weeks <- tibble(week_number = 1:52)

db_hospital_Cyprus_2021 <- all_weeks %>%
  left_join(db_hospital_Cyprus_2021, by = "week_number") %>%
  select(-country)

# DEATH
data_death_filtered_cyprus_2021 <- data_death_filtered_cyprus %>%
  filter(substr(year_week, 1, 4) == "2021")
# Data frame Cases and deaths 
db_death_Cyprus_2021 <- data_death_filtered_cyprus_2021 %>%
  select(-country, -country_code, -continent, -population, -rate_14_day, -cumulative_count, -source, -note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Cyprus_2021 <- select(db_death_Cyprus_2021, -year_week)

db_Cyprus_2021 <- cbind(db_hospital_Cyprus_2021, db_death_Cyprus_2021)

# VACCINE 
# Filter data for the year 2021 and for not creating so many covariates I decide to maintain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_cyprus_2021 <- data_vaccine_filtered_cyprus %>%
  filter(substr(YearWeekISO, 1, 4) == "2021" & TargetGroup == "ALL")
# count Nan
missing_counts_cyprus_2021 <- data_vaccine_filtered_cyprus_2021 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_cyprus_2021 <- data_vaccine_filtered_cyprus_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

db_vaccine_Cyprus_2021 <- select(data_vaccine_filtered_cyprus_2021, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3, YearWeekISO)

db_vaccine_Cyprus_2021 <- db_vaccine_Cyprus_2021 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Cyprus_2021 <- db_vaccine_Cyprus_2021 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
all_weeks <- data.frame(YearWeekISO = sprintf("2021-W%02d", 1:52))
# Merge the summarized data with the dataframe of all weeks
db_vaccine_Cyprus_2021 <- left_join(all_weeks, db_vaccine_Cyprus_2021, by = "YearWeekISO") %>%
  replace_na(list(FirstDose = 0, SecondDose = 0, Booster = 0))

# VARIANT 
data_variant_filter_Cyprus_2021 <- data_variant %>%
  filter(Location == "Cyprus", !is.na(Variant) & Variant != "", Collection_Date >= as.Date("2021-01-04") & Collection_Date <= as.Date("2022-01-02")) 
data_variant_filter_Cyprus_2021 <- select(data_variant_filter_Cyprus_2021, Collection_Date, Variant)
start_date_2021 <- as.Date("2021-01-04")  

# Group by  
data_grouped_variant_cyprus_2021 <- data_variant_filter_Cyprus_2021 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date_2021),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_cyprus_2021 <- select(data_grouped_variant_cyprus_2021, -count)
  
data_Variant_Cyprus_2021 <- data_grouped_variant_cyprus_2021 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:52)
data_Variant_Cyprus_2021 <- data_Variant_Cyprus_2021 %>% distinct()
data_Variant_Cyprus_2021$week_number <- as.integer(data_Variant_Cyprus_2021$week_number)
data_Variant_Cyprus_2021 <- left_join(all_weeks, data_Variant_Cyprus_2021, by = "week_number")

# Standardize the data 
db_Cyprus_2021 <- db_Cyprus_2021 %>% rename('Daily_ICU_occupancy' = 'Daily ICU occupancy')
db_Cyprus_2021 <- db_Cyprus_2021 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

db_Cyprus_2021$Daily_ICU_occupancy <- (db_Cyprus_2021$Daily_ICU_occupancy / population_cyprus) * 100000
db_Cyprus_2021$Daily_hospital_occupancy <- (db_Cyprus_2021$Daily_hospital_occupancy / population_cyprus) * 100000
db_Cyprus_2021$cases <- (db_Cyprus_2021$cases / population_cyprus) * 100000
db_Cyprus_2021$deaths <- (db_Cyprus_2021$deaths / population_cyprus) * 100000

db_vaccine_Cyprus_2021$FirstDose <- (db_vaccine_Cyprus_2021$FirstDose / population_cyprus) * 100000
db_vaccine_Cyprus_2021$SecondDose <- (db_vaccine_Cyprus_2021$SecondDose / population_cyprus) * 100000
db_vaccine_Cyprus_2021$Booster <- (db_vaccine_Cyprus_2021$Booster / population_cyprus) * 100000

# Variant processing data 
max_expected_week_2021 <- max(data_Variant_Cyprus_2021$week_number)
missing_weeks_2021 <- setdiff(1:max_expected_week_2021, data_Variant_Cyprus_2021$week_number)

if (length(missing_weeks_2021) > 0) {
  if (identical(missing_weeks_2021, 1:length(missing_weeks_2021))) {
    for (week in missing_weeks_2021) {
      data_Variant_Cyprus_2021[data_Variant_Cyprus_2021$week_number == week, ] <- data_Variant_Cyprus_2021[data_Variant_Cyprus_2021$week_number == max(data_Variant_Cyprus_2021$week_number[data_Variant_Cyprus_2021$week_number < week]), ]
    }
  } else {
    existing_weeks <- intersect(1:max_expected_week_2021, data_Variant_Cyprus_2021$week_number)
    missing_between <- setdiff(existing_weeks + 1, data_Variant_Cyprus_2021$week_number)
    for (week in missing_between) {
      before <- data_Variant_Cyprus_2021[data_Variant_Cyprus_2021$week_number == max(data_Variant_Cyprus_2021$week_number[data_Variant_Cyprus_2021$week_number < week]), ]
      after <- data_Variant_Cyprus_2021[data_Variant_Cyprus_2021$week_number == min(data_Variant_Cyprus_2021$week_number[data_Variant_Cyprus_2021$week_number > week]), ]
      data_Variant_Cyprus_2021 <- rbind(data_Variant_Cyprus_2021, colMeans(rbind(before, after)))
    }
  }
}

```

# 2022

```{r setup, include=FALSE}
# STRINGENCY INDEX
date_start_2022 <- ymd("2022-01-03")
date_end_2022 <- ymd("2023-01-01")
# Define the date of start 
start_date_2022 <- as.Date("2022-01-03")  

Governement_stringecy_index_oxford_cyprus_2022 <- Governement_stringecy_index_oxford_cyprus %>% 
  filter(date >= date_start_2022 & date <= date_end_2022)

Governement_stringecy_index_oxford_cyprus_2022$date <- as.Date(Governement_stringecy_index_oxford_cyprus_2022$date)

Governement_stringecy_index_oxford_cyprus_2022 <- Governement_stringecy_index_oxford_cyprus_2022 %>%
  mutate(days_since_start = as.numeric(date - start_date_2022)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_cyprus_2022 <- Containement_health_index_oxford_cyprus %>% 
  filter(Day >= date_start_2022 & Day <= date_end_2022)

Containement_health_index_oxford_cyprus_2022$Day <- as.Date(Containement_health_index_oxford_cyprus_2022$Day)

Containement_health_index_oxford_cyprus_2022 <- Containement_health_index_oxford_cyprus_2022 %>%
  mutate(days_since_start = as.numeric(Day - start_date_2022)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# HOSPITAL
data_hospital_filtered_cyprus_2022 <- data_hospital_filtered_cyprus %>% 
  filter(date >= date_start_2022 & date <= date_end_2022)

## Grouping the file 
data_hospital_filtered_cyprus_2022$date <- as.Date(data_hospital_filtered_cyprus_2022$date)

# Group by  
data_grouped_hospital_cyprus_2022 <- data_hospital_filtered_cyprus_2022 %>%
  mutate(days_since_start = as.numeric(date - start_date_2022)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Cyprus_2022 <- data_grouped_hospital_cyprus_2022 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information) %>%
  arrange(week_number)

# Create a dataframe with all week numbers from 1 to 52
all_weeks <- tibble(week_number = 1:52)

db_hospital_Cyprus_2022 <- all_weeks %>%
  left_join(db_hospital_Cyprus_2022, by = "week_number") %>%
  select(-country)

# DEATH
data_death_filtered_cyprus_2022 <- data_death_filtered_cyprus %>%
  filter(substr(year_week, 1, 4) == "2022")
# Data frame Cases and deaths 
db_death_Cyprus_2022 <- data_death_filtered_cyprus_2022 %>%
  select(-country, -country_code, -continent, -population, -rate_14_day, -cumulative_count, -source, -note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Cyprus_2022 <- select(db_death_Cyprus_2022, -year_week)

db_Cyprus_2022 <- cbind(db_hospital_Cyprus_2022, db_death_Cyprus_2022)

# VACCINE 
# Filter data for the year 2022 and for not creating so many covariates I decide to maintain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_cyprus_2022 <- data_vaccine_filtered_cyprus %>%
  filter(substr(YearWeekISO, 1, 4) == "2022" & TargetGroup == "ALL")
# count Nan
missing_counts_cyprus_2022 <- data_vaccine_filtered_cyprus_2022 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_cyprus_2022 <- data_vaccine_filtered_cyprus_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

db_vaccine_Cyprus_2022 <- select(data_vaccine_filtered_cyprus_2022, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3, YearWeekISO)

db_vaccine_Cyprus_2022 <- db_vaccine_Cyprus_2022 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Cyprus_2022 <- db_vaccine_Cyprus_2022 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
all_weeks <- data.frame(YearWeekISO = sprintf("2022-W%02d", 1:52))
# Merge the summarized data with the dataframe of all weeks
db_vaccine_Cyprus_2022 <- left_join(all_weeks, db_vaccine_Cyprus_2022, by = "YearWeekISO") %>%
  replace_na(list(FirstDose = 0, SecondDose = 0, Booster = 0))

# VARIANT 
data_variant_filter_Cyprus_2022 <- data_variant %>%
  filter(Location == "Cyprus", !is.na(Variant) & Variant != "", Collection_Date >= as.Date("2022-01-03") & Collection_Date <= as.Date("2023-01-01")) 
data_variant_filter_Cyprus_2022 <- select(data_variant_filter_Cyprus_2022, Collection_Date, Variant)
start_date_2022 <- as.Date("2022-01-03")  

# Group by  
data_grouped_variant_cyprus_2022 <- data_variant_filter_Cyprus_2022 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date_2022),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_cyprus_2022 <- select(data_grouped_variant_cyprus_2022, -count)
  
data_Variant_Cyprus_2022 <- data_grouped_variant_cyprus_2022 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:52)
data_Variant_Cyprus_2022 <- data_Variant_Cyprus_2022 %>% distinct()
data_Variant_Cyprus_2022$week_number <- as.integer(data_Variant_Cyprus_2022$week_number)
data_Variant_Cyprus_2022 <- left_join(all_weeks, data_Variant_Cyprus_2022, by = "week_number")

# Standardize the data 
db_Cyprus_2022 <- db_Cyprus_2022 %>% rename('Daily_ICU_occupancy' = 'Daily ICU occupancy')
db_Cyprus_2022 <- db_Cyprus_2022 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

db_Cyprus_2022$Daily_ICU_occupancy <- (db_Cyprus_2022$Daily_ICU_occupancy / population_cyprus) * 100000
db_Cyprus_2022$Daily_hospital_occupancy <- (db_Cyprus_2022$Daily_hospital_occupancy / population_cyprus) * 100000
db_Cyprus_2022$cases <- (db_Cyprus_2022$cases / population_cyprus) * 100000
db_Cyprus_2022$deaths <- (db_Cyprus_2022$deaths / population_cyprus) * 100000

db_vaccine_Cyprus_2022$FirstDose <- (db_vaccine_Cyprus_2022$FirstDose / population_cyprus) * 100000
db_vaccine_Cyprus_2022$SecondDose <- (db_vaccine_Cyprus_2022$SecondDose / population_cyprus) * 100000
db_vaccine_Cyprus_2022$Booster <- (db_vaccine_Cyprus_2022$Booster / population_cyprus) * 100000

# Variant processing data 
max_expected_week_2022 <- max(data_Variant_Cyprus_2022$week_number)
missing_weeks_2022 <- setdiff(1:max_expected_week_2022, data_Variant_Cyprus_2022$week_number)

if (length(missing_weeks_2022) > 0) {
  if (identical(missing_weeks_2022, 1:length(missing_weeks_2022))) {
    for (week in missing_weeks_2022) {
      data_Variant_Cyprus_2022[data_Variant_Cyprus_2022$week_number == week, ] <- data_Variant_Cyprus_2022[data_Variant_Cyprus_2022$week_number == max(data_Variant_Cyprus_2022$week_number[data_Variant_Cyprus_2022$week_number < week]), ]
    }
  } else {
    existing_weeks <- intersect(1:max_expected_week_2022, data_Variant_Cyprus_2022$week_number)
    missing_between <- setdiff(existing_weeks + 1, data_Variant_Cyprus_2022$week_number)
    for (week in missing_between) {
      before <- data_Variant_Cyprus_2022[data_Variant_Cyprus_2022$week_number == max(data_Variant_Cyprus_2022$week_number[data_Variant_Cyprus_2022$week_number < week]), ]
      after <- data_Variant_Cyprus_2022[data_Variant_Cyprus_2022$week_number == min(data_Variant_Cyprus_2022$week_number[data_Variant_Cyprus_2022$week_number > week]), ]
      data_Variant_Cyprus_2022 <- rbind(data_Variant_Cyprus_2022, colMeans(rbind(before, after)))
    }
  }
}
```

# ESTONIA 

```{r setup, include=FALSE}
selected_countries_estonia <- c("Estonia")

## LOAD DATA 
# HOSPITAL
data_hospital_filtered_estonia <- data_hospital %>% 
  filter(country %in% selected_countries_estonia)
data_hospital_filtered_estonia$date <- parse_date_time(data_hospital_filtered_estonia$date, orders = c("ymd", "ymd"))

## DEATH
data_death_filtered_estonia <- data_death %>% 
  filter(country %in% selected_countries_estonia)

# Obtain the population of the nation 
population_estonia <- unique(data_death_filtered_estonia$population)

# Data Vaccine 

# Filter with Nation of Interest 
selected_countries_estonia_iso <- c("EE")  # ISO code for Estonia
data_vaccine_filtered_estonia <- data_vaccine %>% filter(ReportingCountry %in% selected_countries_estonia_iso)

# Filter health_index_oxford
Containement_health_index_oxford_estonia <- Containement_health_index_oxford %>% 
  filter(Entity %in% selected_countries_estonia)
Containement_health_index_oxford_estonia$Day <- parse_date_time(Containement_health_index_oxford_estonia$Day, orders = c("ymd", "ymd"))

# Filter Government Index
Governement_stringecy_index_oxford_estonia <- Governement_stringecy_index_oxford %>% 
  filter(location %in% selected_countries_estonia)
Governement_stringecy_index_oxford_estonia$date <- parse_date_time(Governement_stringecy_index_oxford_estonia$date, orders = c("ymd", "ymd"))

```

# 2020

```{r setup, include=FALSE}
# STRINGENCY INDEX
date_start_2020 <- ymd("2020-01-05")
date_end_2020 <- ymd("2021-01-03")
# Define the date of start 
start_date_2020 <- as.Date("2020-01-05")  

Governement_stringecy_index_oxford_estonia_2020 <- Governement_stringecy_index_oxford_estonia %>% 
  filter(date >= date_start_2020 & date <= date_end_2020)

Governement_stringecy_index_oxford_estonia_2020$date <- as.Date(Governement_stringecy_index_oxford_estonia_2020$date)

Governement_stringecy_index_oxford_estonia_2020 <- Governement_stringecy_index_oxford_estonia_2020 %>%
  mutate(days_since_start = as.numeric(date - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_estonia_2020 <- Containement_health_index_oxford_estonia %>% 
  filter(Day >= date_start_2020 & Day <= date_end_2020)

Containement_health_index_oxford_estonia_2020$Day <- as.Date(Containement_health_index_oxford_estonia_2020$Day)

Containement_health_index_oxford_estonia_2020 <- Containement_health_index_oxford_estonia_2020 %>%
  mutate(days_since_start = as.numeric(Day - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# HOSPITAL
data_hospital_filtered_estonia_2020 <- data_hospital_filtered_estonia %>% 
  filter(date >= date_start_2020 & date <= date_end_2020)

## Grouping the file 
data_hospital_filtered_estonia_2020$date <- as.Date(data_hospital_filtered_estonia_2020$date)

# Group by  
data_grouped_hospital_estonia_2020 <- data_hospital_filtered_estonia_2020 %>%
  mutate(days_since_start = as.numeric(date - start_date_2020)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Estonia_2020 <- data_grouped_hospital_estonia_2020 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information) %>%
  arrange(week_number)

# Create a dataframe with all week numbers from 1 to 53
all_weeks <- tibble(week_number = 1:53)

db_hospital_Estonia_2020 <- all_weeks %>%
  left_join(db_hospital_Estonia_2020, by = "week_number") %>%
  select(-country)

# DEATH
data_death_filtered_estonia_2020 <- data_death_filtered_estonia %>%
  filter(substr(year_week, 1, 4) == "2020")
# Data frame Cases and deaths 
db_death_Estonia_2020 <- data_death_filtered_estonia_2020 %>%
  select(-country, -country_code, -continent, -population, -rate_14_day, -cumulative_count, -source, -note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Estonia_2020 <- select(db_death_Estonia_2020, -year_week)

db_Estonia_2020 <- cbind(db_hospital_Estonia_2020, db_death_Estonia_2020)

# VACCINE 
# Filter data for the year 2020 and for not creating so many covariates I decide to maintain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_estonia_2020 <- data_vaccine_filtered_estonia %>%
  filter(substr(YearWeekISO, 1, 4) == "2020" & TargetGroup == "ALL")
# count Nan
missing_counts_estonia_2020 <- data_vaccine_filtered_estonia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_estonia_2020 <- data_vaccine_filtered_estonia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

db_vaccine_Estonia_2020 <- select(data_vaccine_filtered_estonia_2020, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3, YearWeekISO)

db_vaccine_Estonia_2020 <- db_vaccine_Estonia_2020 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Estonia_2020 <- db_vaccine_Estonia_2020 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
all_weeks <- data.frame(YearWeekISO = sprintf("2020-W%02d", 1:53))
# Merge the summarized data with the dataframe of all weeks
db_vaccine_Estonia_2020 <- left_join(all_weeks, db_vaccine_Estonia_2020, by = "YearWeekISO") %>%
  replace_na(list(FirstDose = 0, SecondDose = 0, Booster = 0))

# VARIANT 
data_variant_filter_Estonia_2020 <- data_variant %>%
  filter(Location == "Estonia", !is.na(Variant) & Variant != "", Collection_Date >= as.Date("2020-01-05") & Collection_Date <= as.Date("2021-01-03")) 
data_variant_filter_Estonia_2020 <- select(data_variant_filter_Estonia_2020, Collection_Date, Variant)
start_date_2020 <- as.Date("2020-01-05")  

# Group by  
data_grouped_variant_estonia_2020 <- data_variant_filter_Estonia_2020 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date_2020),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_estonia_2020 <- select(data_grouped_variant_estonia_2020, -count)
  
data_Variant_Estonia_2020 <- data_grouped_variant_estonia_2020 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:53)
data_Variant_Estonia_2020 <- data_Variant_Estonia_2020 %>% distinct()
data_Variant_Estonia_2020$week_number <- as.integer(data_Variant_Estonia_2020$week_number)
data_Variant_Estonia_2020 <- left_join(all_weeks, data_Variant_Estonia_2020, by = "week_number")

# Standardize the data 
db_Estonia_2020 <- db_Estonia_2020 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
db_Estonia_2020 <- db_Estonia_2020 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

db_Estonia_2020$Daily_ICU_occupancy <- (db_Estonia_2020$Daily_ICU_occupancy / population_estonia) * 100000
db_Estonia_2020$Daily_hospital_occupancy <- (db_Estonia_2020$Daily_hospital_occupancy / population_estonia) * 100000
db_Estonia_2020$cases <- (db_Estonia_2020$cases / population_estonia) * 100000
db_Estonia_2020$deaths <- (db_Estonia_2020$deaths / population_estonia) * 100000

db_vaccine_Estonia_2020$FirstDose <- (db_vaccine_Estonia_2020$FirstDose / population_estonia) * 100000
db_vaccine_Estonia_2020$SecondDose <- (db_vaccine_Estonia_2020$SecondDose / population_estonia) * 100000
db_vaccine_Estonia_2020$Booster <- (db_vaccine_Estonia_2020$Booster / population_estonia) * 100000

# Variant processing data 
max_expected_week_2020 <- max(data_Variant_Estonia_2020$week_number)
missing_weeks_2020 <- setdiff(1:max_expected_week_2020, data_Variant_Estonia_2020$week_number)

if (length(missing_weeks_2020) > 0) {
  if (identical(missing_weeks_2020, 1:length(missing_weeks_2020))) {
    for (week in missing_weeks_2020) {
      data_Variant_Estonia_2020[data_Variant_Estonia_2020$week_number == week, ] <- data_Variant_Estonia_2020[data_Variant_Estonia_2020$week_number == max(data_Variant_Estonia_2020$week_number[data_Variant_Estonia_2020$week_number < week]), ]
    }
  } else {
    existing_weeks <- intersect(1:max_expected_week_2020, data_Variant_Estonia_2020$week_number)
    missing_between <- setdiff(existing_weeks + 1, data_Variant_Estonia_2020$week_number)
    for (week in missing_between) {
      before <- data_Variant_Estonia_2020[data_Variant_Estonia_2020$week_number == max(data_Variant_Estonia_2020$week_number[data_Variant_Estonia_2020$week_number < week]), ]
      after <- data_Variant_Estonia_2020[data_Variant_Estonia_2020$week_number == min(data_Variant_Estonia_2020$week_number[data_Variant_Estonia_2020$week_number > week]), ]
      data_Variant_Estonia_2020 <- rbind(data_Variant_Estonia_2020, colMeans(rbind(before, after)))
    }
  }
}
```

# 2021

```{r setup, include=FALSE}
# STRINGENCY INDEX
date_start <- ymd("2021-01-04")
date_end <- ymd("2022-01-02")
# Define the date of start 
start_date <- as.Date("2021-01-04")  

Governement_stringecy_index_oxford_estonia_2021 <- Governement_stringecy_index_oxford_estonia %>% 
  filter(date >= date_start & date <= date_end)

Governement_stringecy_index_oxford_estonia_2021$date <- as.Date(Governement_stringecy_index_oxford_estonia_2021$date)

Governement_stringecy_index_oxford_estonia_2021 <- Governement_stringecy_index_oxford_estonia_2021 %>%
  mutate(days_since_start = as.numeric(date - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_estonia_2021 <- Containement_health_index_oxford_estonia %>% 
  filter(Day >= date_start & Day <= date_end)

Containement_health_index_oxford_estonia_2021$Day <- as.Date(Containement_health_index_oxford_estonia_2021$Day)

Containement_health_index_oxford_estonia_2021 <- Containement_health_index_oxford_estonia_2021 %>%
  mutate(days_since_start = as.numeric(Day - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# HOSPITAL
data_hospital_filtered_estonia_2021 <- data_hospital_filtered_estonia %>% 
  filter(date >= date_start & date <= date_end)

## Grouping the file 
data_hospital_filtered_estonia_2021$date <- as.Date(data_hospital_filtered_estonia_2021$date)

# Group by  
data_grouped_hospital_estonia_2021 <- data_hospital_filtered_estonia_2021 %>%
  mutate(days_since_start = as.numeric(date - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Estonia_2021 <- data_grouped_hospital_estonia_2021 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information)

db_hospital_Estonia_2021 <- select(db_hospital_Estonia_2021, -country, -week_number)

# DEATH
data_death_filtered_estonia_2021 <- data_death_filtered_estonia %>%
  filter(substr(year_week, 1, 4) == "2021")
# Data frame Cases and deaths 
db_death_Estonia_2021 <- data_death_filtered_estonia_2021 %>%
  select(-country, -country_code, -continent, -population, -rate_14_day, -cumulative_count, -source, -note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Estonia_2021 <- select(db_death_Estonia_2021, -year_week)

db_Estonia_2021 <- cbind(db_hospital_Estonia_2021, db_death_Estonia_2021)

# VACCINE 
# Filter data for the year 2021 and for not creating so many covariates I decide to maintain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_estonia_2021 <- data_vaccine_filtered_estonia %>%
  filter(substr(YearWeekISO, 1, 4) == "2021" & TargetGroup == "ALL")
# count Nan
missing_counts_estonia_2021 <- data_vaccine_filtered_estonia_2021 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_estonia_2021 <- data_vaccine_filtered_estonia_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

db_vaccine_Estonia_2021 <- select(data_vaccine_filtered_estonia_2021, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3, YearWeekISO)

db_vaccine_Estonia_2021 <- db_vaccine_Estonia_2021 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Estonia_2021 <- db_vaccine_Estonia_2021 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
all_weeks <- data.frame(YearWeekISO = sprintf("2021-W%02d", 1:52))
# Merge the summarized data with the dataframe of all weeks
db_vaccine_Estonia_2021 <- left_join(all_weeks, db_vaccine_Estonia_2021, by = "YearWeekISO") %>%
  replace_na(list(FirstDose = 0, SecondDose = 0, Booster = 0))

# VARIANT 
data_variant_filter_Estonia_2021 <- data_variant %>%
  filter(Location == "Estonia", !is.na(Variant) & Variant != "", Collection_Date >= as.Date("2021-01-04") & Collection_Date <= as.Date("2022-01-02")) 
data_variant_filter_Estonia_2021 <- select(data_variant_filter_Estonia_2021, Collection_Date, Variant)
start_date <- as.Date("2021-01-04")  

# Group by  
data_grouped_variant_estonia_2021 <- data_variant_filter_Estonia_2021 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_estonia_2021 <- select(data_grouped_variant_estonia_2021, -count)
  
data_Variant_Estonia_2021 <- data_grouped_variant_estonia_2021 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:52)
data_Variant_Estonia_2021 <- data_Variant_Estonia_2021 %>% distinct()
data_Variant_Estonia_2021$week_number <- as.integer(data_Variant_Estonia_2021$week_number)
data_Variant_Estonia_2021 <- left_join(all_weeks, data_Variant_Estonia_2021, by = "week_number")

# Standardize the data 
db_Estonia_2021 <- db_Estonia_2021 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
db_Estonia_2021 <- db_Estonia_2021 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

db_Estonia_2021$Daily_ICU_occupancy <- (db_Estonia_2021$Daily_ICU_occupancy / population_estonia) * 100000
db_Estonia_2021$Daily_hospital_occupancy <- (db_Estonia_2021$Daily_hospital_occupancy / population_estonia) * 100000
db_Estonia_2021$cases <- (db_Estonia_2021$cases / population_estonia) * 100000
db_Estonia_2021$deaths <- (db_Estonia_2021$deaths / population_estonia) * 100000

db_vaccine_Estonia_2021$FirstDose <- (db_vaccine_Estonia_2021$FirstDose / population_estonia) * 100000
db_vaccine_Estonia_2021$SecondDose <- (db_vaccine_Estonia_2021$SecondDose / population_estonia) * 100000
db_vaccine_Estonia_2021$Booster <- (db_vaccine_Estonia_2021$Booster / population_estonia) * 100000

# Variant processing data 
max_expected_week_2021 <- max(data_Variant_Estonia_2021$week_number)
missing_weeks_2021 <- setdiff(1:max_expected_week_2021, data_Variant_Estonia_2021$week_number)

if (length(missing_weeks_2021) > 0) {
  if (identical(missing_weeks_2021, 1:length(missing_weeks_2021))) {
    for (week in missing_weeks_2021) {
      data_Variant_Estonia_2021[data_Variant_Estonia_2021$week_number == week, ] <- data_Variant_Estonia_2021[data_Variant_Estonia_2021$week_number == max(data_Variant_Estonia_2021$week_number[data_Variant_Estonia_2021$week_number < week]), ]
    }
  } else {
    existing_weeks <- intersect(1:max_expected_week_2021, data_Variant_Estonia_2021$week_number)
    missing_between <- setdiff(existing_weeks + 1, data_Variant_Estonia_2021$week_number)
    for (week in missing_between) {
      before <- data_Variant_Estonia_2021[data_Variant_Estonia_2021$week_number == max(data_Variant_Estonia_2021$week_number[data_Variant_Estonia_2021$week_number < week]), ]
      after <- data_Variant_Estonia_2021[data_Variant_Estonia_2021$week_number == min(data_Variant_Estonia_2021$week_number[data_Variant_Estonia_2021$week_number > week]), ]
      data_Variant_Estonia_2021 <- rbind(data_Variant_Estonia_2021, colMeans(rbind(before, after)))
    }
  }
}
```

# 2022

```{r setup, include=FALSE}
## 2022
date_start <- ymd("2022-01-03")
date_end <- ymd("2023-01-01")
start_date <- as.Date("2022-01-03") 

Governement_stringecy_index_oxford_estonia_2022 <- Governement_stringecy_index_oxford_estonia %>% 
  filter(date >= date_start & date <= date_end)

Governement_stringecy_index_oxford_estonia_2022$date <- as.Date(Governement_stringecy_index_oxford_estonia_2022$date)

Governement_stringecy_index_oxford_estonia_2022 <- Governement_stringecy_index_oxford_estonia_2022 %>%
  mutate(days_since_start = as.numeric(date - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(location, week_number) %>%
  summarize(
    weekly_information = mean(stringency_index, na.rm = TRUE),
    .groups = 'drop'
  )

Containement_health_index_oxford_estonia_2022 <- Containement_health_index_oxford_estonia %>% 
  filter(Day >= date_start & Day <= date_end)

Containement_health_index_oxford_estonia_2022$Day <- as.Date(Containement_health_index_oxford_estonia_2022$Day)

Containement_health_index_oxford_estonia_2022 <- Containement_health_index_oxford_estonia_2022 %>%
  mutate(days_since_start = as.numeric(Day - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(Entity, week_number) %>%
  summarize(
    weekly_information = mean(containment_index, na.rm = TRUE),
    .groups = 'drop'
  )

# HOSPITAL
data_hospital_filtered_estonia_2022 <- data_hospital_filtered_estonia %>% 
  filter(date >= date_start & date <= date_end)

## Grouping the file 
data_hospital_filtered_estonia_2022$date <- as.Date(data_hospital_filtered_estonia_2022$date)

# Group by  
data_grouped_hospital_estonia_2022 <- data_hospital_filtered_estonia_2022 %>%
  mutate(days_since_start = as.numeric(date - start_date)) %>%
  mutate(week_number = 1 + (days_since_start %/% 7)) %>%
  group_by(country, indicator, week_number) %>%
  summarize(
    weekly_information = mean(value, na.rm = TRUE),
    .groups = 'drop'
  )

# DataFrame
db_hospital_Estonia_2022 <- data_grouped_hospital_estonia_2022 %>%
  pivot_wider(names_from = indicator, values_from = weekly_information)

db_hospital_Estonia_2022 <- select(db_hospital_Estonia_2022, -country, -week_number)

# DEATH
data_death_filtered_estonia_2022 <- data_death_filtered_estonia %>%
  filter(substr(year_week, 1, 4) == "2022")
# Data frame Cases and deaths 
db_death_Estonia_2022 <- data_death_filtered_estonia_2022 %>%
  select(-country, -country_code, -continent, -population, -rate_14_day, -cumulative_count, -source, -note) %>%
  pivot_wider(names_from = indicator, values_from = weekly_count)

db_death_Estonia_2022 <- select(db_death_Estonia_2022, -year_week)

db_Estonia_2022 <- cbind(db_hospital_Estonia_2022, db_death_Estonia_2022)

# VACCINE 
# Filter data for the year 2022 and for not creating so many covariates I decide to maintain only the data concerning the vaccine done on 'ALL'
data_vaccine_filtered_estonia_2022 <- data_vaccine_filtered_estonia %>%
  filter(substr(YearWeekISO, 1, 4) == "2022" & TargetGroup == "ALL")
# count Nan
missing_counts_estonia_2022 <- data_vaccine_filtered_estonia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.))))

missing_percentage_estonia_2022 <- data_vaccine_filtered_estonia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))

db_vaccine_Estonia_2022 <- select(data_vaccine_filtered_estonia_2022, FirstDose, SecondDose, DoseAdditional1, DoseAdditional2, DoseAdditional3, YearWeekISO)

db_vaccine_Estonia_2022 <- db_vaccine_Estonia_2022 %>%
  mutate(Booster = DoseAdditional1 + DoseAdditional2 + DoseAdditional3) %>%
  select(-DoseAdditional1, -DoseAdditional2, -DoseAdditional3)

db_vaccine_Estonia_2022 <- db_vaccine_Estonia_2022 %>%
  group_by(YearWeekISO) %>%
  summarize(
            FirstDose = sum(FirstDose, na.rm = TRUE),
            SecondDose = sum(SecondDose, na.rm = TRUE),
            Booster = sum(Booster, na.rm = TRUE)
            )
all_weeks <- data.frame(YearWeekISO = sprintf("2022-W%02d", 1:52))
# Merge the summarized data with the dataframe of all weeks
db_vaccine_Estonia_2022 <- left_join(all_weeks, db_vaccine_Estonia_2022, by = "YearWeekISO") %>%
  replace_na(list(FirstDose = 0, SecondDose = 0, Booster = 0))

# VARIANT 
data_variant_filter_Estonia_2022 <- data_variant %>%
  filter(Location == "Estonia", !is.na(Variant) & Variant != "", Collection_Date >= as.Date("2022-01-03") & Collection_Date <= as.Date("2023-01-01")) 
data_variant_filter_Estonia_2022 <- select(data_variant_filter_Estonia_2022, Collection_Date, Variant)
start_date <- as.Date("2022-01-03")  

# Group by  
data_grouped_variant_estonia_2022 <- data_variant_filter_Estonia_2022 %>%
  mutate(
    days_since_start = as.numeric(Collection_Date - start_date),  
    week_number = 1 + (days_since_start %/% 7) 
  ) %>%
  group_by(week_number, Variant) %>%
  summarize(count = n(), .groups = 'drop') %>%
  group_by(week_number) %>%
  mutate(percentage = (count / sum(count)) * 100) %>%
  ungroup()

data_grouped_variant_estonia_2022 <- select(data_grouped_variant_estonia_2022, -count)
  
data_Variant_Estonia_2022 <- data_grouped_variant_estonia_2022 %>%
  pivot_wider(
    names_from = Variant,  
    values_from = percentage,  
    values_fill = list(percentage = 0)   
  )

all_weeks <- data.frame(week_number = 1:52)
data_Variant_Estonia_2022 <- data_Variant_Estonia_2022 %>% distinct()
data_Variant_Estonia_2022$week_number <- as.integer(data_Variant_Estonia_2022$week_number)
data_Variant_Estonia_2022 <- left_join(all_weeks, data_Variant_Estonia_2022, by = "week_number")

# Standardize the data 
db_Estonia_2022 <- db_Estonia_2022 %>% rename('Daily_ICU_occupancy' ='Daily ICU occupancy')
db_Estonia_2022 <- db_Estonia_2022 %>% rename('Daily_hospital_occupancy' = 'Daily hospital occupancy')

db_Estonia_2022$Daily_ICU_occupancy <- (db_Estonia_2022$Daily_ICU_occupancy / population_estonia) * 100000
db_Estonia_2022$Daily_hospital_occupancy <- (db_Estonia_2022$Daily_hospital_occupancy / population_estonia) * 100000
db_Estonia_2022$cases <- (db_Estonia_2022$cases / population_estonia) * 100000
db_Estonia_2022$deaths <- (db_Estonia_2022$deaths / population_estonia) * 100000

db_vaccine_Estonia_2022$FirstDose <- (db_vaccine_Estonia_2022$FirstDose / population_estonia) * 100000
db_vaccine_Estonia_2022$SecondDose <- (db_vaccine_Estonia_2022$SecondDose / population_estonia) * 100000
db_vaccine_Estonia_2022$Booster <- (db_vaccine_Estonia_2022$Booster / population_estonia) * 100000

# Variant processing data 
max_expected_week_2022 <- max(data_Variant_Estonia_2022$week_number)
missing_weeks_2022 <- setdiff(1:max_expected_week_2022, data_Variant_Estonia_2022$week_number)

if (length(missing_weeks_2022) > 0) {
  if (identical(missing_weeks_2022, 1:length(missing_weeks_2022))) {
    for (week in missing_weeks_2022) {
      data_Variant_Estonia_2022[data_Variant_Estonia_2022$week_number == week, ] <- data_Variant_Estonia_2022[data_Variant_Estonia_2022$week_number == max(data_Variant_Estonia_2022$week_number[data_Variant_Estonia_2022$week_number < week]), ]
    }
  } else {
    existing_weeks_2022 <- intersect(1:max_expected_week_2022, data_Variant_Estonia_2022$week_number)
    missing_between_2022 <- setdiff(existing_weeks_2022 + 1, data_Variant_Estonia_2022$week_number)
    for (week in missing_between_2022) {
      before <- data_Variant_Estonia_2022[data_Variant_Estonia_2022$week_number == max(data_Variant_Estonia_2022$week_number[data_Variant_Estonia_2022$week_number < week]), ]
      after <- data_Variant_Estonia_2022[data_Variant_Estonia_2022$week_number == min(data_Variant_Estonia_2022$week_number[data_Variant_Estonia_2022$week_number > week]), ]
      data_Variant_Estonia_2022 <- rbind(data_Variant_Estonia_2022, colMeans(rbind(before, after)))
    }
  }
}

```

# FINAL SUMMARY  

# SPAIN 2020

```{r setup, include=FALSE}
# SPAIN HOSPITAL DEATH
print(db_Spain_2020)
summary(db_Spain_2020)
missing_percentage_Spain_2020 <- db_Spain_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Spain_2020)

# SPAIN VACCINE 
print(db_vaccine_Spain_2020)
summary(db_vaccine_Spain_2020)
missing_percentage_vaccine_Spain_2020 <- db_vaccine_Spain_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Spain_2020)

# SPAIN VARIANTS
print(data_Variant_Spain_2020)
summary(data_Variant_Spain_2020)
missing_percentage_variant_Spain_2020 <- data_Variant_Spain_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Spain_2020)

# SPAIN STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_spain_2020)
missing_percentage_stringency_Spain_2020 <- Governement_stringecy_index_oxford_spain_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Spain_2020)

# SPAIN CONTAINMENT INDEX
summary(Containement_health_index_oxford_spain_2020)
missing_percentage_containment_Spain_2020 <- Containement_health_index_oxford_spain_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Spain_2020)
```

#SPAIN 2021
```{r setup, include=FALSE}
# SPAIN HOSPITAL DEATH
print(db_Spain_2021)
summary(db_Spain_2021)
missing_percentage_Spain_2021 <- db_Spain_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Spain_2021)

# SPAIN VACCINE 
print(db_vaccine_Spain_2021)
summary(db_vaccine_Spain_2021)
missing_percentage_vaccine_Spain_2021 <- db_vaccine_Spain_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Spain_2021)

# SPAIN VARIANTS
print(data_Variant_Spain_2021)
summary(data_Variant_Spain_2021)
missing_percentage_variant_Spain_2021 <- data_Variant_Spain_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Spain_2021)

# SPAIN STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_spain_2021)
missing_percentage_stringency_Spain_2021 <- Governement_stringecy_index_oxford_spain_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Spain_2021)

# SPAIN CONTAINMENT INDEX
summary(Containement_health_index_oxford_spain_2021)
missing_percentage_containment_Spain_2021 <- Containement_health_index_oxford_spain_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Spain_2021)
```

# SPAIN 2022
```{r setup, include=FALSE}
# SPAIN HOSPITAL DEATH
print(db_Spain_2022)
summary(db_Spain_2022)
missing_percentage_Spain_2022 <- db_Spain_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Spain_2022)

# SPAIN VACCINE 
print(db_vaccine_Spain_2022)
summary(db_vaccine_Spain_2022)
missing_percentage_vaccine_Spain_2022 <- db_vaccine_Spain_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Spain_2022)

# SPAIN VARIANTS
print(data_Variant_Spain_2022)
summary(data_Variant_Spain_2022)
missing_percentage_variant_Spain_2022 <- data_Variant_Spain_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Spain_2022)

# SPAIN STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_spain_2022)
missing_percentage_stringency_Spain_2022 <- Governement_stringecy_index_oxford_spain_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Spain_2022)

# SPAIN CONTAINMENT INDEX
summary(Containement_health_index_oxford_spain_2022)
missing_percentage_containment_Spain_2022 <- Containement_health_index_oxford_spain_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Spain_2022)
```


# FRANCE 2020
```{r setup, include=FALSE}
# FRANCE HOSPITAL DEATH
print(db_France_2020)
summary(db_France_2020)
missing_percentage_France_2020 <- db_France_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_France_2020)

# FRANCE VACCINE 
print(db_vaccine_France_2020)
summary(db_vaccine_France_2020)
missing_percentage_vaccine_France_2020 <- db_vaccine_France_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_France_2020)

# FRANCE VARIANTS
print(data_Variant_France_2020)
summary(data_Variant_France_2020)
missing_percentage_variant_France_2020 <- data_Variant_France_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_France_2020)

# FRANCE STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_france_2020)
missing_percentage_stringency_France_2020 <- Governement_stringecy_index_oxford_france_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_France_2020)

# FRANCE CONTAINMENT INDEX
summary(Containement_health_index_oxford_france_2020)
missing_percentage_containment_France_2020 <- Containement_health_index_oxford_france_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_France_2020)

```


# FRANCE 2021
```{r setup, include=FALSE}
# FRANCE HOSPITAL DEATH
print(db_France_2021)
summary(db_France_2021)
missing_percentage_France_2021 <- db_France_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_France_2021)

# FRANCE VACCINE 
print(db_vaccine_France_2021)
summary(db_vaccine_France_2021)
missing_percentage_vaccine_France_2021 <- db_vaccine_France_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_France_2021)

# FRANCE VARIANTS
print(data_Variant_France_2021)
summary(data_Variant_France_2021)
missing_percentage_variant_France_2021 <- data_Variant_France_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_France_2021)

# FRANCE STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_france_2021)
missing_percentage_stringency_France_2021 <- Governement_stringecy_index_oxford_france_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_France_2021)

# FRANCE CONTAINMENT INDEX
summary(Containement_health_index_oxford_france_2021)
missing_percentage_containment_France_2021 <- Containement_health_index_oxford_france_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_France_2021)
```


# FRANCE 2022

```{r setup, include=FALSE}
# FRANCE HOSPITAL DEATH
print(db_France_2022)
summary(db_France_2022)
missing_percentage_France_2022 <- db_France_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_France_2022)

# FRANCE VACCINE 
print(db_vaccine_France_2022)
summary(db_vaccine_France_2022)
missing_percentage_vaccine_France_2022 <- db_vaccine_France_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_France_2022)

# FRANCE VARIANTS
print(data_Variant_France_2022)
summary(data_Variant_France_2022)
missing_percentage_variant_France_2022 <- data_Variant_France_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_France_2022)

# FRANCE STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_france_2022)
missing_percentage_stringency_France_2022 <- Governement_stringecy_index_oxford_france_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_France_2022)

# FRANCE CONTAINMENT INDEX
summary(Containement_health_index_oxford_france_2022)
missing_percentage_containment_France_2022 <- Containement_health_index_oxford_france_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_France_2022)

```


# NETHERLANDS 2020
```{r setup, include=FALSE}
# NETHERLANDS HOSPITAL DEATH
print(db_Netherlands_2020)
summary(db_Netherlands_2020)
missing_percentage_Netherlands_2020 <- db_Netherlands_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Netherlands_2020)

# NETHERLANDS VACCINE 
print(db_vaccine_Netherlands_2020)
summary(db_vaccine_Netherlands_2020)
missing_percentage_vaccine_Netherlands_2020 <- db_vaccine_Netherlands_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Netherlands_2020)

# NETHERLANDS VARIANTS
print(data_Variant_Netherlands_2020)
summary(data_Variant_Netherlands_2020)
missing_percentage_variant_Netherlands_2020 <- data_Variant_Netherlands_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Netherlands_2020)

# NETHERLANDS STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_netherlands_2020)
missing_percentage_stringency_Netherlands_2020 <- Governement_stringecy_index_oxford_netherlands_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Netherlands_2020)

# NETHERLANDS CONTAINMENT INDEX
summary(Containement_health_index_oxford_netherlands_2020)
missing_percentage_containment_Netherlands_2020 <- Containement_health_index_oxford_netherlands_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Netherlands_2020)

```


# NETHERLANDS 2021
```{r setup, include=FALSE}
# NETHERLANDS HOSPITAL DEATH
print(db_Netherlands_2021)
summary(db_Netherlands_2021)
missing_percentage_Netherlands_2021 <- db_Netherlands_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Netherlands_2021)

# NETHERLANDS VACCINE 
print(db_vaccine_Netherlands_2021)
summary(db_vaccine_Netherlands_2021)
missing_percentage_vaccine_Netherlands_2021 <- db_vaccine_Netherlands_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Netherlands_2021)

# NETHERLANDS VARIANTS
print(data_Variant_Netherlands_2021)
summary(data_Variant_Netherlands_2021)
missing_percentage_variant_Netherlands_2021 <- data_Variant_Netherlands_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Netherlands_2021)

# NETHERLANDS STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_netherlands_2021)
missing_percentage_stringency_Netherlands_2021 <- Governement_stringecy_index_oxford_netherlands_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Netherlands_2021)

# NETHERLANDS CONTAINMENT INDEX
summary(Containement_health_index_oxford_netherlands_2021)
missing_percentage_containment_Netherlands_2021 <- Containement_health_index_oxford_netherlands_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Netherlands_2021)

```


# NETHERLANDS 2022
```{r setup, include=FALSE}
# NETHERLANDS HOSPITAL DEATH
print(db_Netherlands_2022)
summary(db_Netherlands_2022)
missing_percentage_Netherlands_2022 <- db_Netherlands_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Netherlands_2022)

# NETHERLANDS VACCINE 
print(db_vaccine_Netherlands_2022)
summary(db_vaccine_Netherlands_2022)
missing_percentage_vaccine_Netherlands_2022 <- db_vaccine_Netherlands_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Netherlands_2022)

# NETHERLANDS VARIANTS
print(data_Variant_Netherlands_2022)
summary(data_Variant_Netherlands_2022)
missing_percentage_variant_Netherlands_2022 <- data_Variant_Netherlands_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Netherlands_2022)

# NETHERLANDS STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_Netherlands_2022)
missing_percentage_stringency_Netherlands_2022 <- Governement_stringecy_index_oxford_Netherlands_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Netherlands_2022)

# NETHERLANDS CONTAINMENT INDEX
summary(Containement_health_index_oxford_Netherlands_2022)
missing_percentage_containment_Netherlands_2022 <- Containement_health_index_oxford_Netherlands_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Netherlands_2022)
```

# SLOVENIA 2020
```{r setup, include=FALSE}
 # SLOVENIA HOSPITAL DEATH
print(db_Slovenia_2020)
summary(db_Slovenia_2020)
missing_percentage_Slovenia_2020 <- db_Slovenia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Slovenia_2020)

# SLOVENIA VACCINE 
print(db_vaccine_Slovenia_2020)
summary(db_vaccine_Slovenia_2020)
missing_percentage_vaccine_Slovenia_2020 <- db_vaccine_Slovenia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Slovenia_2020)

# SLOVENIA VARIANTS
print(data_Variant_Slovenia_2020)
summary(data_Variant_Slovenia_2020)
missing_percentage_variant_Slovenia_2020 <- data_Variant_Slovenia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Slovenia_2020)

# SLOVENIA STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_slovenia_2020)
missing_percentage_stringency_Slovenia_2020 <- Governement_stringecy_index_oxford_slovenia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Slovenia_2020)

# SLOVENIA CONTAINMENT INDEX
summary(Containement_health_index_oxford_slovenia_2020)
missing_percentage_containment_Slovenia_2020 <- Containement_health_index_oxford_slovenia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Slovenia_2020)
```

# SLOVENIA 2021

```{r setup, include=FALSE}
# SLOVENIA HOSPITAL DEATH
print(db_Slovenia_2021)
summary(db_Slovenia_2021)
missing_percentage_Slovenia_2021 <- db_Slovenia_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Slovenia_2021)

# SLOVENIA VACCINE 
print(db_vaccine_Slovenia_2021)
summary(db_vaccine_Slovenia_2021)
missing_percentage_vaccine_Slovenia_2021 <- db_vaccine_Slovenia_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Slovenia_2021)

# SLOVENIA VARIANTS
print(data_Variant_Slovenia_2021)
summary(data_Variant_Slovenia_2021)
missing_percentage_variant_Slovenia_2021 <- data_Variant_Slovenia_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Slovenia_2021)

# SLOVENIA STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_slovenia_2021)
missing_percentage_stringency_Slovenia_2021 <- Governement_stringecy_index_oxford_slovenia_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Slovenia_2021)

# SLOVENIA CONTAINMENT INDEX
summary(Containement_health_index_oxford_slovenia_2021)
missing_percentage_containment_Slovenia_2021 <- Containement_health_index_oxford_slovenia_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Slovenia_2021)
```

# SLOVENIA 2022

```{r setup, include=FALSE}
# SLOVENIA HOSPITAL DEATH
print(db_Slovenia_2022)
summary(db_Slovenia_2022)
missing_percentage_Slovenia_2022 <- db_Slovenia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Slovenia_2022)

# SLOVENIA VACCINE 
print(db_vaccine_Slovenia_2022)
summary(db_vaccine_Slovenia_2022)
missing_percentage_vaccine_Slovenia_2022 <- db_vaccine_Slovenia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Slovenia_2022)

# SLOVENIA VARIANTS
print(data_Variant_Slovenia_2022)
summary(data_Variant_Slovenia_2022)
missing_percentage_variant_Slovenia_2022 <- data_Variant_Slovenia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Slovenia_2022)

# SLOVENIA STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_slovenia_2022)
missing_percentage_stringency_Slovenia_2022 <- Governement_stringecy_index_oxford_slovenia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Slovenia_2022)

# SLOVENIA CONTAINMENT INDEX
summary(Containement_health_index_oxford_slovenia_2022)
missing_percentage_containment_Slovenia_2022 <- Containement_health_index_oxford_slovenia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Slovenia_2022)
```

# GREECE 2020
```{r setup, include=FALSE}
# GREECE HOSPITAL DEATH
print(db_Greece_2020)
summary(db_Greece_2020)
missing_percentage_Greece_2020 <- db_Greece_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Greece_2020)

# GREECE VACCINE 
print(db_vaccine_Greece_2020)
summary(db_vaccine_Greece_2020)
missing_percentage_vaccine_Greece_2020 <- db_vaccine_Greece_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Greece_2020)

# GREECE VARIANTS
print(data_Variant_Greece_2020)
summary(data_Variant_Greece_2020)
missing_percentage_variant_Greece_2020 <- data_Variant_Greece_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Greece_2020)

# GREECE STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_greece_2020)
missing_percentage_stringency_Greece_2020 <- Governement_stringecy_index_oxford_greece_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Greece_2020)

# GREECE CONTAINMENT INDEX
summary(Containement_health_index_oxford_greece_2020)
missing_percentage_containment_Greece_2020 <- Containement_health_index_oxford_greece_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Greece_2020)

```


# GREECE 2021
```{r setup, include=FALSE}
# GREECE HOSPITAL DEATH
print(db_Greece_2021)
summary(db_Greece_2021)
missing_percentage_Greece_2021 <- db_Greece_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Greece_2021)

# GREECE VACCINE 
print(db_vaccine_Greece_2021)
summary(db_vaccine_Greece_2021)
missing_percentage_vaccine_Greece_2021 <- db_vaccine_Greece_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Greece_2021)

# GREECE VARIANTS
print(data_Variant_Greece_2021)
summary(data_Variant_Greece_2021)
missing_percentage_variant_Greece_2021 <- data_Variant_Greece_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Greece_2021)

# GREECE STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_greece_2021)
missing_percentage_stringency_Greece_2021 <- Governement_stringecy_index_oxford_greece_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Greece_2021)

# GREECE CONTAINMENT INDEX
summary(Containement_health_index_oxford_greece_2021)
missing_percentage_containment_Greece_2021 <- Containement_health_index_oxford_greece_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Greece_2021)
```


# GREECE 2022
```{r setup, include=FALSE}
# GREECE HOSPITAL DEATH
print(db_Greece_2022)
summary(db_Greece_2022)
missing_percentage_Greece_2022 <- db_Greece_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Greece_2022)

# GREECE VACCINE 
print(db_vaccine_Greece_2022)
summary(db_vaccine_Greece_2022)
missing_percentage_vaccine_Greece_2022 <- db_vaccine_Greece_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Greece_2022)

# GREECE VARIANTS
print(data_Variant_Greece_2022)
summary(data_Variant_Greece_2022)
missing_percentage_variant_Greece_2022 <- data_Variant_Greece_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Greece_2022)

# GREECE STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_greece_2022)
missing_percentage_stringency_Greece_2022 <- Governement_stringecy_index_oxford_greece_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Greece_2022)

# GREECE CONTAINMENT INDEX
summary(Containement_health_index_oxford_greece_2022)
missing_percentage_containment_Greece_2022 <- Containement_health_index_oxford_greece_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Greece_2022)
```

# IRELAND 2020
```{r setup, include=FALSE}
# IRELAND HOSPITAL DEATH
print(db_Ireland_2020)
summary(db_Ireland_2020)
missing_percentage_Ireland_2020 <- db_Ireland_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Ireland_2020)

# IRELAND VACCINE 
print(db_vaccine_Ireland_2020)
summary(db_vaccine_Ireland_2020)
missing_percentage_vaccine_Ireland_2020 <- db_vaccine_Ireland_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Ireland_2020)

# IRELAND VARIANTS
print(data_Variant_Ireland_2020)
summary(data_Variant_Ireland_2020)
missing_percentage_variant_Ireland_2020 <- data_Variant_Ireland_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Ireland_2020)

# IRELAND STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_ireland_2020)
missing_percentage_stringency_Ireland_2020 <- Governement_stringecy_index_oxford_ireland_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Ireland_2020)

# IRELAND CONTAINMENT INDEX
summary(Containement_health_index_oxford_ireland_2020)
missing_percentage_containment_Ireland_2020 <- Containement_health_index_oxford_ireland_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Ireland_2020)
```


# IRELAND 2021
```{r setup, include=FALSE}
# IRELAND HOSPITAL DEATH
print(db_Ireland_2021)
summary(db_Ireland_2021)
missing_percentage_Ireland_2021 <- db_Ireland_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Ireland_2021)

# IRELAND VACCINE 
print(db_vaccine_Ireland_2021)
summary(db_vaccine_Ireland_2021)
missing_percentage_vaccine_Ireland_2021 <- db_vaccine_Ireland_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Ireland_2021)

# IRELAND VARIANTS
print(data_Variant_Ireland_2021)
summary(data_Variant_Ireland_2021)
missing_percentage_variant_Ireland_2021 <- data_Variant_Ireland_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Ireland_2021)

# IRELAND STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_ireland_2021)
missing_percentage_stringency_Ireland_2021 <- Governement_stringecy_index_oxford_ireland_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Ireland_2021)

# IRELAND CONTAINMENT INDEX
summary(Containement_health_index_oxford_ireland_2021)
missing_percentage_containment_Ireland_2021 <- Containement_health_index_oxford_ireland_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Ireland_2021)
```


# IRELAND 2022
```{r setup, include=FALSE}
# IRELAND HOSPITAL DEATH
print(db_Ireland_2022)
summary(db_Ireland_2022)
missing_percentage_Ireland_2022 <- db_Ireland_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Ireland_2022)

# IRELAND VACCINE 
print(db_vaccine_Ireland_2022)
summary(db_vaccine_Ireland_2022)
missing_percentage_vaccine_Ireland_2022 <- db_vaccine_Ireland_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Ireland_2022)

# IRELAND VARIANTS
print(data_Variant_Ireland_2022)
summary(data_Variant_Ireland_2022)
missing_percentage_variant_Ireland_2022 <- data_Variant_Ireland_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Ireland_2022)

# IRELAND STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_ireland_2022)
missing_percentage_stringency_Ireland_2022 <- Governement_stringecy_index_oxford_ireland_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Ireland_2022)

# IRELAND CONTAINMENT INDEX
summary(Containement_health_index_oxford_ireland_2022)
missing_percentage_containment_Ireland_2022 <- Containement_health_index_oxford_ireland_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Ireland_2022)
```

# CYPRUS 2020
```{r setup, include=FALSE}
# CYPRUS HOSPITAL DEATH
print(db_Cyprus_2020)
summary(db_Cyprus_2020)
missing_percentage_Cyprus_2020 <- db_Cyprus_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Cyprus_2020)

# CYPRUS VACCINE 
print(db_vaccine_Cyprus_2020)
summary(db_vaccine_Cyprus_2020)
missing_percentage_vaccine_Cyprus_2020 <- db_vaccine_Cyprus_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Cyprus_2020)

# CYPRUS VARIANTS
print(data_Variant_Cyprus_2020)
summary(data_Variant_Cyprus_2020)
missing_percentage_variant_Cyprus_2020 <- data_Variant_Cyprus_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Cyprus_2020)

# CYPRUS STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_cyprus_2020)
missing_percentage_stringency_Cyprus_2020 <- Governement_stringecy_index_oxford_cyprus_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Cyprus_2020)

# CYPRUS CONTAINMENT INDEX
summary(Containement_health_index_oxford_cyprus_2020)
missing_percentage_containment_Cyprus_2020 <- Containement_health_index_oxford_cyprus_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Cyprus_2020)
```


# CYPRUS 2021
```{r setup, include=FALSE}
# CYPRUS HOSPITAL DEATH
print(db_Cyprus_2021)
summary(db_Cyprus_2021)
missing_percentage_Cyprus_2021 <- db_Cyprus_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Cyprus_2021)

# CYPRUS VACCINE 
print(db_vaccine_Cyprus_2021)
summary(db_vaccine_Cyprus_2021)
missing_percentage_vaccine_Cyprus_2021 <- db_vaccine_Cyprus_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Cyprus_2021)

# CYPRUS VARIANTS
print(data_Variant_Cyprus_2021)
summary(data_Variant_Cyprus_2021)
missing_percentage_variant_Cyprus_2021 <- data_Variant_Cyprus_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Cyprus_2021)

# CYPRUS STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_cyprus_2021)
missing_percentage_stringency_Cyprus_2021 <- Governement_stringecy_index_oxford_cyprus_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Cyprus_2021)

# CYPRUS CONTAINMENT INDEX
summary(Containement_health_index_oxford_cyprus_2021)
missing_percentage_containment_Cyprus_2021 <- Containement_health_index_oxford_cyprus_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Cyprus_2021)
```


# CYPRUS 2022
```{r setup, include=FALSE}
# CYPRUS HOSPITAL DEATH
print(db_Cyprus_2022)
summary(db_Cyprus_2022)
missing_percentage_Cyprus_2022 <- db_Cyprus_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Cyprus_2022)

# CYPRUS VACCINE 
print(db_vaccine_Cyprus_2022)
summary(db_vaccine_Cyprus_2022)
missing_percentage_vaccine_Cyprus_2022 <- db_vaccine_Cyprus_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Cyprus_2022)

# CYPRUS VARIANTS
print(data_Variant_Cyprus_2022)
summary(data_Variant_Cyprus_2022)
missing_percentage_variant_Cyprus_2022 <- data_Variant_Cyprus_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Cyprus_2022)

# CYPRUS STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_cyprus_2022)
missing_percentage_stringency_Cyprus_2022 <- Governement_stringecy_index_oxford_cyprus_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Cyprus_2022)

# CYPRUS CONTAINMENT INDEX
summary(Containement_health_index_oxford_cyprus_2022)
missing_percentage_containment_Cyprus_2022 <- Containement_health_index_oxford_cyprus_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Cyprus_2022)
```


# ESTONIA 2020
```{r setup, include=FALSE}
# ESTONIA HOSPITAL DEATH
print(db_Estonia_2020)
summary(db_Estonia_2020)
missing_percentage_Estonia_2020 <- db_Estonia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Estonia_2020)

# ESTONIA VACCINE 
print(db_vaccine_Estonia_2020)
summary(db_vaccine_Estonia_2020)
missing_percentage_vaccine_Estonia_2020 <- db_vaccine_Estonia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Estonia_2020)

# ESTONIA VARIANTS
print(data_Variant_Estonia_2020)
summary(data_Variant_Estonia_2020)
missing_percentage_variant_Estonia_2020 <- data_Variant_Estonia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Estonia_2020)

# ESTONIA STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_estonia_2020)
missing_percentage_stringency_Estonia_2020 <- Governement_stringecy_index_oxford_estonia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Estonia_2020)

# ESTONIA CONTAINMENT INDEX
summary(Containement_health_index_oxford_estonia_2020)
missing_percentage_containment_Estonia_2020 <- Containement_health_index_oxford_estonia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Estonia_2020)

```


# ESTONIA 2021
```{r setup, include=FALSE}
# ESTONIA HOSPITAL DEATH
print(db_Estonia_2021)
summary(db_Estonia_2021)
missing_percentage_Estonia_2021 <- db_Estonia_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Estonia_2021)

# ESTONIA VACCINE 
print(db_vaccine_Estonia_2021)
summary(db_vaccine_Estonia_2021)
missing_percentage_vaccine_Estonia_2021 <- db_vaccine_Estonia_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Estonia_2021)

# ESTONIA VARIANTS
print(data_Variant_Estonia_2021)
summary(data_Variant_Estonia_2021)
missing_percentage_variant_Estonia_2021 <- data_Variant_Estonia_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Estonia_2021)

# ESTONIA STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_estonia_2021)
missing_percentage_stringency_Estonia_2021 <- Governement_stringecy_index_oxford_estonia_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Estonia_2021)

# ESTONIA CONTAINMENT INDEX
summary(Containement_health_index_oxford_estonia_2021)
missing_percentage_containment_Estonia_2021 <- Containement_health_index_oxford_estonia_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Estonia_2021)
```

# ESTONIA 2022
```{r setup, include=FALSE}
# ESTONIA HOSPITAL DEATH
print(db_Estonia_2022)
summary(db_Estonia_2022)
missing_percentage_Estonia_2022 <- db_Estonia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Estonia_2022)

# ESTONIA VACCINE 
print(db_vaccine_Estonia_2022)
summary(db_vaccine_Estonia_2022)
missing_percentage_vaccine_Estonia_2022 <- db_vaccine_Estonia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Estonia_2022)

# ESTONIA VARIANTS
print(data_Variant_Estonia_2022)
summary(data_Variant_Estonia_2022)
missing_percentage_variant_Estonia_2022 <- data_Variant_Estonia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Estonia_2022)

# ESTONIA STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_estonia_2022)
missing_percentage_stringency_Estonia_2022 <- Governement_stringecy_index_oxford_estonia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Estonia_2022)

# ESTONIA CONTAINMENT INDEX
summary(Containement_health_index_oxford_estonia_2022)
missing_percentage_containment_Estonia_2022 <- Containement_health_index_oxford_estonia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Estonia_2022)
```


# LATVIA 2020
```{r setup, include=FALSE}
# LATVIA HOSPITAL DEATH
print(db_Latvia_2020)
summary(db_Latvia_2020)
missing_percentage_Latvia_2020 <- db_Latvia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Latvia_2020)

# LATVIA VACCINE 
print(db_vaccine_Latvia_2020)
summary(db_vaccine_Latvia_2020)
missing_percentage_vaccine_Latvia_2020 <- db_vaccine_Latvia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Latvia_2020)

# LATVIA VARIANTS
print(data_Variant_Latvia_2020)
summary(data_Variant_Latvia_2020)
missing_percentage_variant_Latvia_2020 <- data_Variant_Latvia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Latvia_2020)

# LATVIA STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_latvia_2020)
missing_percentage_stringency_Latvia_2020 <- Governement_stringecy_index_oxford_latvia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Latvia_2020)

# LATVIA CONTAINMENT INDEX
summary(Containement_health_index_oxford_latvia_2020)
missing_percentage_containment_Latvia_2020 <- Containement_health_index_oxford_latvia_2020 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Latvia_2020)
```


# LATVIA 2021
```{r setup, include=FALSE}
# LATVIA HOSPITAL DEATH
print(db_Latvia_2021)
summary(db_Latvia_2021)
missing_percentage_Latvia_2021 <- db_Latvia_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Latvia_2021)

# LATVIA VACCINE 
print(db_vaccine_Latvia_2021)
summary(db_vaccine_Latvia_2021)
missing_percentage_vaccine_Latvia_2021 <- db_vaccine_Latvia_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Latvia_2021)

# LATVIA VARIANTS
print(data_Variant_Latvia_2021)
summary(data_Variant_Latvia_2021)
missing_percentage_variant_Latvia_2021 <- data_Variant_Latvia_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Latvia_2021)

# LATVIA STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_latvia_2021)
missing_percentage_stringency_Latvia_2021 <- Governement_stringecy_index_oxford_latvia_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Latvia_2021)

# LATVIA CONTAINMENT INDEX
summary(Containement_health_index_oxford_latvia_2021)
missing_percentage_containment_Latvia_2021 <- Containement_health_index_oxford_latvia_2021 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Latvia_2021)
```


# LATVIA 2022
```{r setup, include=FALSE}
# LATVIA HOSPITAL DEATH
print(db_Latvia_2022)
summary(db_Latvia_2022)
missing_percentage_Latvia_2022 <- db_Latvia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_Latvia_2022)

# LATVIA VACCINE 
print(db_vaccine_Latvia_2022)
summary(db_vaccine_Latvia_2022)
missing_percentage_vaccine_Latvia_2022 <- db_vaccine_Latvia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_vaccine_Latvia_2022)

# LATVIA VARIANTS
print(data_Variant_Latvia_2022)
summary(data_Variant_Latvia_2022)
missing_percentage_variant_Latvia_2022 <- data_Variant_Latvia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_variant_Latvia_2022)

# LATVIA STRINGENCY INDEX
summary(Governement_stringecy_index_oxford_latvia_2022)
missing_percentage_stringency_Latvia_2022 <- Governement_stringecy_index_oxford_latvia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_stringency_Latvia_2022)

# LATVIA CONTAINMENT INDEX
summary(Containement_health_index_oxford_latvia_2022)
missing_percentage_containment_Latvia_2022 <- Containement_health_index_oxford_latvia_2022 %>%
  summarize(across(everything(), ~sum(is.na(.)) / n() * 100))
print(missing_percentage_containment_Latvia_2022)
```

